<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>–ß–∏—Ç–∞–ª–∫–∞ ‚Äî CRAWL.STORIES</title>
  
  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-firestore-compat.js"></script>
  
  <script>
    // Firebase –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
    const firebaseConfig = {
      apiKey: "AIzaSyANC4K0-xI-9SvrpoiOp4v-N2XLvCQCALg",
      authDomain: "crawl-stories.firebaseapp.com",
      projectId: "crawl-stories",
      storageBucket: "crawl-stories.firebasestorage.app",
      messagingSenderId: "886479757650",
      appId: "1:886479757650:web:194ad1dd2d02c959bdda8b",
      measurementId: "G-SGC2HF0455"
    };
    
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
  </script>
  
  <style>
    :root {
      --bg-primary: #0e1621;
      --bg-secondary: #17212b;
      --bg-chat: #17212b;
      --bg-message-user: #2b5278;
      --bg-message-other: #182533;
      --bg-message-system: #78582b;
      --bg-message-thought: #2b5278;
      --text-primary: #ffffff;
      --text-secondary: #7f8c8d;
      --text-message: #e1e1e1;
      --text-time: #7f8c8d;
      --accent-primary: #FFE81F;
      --accent-secondary: #5288c1;
      --border-light: rgba(255,255,255,0.1);
      --shadow-light: 0 2px 5px rgba(0,0,0,0.3);
      --font-mono: "Courier New", monospace;
      --font-system: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    html, body {
      height: 100%;
      background: var(--bg-primary);
      color: var(--text-primary);
      font-family: var(--font-system);
      -webkit-font-smoothing: antialiased;
      overflow: hidden;
    }

    /* CHAT LAYOUT */
    .chat-container {
      height: 100vh;
      display: flex;
      flex-direction: column;
      background: var(--bg-chat);
      transition: all 0.3s ease;
    }

    .chat-container.fullscreen {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      z-index: 1000;
    }

    /* CHAT HEADER */
    .chat-header {
      background: var(--bg-secondary);
      border-bottom: 1px solid var(--border-light);
      padding: 15px 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      backdrop-filter: blur(10px);
      position: sticky;
      top: 0;
      z-index: 100;
      flex-shrink: 0;
    }

    .header-left { 
      display: flex; 
      align-items: center; 
      gap: 15px; 
      flex: 1;
    }

    .back-btn {
      background: none;
      border: none;
      color: var(--accent-secondary);
      font-size: 20px;
      cursor: pointer;
      padding: 5px;
      transition: transform 0.2s;
    }

    .back-btn:hover {
      transform: scale(1.1);
    }

    .chat-info {
      min-width: 0;
      flex: 1;
    }

    .chat-info h1 {
      font-size: 16px;
      color: var(--text-primary);
      margin-bottom: 2px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .chapter-status {
      font-size: 13px;
      color: var(--text-secondary);
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .status-available { color: #4caf50; }
    .status-soon { color: #ff9800; }

    .header-right { 
      display: flex; 
      gap: 10px; 
      flex-shrink: 0;
    }

    .header-btn {
      background: none;
      border: none;
      color: var(--text-secondary);
      font-size: 18px;
      cursor: pointer;
      padding: 5px;
      transition: all 0.3s;
      border-radius: 5px;
    }

    .header-btn:hover { 
      color: var(--accent-secondary); 
      background: rgba(255,255,255,0.05);
    }

    .header-btn.active { 
      color: var(--accent-primary); 
    }

    /* CHAT MESSAGES */
    .chat-messages {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      scroll-behavior: smooth;
    }

    .chat-messages::-webkit-scrollbar { 
      width: 6px; 
    }

    .chat-messages::-webkit-scrollbar-track { 
      background: transparent; 
    }

    .chat-messages::-webkit-scrollbar-thumb { 
      background: var(--border-light); 
      border-radius: 3px; 
    }

    .chat-messages::-webkit-scrollbar-thumb:hover { 
      background: var(--text-secondary); 
    }

    /* MESSAGE BUBBLES */
    .message { 
      max-width: 70%; 
      display: flex; 
      flex-direction: column; 
      animation: messageAppear 0.3s ease-out; 
    }

    .message.user { align-self: flex-end; }
    .message.other { align-self: flex-start; }
    .message.system { 
      align-self: center; 
      max-width: 90%; 
    }
    .message.thought { align-self: flex-end; }

    .message-bubble {
      padding: 12px 16px;
      border-radius: 18px;
      position: relative;
      word-wrap: break-word;
      line-height: 1.4;
      transition: transform 0.2s;
    }

    .message.user .message-bubble { 
      background: var(--bg-message-user); 
      border-bottom-right-radius: 6px; 
      color: var(--text-message); 
    }

    .message.other .message-bubble { 
      background: var(--bg-message-other); 
      border-bottom-left-radius: 6px; 
      color: var(--text-message); 
    }

    .message.system .message-bubble { 
      background: var(--bg-message-system); 
      border-radius: 12px; 
      color: var(--text-message); 
      text-align: center; 
      font-style: italic; 
    }

    .message.thought .message-bubble { 
      background: var(--bg-message-thought); 
      border: 1px dashed var(--accent-secondary); 
      border-radius: 18px; 
      color: var(--text-message); 
      font-style: italic; 
    }

    .message.new .message-bubble {
      animation: newMessage 0.5s ease-out;
    }

    .message-content { 
      font-size: 14px; 
      line-height: 1.4; 
    }

    .message-time { 
      font-size: 11px; 
      color: var(--text-time); 
      margin-top: 4px; 
      text-align: right; 
      opacity: 0.7; 
    }

    .message.system .message-time { 
      text-align: center; 
    }

    .message-avatar {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: var(--accent-secondary);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      font-weight: bold;
      color: white;
      margin-right: 8px;
      flex-shrink: 0;
      background-size: cover;
      background-position: center;
    }

    .message-with-avatar { 
      display: flex; 
      align-items: flex-end; 
    }

    .message.user .message-with-avatar { 
      flex-direction: row-reverse; 
    }

    .message.user .message-avatar { 
      margin-right: 0; 
      margin-left: 8px; 
    }

    /* TYPING INDICATOR */
    .typing-indicator {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 12px 16px;
      background: var(--bg-message-other);
      border-radius: 18px;
      border-bottom-left-radius: 6px;
      max-width: 70px;
      align-self: flex-start;
      margin-bottom: 10px;
    }

    .typing-dot { 
      width: 6px; 
      height: 6px; 
      background: var(--text-secondary); 
      border-radius: 50%; 
      animation: typing 1.4s infinite ease-in-out; 
    }

    .typing-dot:nth-child(1) { animation-delay: -0.32s; }
    .typing-dot:nth-child(2) { animation-delay: -0.16s; }

    /* PROGRESS AND CONTROLS */
    .progress-section {
      background: var(--bg-secondary);
      border-top: 1px solid var(--border-light);
      padding: 15px 20px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      flex-shrink: 0;
    }

    .progress-info {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 12px;
      color: var(--text-secondary);
    }

    .progress-bar {
      height: 4px;
      background: var(--border-light);
      border-radius: 2px;
      overflow: hidden;
      position: relative;
    }

    .progress-fill {
      height: 100%;
      background: var(--accent-primary);
      border-radius: 2px;
      transition: width 0.3s ease;
      width: 0%;
    }

    .chat-controls {
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
    }

    .control-btn {
      background: none;
      border: none;
      color: var(--text-secondary);
      font-size: 18px;
      cursor: pointer;
      padding: 8px;
      transition: all 0.3s;
      border-radius: 5px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .control-btn:hover { 
      color: var(--accent-secondary); 
      background: rgba(255,255,255,0.05);
    }

    .control-btn.active { 
      color: var(--accent-primary); 
    }

    .control-btn:disabled {
      opacity: 0.3;
      cursor: not-allowed;
    }

    .progress-text {
      font-size: 12px;
      color: var(--text-secondary);
      min-width: 60px;
      text-align: center;
    }

    .jump-controls {
      display: flex;
      gap: 5px;
      margin-left: auto;
    }

    /* CHAPTER NAVIGATION */
    .chapter-nav {
      position: fixed;
      bottom: 100px;
      right: 20px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      z-index: 90;
    }

    .chapter-btn {
      background: var(--bg-secondary);
      border: 1px solid var(--border-light);
      color: var(--text-primary);
      padding: 10px 15px;
      border-radius: 20px;
      cursor: pointer;
      transition: all 0.3s;
      font-size: 12px;
      white-space: nowrap;
    }

    .chapter-btn:hover {
      background: var(--accent-primary);
      color: var(--bg-primary);
    }

    .chapter-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    /* LOADING AND ERROR STATES */
    .loading-state, .error-state {
      display: flex;
      align-items: center;
      justify-content: center;
      height: 100%;
      flex-direction: column;
      gap: 20px;
      color: var(--text-secondary);
      text-align: center;
      padding: 40px;
    }

    .loading-spinner {
      width: 40px;
      height: 40px;
      border: 3px solid var(--border-light);
      border-top: 3px solid var(--accent-primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    .error-state .error-icon {
      font-size: 48px;
      margin-bottom: 20px;
    }

    .retry-btn {
      background: var(--accent-primary);
      color: var(--bg-primary);
      border: none;
      padding: 10px 20px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: bold;
      margin-top: 20px;
    }

    /* ANIMATIONS */
    @keyframes messageAppear { 
      from { 
        opacity: 0; 
        transform: translateY(10px); 
      }
      to { 
        opacity: 1; 
        transform: translateY(0); 
      } 
    }

    @keyframes newMessage {
      0% {
        transform: scale(0.8);
        opacity: 0;
      }
      50% {
        transform: scale(1.05);
      }
      100% {
        transform: scale(1);
        opacity: 1;
      }
    }

    @keyframes typing { 
      0%, 60%, 100% { 
        transform: scale(1); 
        opacity: 0.5; 
      }
      30% { 
        transform: scale(1.2); 
        opacity: 1; 
      } 
    }

    @keyframes spin { 
      0% { transform: rotate(0deg); } 
      100% { transform: rotate(360deg); } 
    }

    /* Theme crossfade helper and notification */
    .theme-fade * { transition: color 400ms ease, background-color 400ms ease, border-color 400ms ease, box-shadow 400ms ease, opacity 400ms ease; }
    #theme-notice { position: fixed; top: 16px; right: 16px; background: rgba(0,0,0,0.7); color: var(--accent-primary); padding: 8px 12px; border-radius: 8px; font-weight: bold; opacity: 0; pointer-events: none; transform: translateY(-8px); transition: opacity 300ms ease, transform 300ms ease; z-index: 10000; }
    #theme-notice.show { opacity: 1; transform: translateY(0); }

    /* RESPONSIVE */
    @media (max-width: 768px) {
      .message { max-width: 85%; }
      .chat-header { padding: 12px 15px; }
      .chat-messages { padding: 15px; }
      .progress-section { padding: 12px 15px; }
      .message-bubble { padding: 10px 14px; }
      
      .header-right {
        gap: 5px;
      }
      
      .chapter-nav {
        bottom: 80px;
        right: 10px;
      }
    }

    @media (max-width: 480px) {
      .chat-controls {
        justify-content: center;
      }
      
      .jump-controls {
        margin-left: 0;
        width: 100%;
        justify-content: center;
        margin-top: 10px;
      }
    }
  </style>
</head>
<body>
  <div class="chat-container" id="chatContainer">
    <!-- CHAT HEADER -->
    <div class="chat-header">
      <div class="header-left">
        <button class="back-btn" id="btnBack">‚Üê</button>
        <div class="chat-info">
          <h1 id="chatTitle">–ó–∞–≥—Ä—É–∑–∫–∞...</h1>
          <div class="chapter-status" id="chapterStatus">
            <span class="status-available">‚óè</span> –ó–∞–≥—Ä—É–∑–∫–∞...
          </div>
        </div>
      </div>
      <div class="header-right">
        <button class="header-btn" id="btnSound" title="–ó–≤—É–∫ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π">üîî</button>
        <button class="header-btn" id="btnFullscreen" title="–ü–æ–ª–Ω–æ—ç–∫—Ä–∞–Ω–Ω—ã–π —Ä–µ–∂–∏–º">‚õ∂</button>
      </div>
    </div>

    <!-- CHAT MESSAGES -->
    <div class="chat-messages" id="chatMessages">
      <div class="loading-state">
        <div class="loading-spinner"></div>
        <div>–ó–∞–≥—Ä—É–∑–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏...</div>
      </div>
    </div>

    <!-- PROGRESS AND CONTROLS -->
    <div class="progress-section">
      <div class="progress-info">
        <span id="progressText">–°–æ–æ–±—â–µ–Ω–∏–µ 0 –∏–∑ 0</span>
        <span id="chapterInfo">–≠–ø–∏–∑–æ–¥ 1</span>
      </div>
      <div class="progress-bar">
        <div class="progress-fill" id="progressFill"></div>
      </div>
      <div class="chat-controls">
        <button class="control-btn" id="btnPlayPause" title="–ü–∞—É–∑–∞/–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å">‚è∏Ô∏è</button>
        <button class="control-btn" id="btnPrev" title="–ü—Ä–µ–¥—ã–¥—É—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ">‚èÆÔ∏è</button>
        <button class="control-btn" id="btnNext" title="–°–ª–µ–¥—É—é—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ">‚è≠Ô∏è</button>
        <button class="control-btn" id="btnSpeed" title="–°–∫–æ—Ä–æ—Å—Ç—å –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è">1x</button>
        
        <div class="jump-controls">
          <button class="control-btn" id="btnJumpStart" title="–ö –Ω–∞—á–∞–ª—É">‚è™</button>
          <button class="control-btn" id="btnJumpEnd" title="–ö –∫–æ–Ω—Ü—É">‚è©</button>
        </div>
      </div>
    </div>

    <!-- CHAPTER NAVIGATION -->
    <div class="chapter-nav" id="chapterNav" style="display: none;">
      <button class="chapter-btn" id="btnPrevChapter">‚Üê –ü—Ä–µ–¥—ã–¥—É—â–∏–π —ç–ø–∏–∑–æ–¥</button>
      <button class="chapter-btn" id="btnNextChapter">–°–ª–µ–¥—É—é—â–∏–π —ç–ø–∏–∑–æ–¥ ‚Üí</button>
    </div>
  </div>

  <script>
    class ChatReader {
      constructor() {
        this.story = null;
        this.chapters = [];
        this.currentChapter = null;
        this.messages = [];
        this.characters = [];
        this.currentMessageIndex = 0;
        this.isPlaying = false;
        this.playSpeed = 1;
        this.autoPlayDelay = 2000;
        this.currentTimeout = null;
        this.soundEnabled = true;
        this.progress = {};
        
        this.init();
      }

      async init() {
        await this.loadStoryData();
        this.setupEventListeners();
        this.loadProgress();
        this.startAutoPlay();
      }

      async loadStoryData() {
        const urlParams = new URLSearchParams(window.location.search);
        const storyId = urlParams.get('story');
        
        if (!storyId) {
          this.showError('–ò—Å—Ç–æ—Ä–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –≤ URL');
          return;
        }

        try {
          // –ó–∞–≥—Ä—É–∂–∞–µ–º –æ—Å–Ω–æ–≤–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∏—Å—Ç–æ—Ä–∏–∏
          const storyDoc = await db.collection('stories').doc(storyId).get();
          if (!storyDoc.exists) {
            this.showError('–ò—Å—Ç–æ—Ä–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö');
            return;
          }

          this.story = { id: storyDoc.id, ...storyDoc.data() };
          document.getElementById('chatTitle').textContent = this.story.title;

            // –ó–∞–≥—Ä—É–∂–∞–µ–º —ç–ø–∏–∑–æ–¥—ã
            const episodesSnapshot = await db.collection('episodes')
              .where('storyId', '==', storyId)
              .orderBy('episodeNumber')
              .get();

            this.chapters = episodesSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

            if (this.chapters.length === 0) {
              this.showError('–í –∏—Å—Ç–æ—Ä–∏–∏ –Ω–µ—Ç —ç–ø–∏–∑–æ–¥–æ–≤');
              return;
            }

            // –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π —É—Ä–æ–≤–Ω—è –∏—Å—Ç–æ—Ä–∏–∏
            const charactersSnapshot = await db.collection('story_characters')
              .where('storyId', '==', storyId)
              .get();

            this.characters = charactersSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–µ—Ä–≤—ã–π —ç–ø–∏–∑–æ–¥
            this.currentChapter = this.chapters[0];
            await this.loadChapterMessages(this.currentChapter.id);

            this.updateChapterInfo();
            this.updateChapterNavigation();

        } catch (error) {
          console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏:', error);
          this.showError('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏—Å—Ç–æ—Ä–∏–∏: ' + error.message);
        }
      }

      async loadChapterMessages(chapterId) {
        try {
          this.showLoading();
          
          // –∑–∞–≥—Ä—É–∂–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è —ç–ø–∏–∑–æ–¥–∞ –∏–∑ –Ω–æ–≤–æ–π –∫–æ–ª–ª–µ–∫—Ü–∏–∏ `episode_messages`
          const messagesSnapshot = await db.collection('episode_messages')
            .where('episodeId', '==', chapterId)
            .orderBy('order')
            .get();
          
          this.messages = messagesSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

          if (this.messages.length === 0) {
            this.showError('–í –≥–ª–∞–≤–µ –Ω–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π');
            return;
          }

          this.currentMessageIndex = 0;
          this.renderMessages();
          this.updateProgress();

        } catch (error) {
          console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π:', error);
          this.showError('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π');
        }
      }

      startAutoPlay() {
        this.isPlaying = true;
        document.getElementById('btnPlayPause').textContent = '‚è∏Ô∏è';
        this.playNextMessage();
      }

      playNextMessage() {
        if (!this.isPlaying || this.currentMessageIndex >= this.messages.length) {
          this.isPlaying = false;
          document.getElementById('btnPlayPause').textContent = '‚ñ∂Ô∏è';
          
          // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —Å–ª–µ–¥—É—é—â–∞—è –≥–ª–∞–≤–∞ (—ç–ø–∏–∑–æ–¥–∞)
          if (this.currentMessageIndex >= this.messages.length) {
            this.handleChapterComplete();
          }
          return;
        }

        const message = this.messages[this.currentMessageIndex];
        this.displayMessage(message);
        this.currentMessageIndex++;

        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å
        this.saveProgress();

        // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å
        this.updateProgress();

        // –°–ª–µ–¥—É—é—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –∑–∞–¥–µ—Ä–∂–∫–æ–π
        const delay = (message.delay || this.autoPlayDelay) / this.playSpeed;
        this.currentTimeout = setTimeout(() => this.playNextMessage(), delay);
      }

      displayMessage(message) {
        const messagesContainer = document.getElementById('chatMessages');
        
        const messageElement = this.createMessageElement(message);
        messagesContainer.appendChild(messageElement);
        
        // –ü–ª–∞–≤–Ω–∞—è –ø—Ä–æ–∫—Ä—É—Ç–∫–∞ –∫ –ø–æ—Å–ª–µ–¥–Ω–µ–º—É —Å–æ–æ–±—â–µ–Ω–∏—é
        messagesContainer.scrollTo({
          top: messagesContainer.scrollHeight,
          behavior: 'smooth'
        });
      }

      createMessageElement(message) {
        const messageDiv = document.createElement('div');
        
        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø —Å–æ–æ–±—â–µ–Ω–∏—è –∏ –∫–ª–∞—Å—Å
        let messageType = 'other';
        let messageClass = 'message other';
        let avatar = null;
        let avatarStyle = '';

        if (message.type === 'system') {
          messageType = 'system';
          messageClass = 'message system';
        } else if (message.type === 'thought') {
          messageType = 'thought';
          messageClass = 'message thought';
        } else if (message.characterId) {
          const character = this.characters.find(c => c.id === message.characterId);
          if (character) {
            avatar = character.name.charAt(0).toUpperCase();
            messageClass = 'message other';
            if (character.color) {
              avatarStyle = `background-color: ${character.color};`;
            }
          }
        }

        // –ï—Å–ª–∏ —ç—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        if (message.isUser) {
          messageType = 'user';
          messageClass = 'message user';
          avatar = '–¢';
        }

        messageDiv.className = messageClass + ' new';

        let messageHTML = '';
        
        if (avatar && messageType !== 'system' && messageType !== 'thought') {
          messageHTML = `
            <div class="message-with-avatar">
              <div class="message-avatar" style="${avatarStyle}">${avatarStyle ? '' : avatar}</div>
              <div class="message-bubble">
                <div class="message-content">${this.formatMessageContent(message.content)}</div>
              </div>
            </div>
          `;
        } else {
          messageHTML = `
            <div class="message-bubble">
              <div class="message-content">${this.formatMessageContent(message.content)}</div>
            </div>
          `;
        }

        messageDiv.innerHTML = messageHTML;
        
        // –£–±–∏—Ä–∞–µ–º –∫–ª–∞—Å—Å –∞–Ω–∏–º–∞—Ü–∏–∏ –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è
        setTimeout(() => {
          messageDiv.classList.remove('new');
        }, 500);
        
        return messageDiv;
      }

      formatMessageContent(content) {
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–µ—Ä–µ–Ω–æ—Å–æ–≤ —Å—Ç—Ä–æ–∫ –∏ –±–∞–∑–æ–≤–æ–µ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
        return content
          .replace(/\n/g, '<br>')
          .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
          .replace(/\*(.*?)\*/g, '<em>$1</em>');
      }

      getCurrentTime() {
        const now = new Date();
        return now.getHours().toString().padStart(2, '0') + ':' + 
               now.getMinutes().toString().padStart(2, '0');
      }

      renderMessages() {
        const messagesContainer = document.getElementById('chatMessages');
        messagesContainer.innerHTML = '';

        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ —Å–æ–æ–±—â–µ–Ω–∏—è –¥–æ —Ç–µ–∫—É—â–µ–≥–æ –∏–Ω–¥–µ–∫—Å–∞
        for (let i = 0; i < this.currentMessageIndex; i++) {
          const message = this.messages[i];
          const messageElement = this.createMessageElement(message);
          messagesContainer.appendChild(messageElement);
        }

        // –ü—Ä–æ–∫—Ä—É—Ç–∫–∞ –∫ –ø–æ—Å–ª–µ–¥–Ω–µ–º—É —Å–æ–æ–±—â–µ–Ω–∏—é
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
      }

      updateProgress() {
        const progress = (this.currentMessageIndex / this.messages.length) * 100;
        document.getElementById('progressFill').style.width = progress + '%';
        document.getElementById('progressText').textContent = 
          `–°–æ–æ–±—â–µ–Ω–∏–µ ${this.currentMessageIndex} –∏–∑ ${this.messages.length}`;
      }

      updateChapterInfo() {
        if (!this.currentChapter) return;
        
        document.getElementById('chapterInfo').textContent = 
          `–≠–ø–∏–∑–æ–¥ ${this.currentChapter.episodeNumber}`;
        
        const statusElement = document.getElementById('chapterStatus');
        statusElement.innerHTML = `
          <span class="status-available">‚óè</span> –≠–ø–∏–∑–æ–¥ –¥–æ—Å—Ç—É–ø–µ–Ω
        `;
      }

      updateChapterNavigation() {
        const currentIndex = this.chapters.findIndex(ch => ch.id === this.currentChapter.id);
        const hasPrevChapter = currentIndex > 0;
        const hasNextChapter = currentIndex < this.chapters.length - 1;
        
        document.getElementById('btnPrevChapter').disabled = !hasPrevChapter;
        document.getElementById('btnNextChapter').disabled = !hasNextChapter;
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –Ω–∞–≤–∏–≥–∞—Ü–∏—é —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –µ—Å—Ç—å –∫—É–¥–∞ –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç—å
        document.getElementById('chapterNav').style.display = 
          (hasPrevChapter || hasNextChapter) ? 'flex' : 'none';
      }

      async handleChapterComplete() {
        const currentIndex = this.chapters.findIndex(ch => ch.id === this.currentChapter.id);
        const hasNextChapter = currentIndex < this.chapters.length - 1;
        
        if (hasNextChapter) {
          // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ —Å–ª–µ–¥—É—é—â–µ–π –≥–ª–∞–≤–µ
          this.showSystemMessage('–≠–ø–∏–∑–æ–¥ –∑–∞–≤–µ—Ä—à—ë–Ω. –ì–æ—Ç–æ–≤—ã –ø–µ—Ä–µ–π—Ç–∏ –∫ —Å–ª–µ–¥—É—é—â–µ–º—É?');
          document.getElementById('btnNextChapter').style.background = 'var(--accent-primary)';
          document.getElementById('btnNextChapter').style.color = 'var(--bg-primary)';
        } else {
          this.showSystemMessage('–ò—Å—Ç–æ—Ä–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞! –°–ø–∞—Å–∏–±–æ –∑–∞ –ø—Ä–æ—á—Ç–µ–Ω–∏–µ.');
        }
      }

      showSystemMessage(text) {
        const messagesContainer = document.getElementById('chatMessages');
        const messageElement = document.createElement('div');
        messageElement.className = 'message system';
        messageElement.innerHTML = `
          <div class="message-bubble">${text}</div>
        `;
        messagesContainer.appendChild(messageElement);
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
      }

      // –ü–†–û–ì–†–ï–°–° –ò –°–û–•–†–ê–ù–ï–ù–ò–ï
      saveProgress() {
        if (!this.story || !this.currentChapter) return;
        
        const progress = {
          storyId: this.story.id,
          chapterId: this.currentChapter.id,
          messageIndex: this.currentMessageIndex,
          timestamp: new Date().getTime()
        };
        
        localStorage.setItem(`progress_${this.story.id}`, JSON.stringify(progress));
      }

      loadProgress() {
        if (!this.story) return;
        
        const saved = localStorage.getItem(`progress_${this.story.id}`);
        if (saved) {
          this.progress = JSON.parse(saved);
          
          // –ï—Å–ª–∏ –ø—Ä–æ–≥—Ä–µ—Å—Å –µ—Å—Ç—å –¥–ª—è —Ç–µ–∫—É—â–µ–π –≥–ª–∞–≤—ã, –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º
          if (this.currentChapter && this.progress.chapterId === this.currentChapter.id) {
            this.currentMessageIndex = Math.min(this.progress.messageIndex, this.messages.length - 1);
            this.renderMessages();
            this.updateProgress();
          }
        }
      }

      // NAVIGATION
      jumpToMessage(index) {
        if (index < 0 || index >= this.messages.length) return;
        
        if (this.currentTimeout) {
          clearTimeout(this.currentTimeout);
        }
        
        this.currentMessageIndex = index;
        this.renderMessages();
        this.updateProgress();
        this.saveProgress();
        
        if (this.isPlaying) {
          this.playNextMessage();
        }
      }

      async switchChapter(chapterIndex) {
        if (chapterIndex < 0 || chapterIndex >= this.chapters.length) return;
        
        if (this.currentTimeout) {
          clearTimeout(this.currentTimeout);
        }
        
        this.isPlaying = false;
        this.currentChapter = this.chapters[chapterIndex];
        await this.loadChapterMessages(this.currentChapter.id);
        this.updateChapterInfo();
        this.updateChapterNavigation();
        this.saveProgress();
        
        // –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º –∞–≤—Ç–æ–ø—Ä–æ–∏–≥—Ä—ã–≤–∞–Ω–∏–µ
        setTimeout(() => this.startAutoPlay(), 1000);
      }

      // EVENT HANDLERS
      setupEventListeners() {
        // –ù–∞–≤–∏–≥–∞—Ü–∏—è
        document.getElementById('btnBack').addEventListener('click', () => {
          window.history.back();
        });

        // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ–º
        document.getElementById('btnPlayPause').addEventListener('click', () => {
          this.togglePlayPause();
        });

        document.getElementById('btnPrev').addEventListener('click', () => {
          this.jumpToMessage(Math.max(0, this.currentMessageIndex - 1));
        });

        document.getElementById('btnNext').addEventListener('click', () => {
          this.jumpToMessage(Math.min(this.messages.length - 1, this.currentMessageIndex + 1));
        });

        document.getElementById('btnSpeed').addEventListener('click', () => {
          this.changeSpeed();
        });

        document.getElementById('btnJumpStart').addEventListener('click', () => {
          this.jumpToMessage(0);
        });

        document.getElementById('btnJumpEnd').addEventListener('click', () => {
          this.jumpToMessage(this.messages.length - 1);
        });

        // –ù–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ –≥–ª–∞–≤–∞–º
        document.getElementById('btnPrevChapter').addEventListener('click', () => {
          const currentIndex = this.chapters.findIndex(ch => ch.id === this.currentChapter.id);
          this.switchChapter(currentIndex - 1);
        });

        document.getElementById('btnNextChapter').addEventListener('click', () => {
          const currentIndex = this.chapters.findIndex(ch => ch.id === this.currentChapter.id);
          this.switchChapter(currentIndex + 1);
        });

        // –ù–∞—Å—Ç—Ä–æ–π–∫–∏
        document.getElementById('btnSound').addEventListener('click', () => {
          this.toggleSound();
        });

        document.getElementById('btnFullscreen').addEventListener('click', () => {
          this.toggleFullscreen();
        });

        // –ö–ª–∞–≤–∏–∞—Ç—É—Ä–Ω—ã–µ shortcuts
        document.addEventListener('keydown', (e) => {
          if (e.code === 'Space') {
            e.preventDefault();
            this.togglePlayPause();
          } else if (e.code === 'ArrowLeft') {
            this.jumpToMessage(Math.max(0, this.currentMessageIndex - 1));
          } else if (e.code === 'ArrowRight') {
            this.jumpToMessage(Math.min(this.messages.length - 1, this.currentMessageIndex + 1));
          }
        });

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ä–∞–∑–º–µ—Ä–∞ –æ–∫–Ω–∞
        window.addEventListener('resize', () => {
          this.handleResize();
        });
      }

      togglePlayPause() {
        this.isPlaying = !this.isPlaying;
        
        if (this.isPlaying) {
          document.getElementById('btnPlayPause').textContent = '‚è∏Ô∏è';
          this.playNextMessage();
        } else {
          document.getElementById('btnPlayPause').textContent = '‚ñ∂Ô∏è';
          if (this.currentTimeout) {
            clearTimeout(this.currentTimeout);
          }
        }
      }

      changeSpeed() {
        const speeds = [0.5, 1, 1.5, 2];
        const currentIndex = speeds.indexOf(this.playSpeed);
        this.playSpeed = speeds[(currentIndex + 1) % speeds.length];
        document.getElementById('btnSpeed').textContent = this.playSpeed + 'x';
      }

      toggleSound() {
        this.soundEnabled = !this.soundEnabled;
        document.getElementById('btnSound').classList.toggle('active', this.soundEnabled);
      }

      toggleFullscreen() {
        const container = document.getElementById('chatContainer');
        
        if (!document.fullscreenElement) {
          container.requestFullscreen().catch(err => {
            console.log('Fullscreen error:', err);
          });
          container.classList.add('fullscreen');
        } else {
          document.exitFullscreen();
          container.classList.remove('fullscreen');
        }
      }

      handleResize() {
        // –ê–¥–∞–ø—Ç–∞—Ü–∏—è –ø–æ–¥ —Ä–∞–∑–Ω—ã–µ —Ä–∞–∑–º–µ—Ä—ã —ç–∫—Ä–∞–Ω–∞
        const messagesContainer = document.getElementById('chatMessages');
        if (messagesContainer) {
          messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }
      }

      // UTILITIES
      showLoading() {
        const container = document.getElementById('chatMessages');
        container.innerHTML = `
          <div class="loading-state">
            <div class="loading-spinner"></div>
            <div>–ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π...</div>
          </div>
        `;
      }

      showError(message) {
        const container = document.getElementById('chatMessages');
        container.innerHTML = `
          <div class="error-state">
            <div class="error-icon">‚ùå</div>
            <h3>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</h3>
            <p>${message}</p>
            <button class="retry-btn" onclick="location.reload()">–ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞</button>
          </div>
        `;
        document.getElementById('chapterStatus').innerHTML = `
          <span style="color: #ff4444;">‚óè</span> –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏
        `;
      }
    }

    // –ó–∞–ø—É—Å–∫–∞–µ–º —á–∏—Ç–∞–ª–∫—É –∫–æ–≥–¥–∞ DOM –∑–∞–≥—Ä—É–∂–µ–Ω
    document.addEventListener('DOMContentLoaded', () => {
      window.chatReader = new ChatReader();
    });

    /* Seasonal theme loader for reader */
    async function readerLoadTheme() {
      // try Firestore -> localStorage
      let setting = null;
      try {
        const doc = await db.collection('settings').doc('theme').get();
        if (doc.exists) setting = doc.data();
      } catch (e) { }
      if (!setting) {
        try { setting = JSON.parse(localStorage.getItem('siteTheme')); } catch (e) { setting = null; }
      }

      let theme = null;
      if (setting) {
        if (setting.auto) {
          theme = detectAutoTheme();
        } else {
          theme = setting.theme || null;
        }
      } else {
        theme = detectAutoTheme();
      }

      applyThemeReader(theme);
    }

    function detectAutoTheme() {
      const now = new Date(); const month = now.getMonth() + 1; const day = now.getDate();
      if ((month === 12 && day >= 20) || (month === 1 && day <= 10)) return 'newyear';
      if ((month === 10 && day >= 25) || (month === 11 && day <= 5)) return 'halloween';
      if (month === 2 && day >= 7 && day <= 16) return 'valentine';
      return null;
    }

    function applyThemeReader(theme) {
      // start crossfade
      try { document.documentElement.classList.add('theme-fade'); } catch (e) {}
      setTimeout(() => { try { document.documentElement.classList.remove('theme-fade'); } catch (e) {} }, 450);

      document.documentElement.classList.remove('theme-newyear','theme-halloween','theme-valentine','theme-fear');
      clearSeasonalEffectsReader();
      if (!theme) return;
      document.documentElement.classList.add('theme-' + theme);
      createEffectsForThemeReader(theme);
    }

    function createEffectsForThemeReader(theme) {
      const container = document.createElement('div');
      container.id = 'seasonal-effects';
      document.body.appendChild(container);

      // —á–∏—Ç–∞–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ª–æ–∫–∞–ª—å–Ω–æ (–±—ã—Å—Ç—Ä–æ–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ)
      let cfg = null;
      try { const raw = localStorage.getItem('siteTheme'); if (raw) { const parsed = JSON.parse(raw); cfg = parsed.themeSettings && theme ? parsed.themeSettings[theme] : null; } } catch (e) { cfg = null; }
      const frequency = (cfg && cfg.frequency) ? Math.max(1, cfg.frequency) : 1;
      const intensity = (cfg && typeof cfg.intensity === 'number') ? Math.min(1, Math.max(0, cfg.intensity)) : 0.5;
      const computeCount = (base) => Math.max(1, Math.round(base * frequency * (0.5 + intensity)));

      if (theme === 'newyear') {
        const count = computeCount(18);
        for (let i = 0; i < count; i++) {
          const s = document.createElement('div'); s.className = 'snowflake effect-item'; s.textContent = '‚ùÑ'; s.style.left = Math.random() * 100 + '%'; s.style.fontSize = (8 + Math.random() * 18) * (0.5 + intensity) + 'px'; s.style.animationDuration = (5 + Math.random() * 6) / (0.5 + intensity) + 's'; s.style.opacity = 0.4 + Math.random() * 0.6 * intensity; container.appendChild(s);
        }
      }
      if (theme === 'halloween') {
        const count = computeCount(6);
        for (let i = 0; i < count; i++) { const b = document.createElement('div'); b.className = 'effect-item bat'; b.textContent = 'ü¶á'; b.style.left = Math.random() * 100 + '%'; b.style.top = (5 + Math.random() * 50) + '%'; b.style.opacity = 0.6 + 0.4 * intensity; container.appendChild(b); }
        const fog = document.createElement('div'); fog.className = 'fog-overlay'; fog.style.opacity = 0.2 + 0.6 * intensity; container.appendChild(fog);
      }
      if (theme === 'valentine') {
        const count = computeCount(12);
        for (let i = 0; i < count; i++) { const h = document.createElement('div'); h.className = 'heart effect-item'; h.textContent = '‚ù§'; h.style.left = Math.random() * 100 + '%'; h.style.bottom = (-10 - Math.random() * 40) + 'px'; h.style.animationDuration = (3 + Math.random() * 5) / (0.5 + intensity) + 's'; h.style.opacity = 0.5 + 0.5 * intensity; container.appendChild(h); }
      }
    }

    function clearSeasonalEffectsReader(){ const old=document.getElementById('seasonal-effects'); if (old) old.remove(); }

    // –ó–∞–ø—É—Å–∫ —Ç–µ–º—ã –≤ —á–∏—Ç–∞—Ç–µ–ª–µ
    document.addEventListener('DOMContentLoaded', () => { readerLoadTheme(); });

    // Show theme-updated notification
    function showThemeUpdatedNotice(){
      try {
        let n = document.getElementById('theme-notice');
        if (!n) {
          n = document.createElement('div');
          n.id = 'theme-notice';
          n.textContent = '–¢–µ–º–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∞';
          document.body.appendChild(n);
        }
        n.classList.add('show');
        setTimeout(() => n.classList.remove('show'), 2000);
      } catch (e) { console.warn('showThemeUpdatedNotice', e); }
    }

    // –†–µ–∞–∫—Ç–∏–≤–Ω–æ–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ —Ç–µ–º—ã –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ siteTheme –≤ localStorage (–¥—Ä—É–≥–æ–π –≤–∫–ª–∞–¥–∫–æ–π)
    window.addEventListener('storage', (e) => {
      if (e.key === 'siteTheme') {
        try { showThemeUpdatedNotice(); readerLoadTheme(); } catch (err) { console.warn('readerLoadTheme error', err); }
      }
    });

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã—Ö–æ–¥–∞ –∏–∑ –ø–æ–ª–Ω–æ—ç–∫—Ä–∞–Ω–Ω–æ–≥–æ —Ä–µ–∂–∏–º–∞
    document.addEventListener('fullscreenchange', () => {
      const container = document.getElementById('chatContainer');
      if (!document.fullscreenElement) {
        container.classList.remove('fullscreen');
      }
    });
  </script>
  <script src="themes-system.js"></script>
</body>
</html>