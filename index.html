<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>CRAWL.STORIES ‚Äî –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–µ —á–∞—Ç-–∏—Å—Ç–æ—Ä–∏–∏</title>
  
  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-firestore-compat.js"></script>
  
  <script>
    // Firebase –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
    const firebaseConfig = {
      apiKey: "AIzaSyANC4K0-xI-9SvrpoiOp4v-N2XLvCQCALg",
      authDomain: "crawl-stories.firebaseapp.com",
      projectId: "crawl-stories",
      storageBucket: "crawl-stories.firebasestorage.app",
      messagingSenderId: "886479757650",
      appId: "1:886479757650:web:194ad1dd2d02c959bdda8b",
      measurementId: "G-SGC2HF0455"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
  </script>
  
  <style>
    /* CRAWL.STORIES - –û–°–ù–û–í–ù–´–ï –°–¢–ò–õ–ò */
    :root {
      --bg-primary: #020205;
      --bg-secondary: #0b0b0f;
      --bg-card: #0b0b0f;
      --accent-primary: #FFE81F;
      --accent-secondary: #6366f1;
      --text-primary: #ffffff;
      --text-secondary: #9aa0a6;
      --text-muted: #7f8c8d;
      --chat-border: rgba(255,255,255,0.1);
      --transition-smooth: all 0.3s ease;
      --font-mono: "Courier New", monospace;
      --header-height: 70px;
    }

    * { 
      box-sizing: border-box; 
      margin: 0; 
      padding: 0; 
    }

    html, body {
      height: 100%;
      background: var(--bg-primary);
      color: var(--text-primary);
      font-family: var(--font-mono);
      -webkit-font-smoothing: antialiased;
      overflow-x: hidden;
    }

    /* HEADER */
    header {
      height: var(--header-height);
      border-bottom: 1px solid var(--chat-border);
      background: linear-gradient(180deg, rgba(2,2,5,0.95), transparent);
      backdrop-filter: blur(10px);
      position: sticky;
      top: 0;
      z-index: 100;
      width: 100%;
    }

    .header-content {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 20px;
      height: 100%;
      max-width: 1400px;
      margin: 0 auto;
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 10px;
      text-decoration: none;
    }

    .logo h1 {
      margin: 0;
      font-size: 20px;
      color: var(--accent-primary);
      letter-spacing: 1px;
    }

    .main-nav {
      display: flex;
      gap: 15px;
      flex: 1;
      justify-content: center;
    }

    .nav-btn {
      background: transparent;
      border: 1px solid rgba(255,255,255,0.1);
      color: var(--text-secondary);
      padding: 8px 16px;
      border-radius: 20px;
      cursor: pointer;
      transition: var(--transition-smooth);
      font-size: 14px;
      white-space: nowrap;
    }

    .nav-btn.active {
      background: var(--accent-primary);
      color: var(--bg-primary);
      border-color: var(--accent-primary);
    }

    .nav-btn:hover {
      background: var(--accent-primary);
      color: var(--bg-primary);
      border-color: var(--accent-primary);
    }

    .btn-admin {
      background: var(--accent-primary);
      color: var(--bg-primary);
      border: none;
      padding: 8px 16px;
      border-radius: 20px;
      cursor: pointer;
      font-weight: bold;
      font-size: 14px;
    }

    /* HERO SECTION */
    .hero-section {
      padding: 80px 20px;
      text-align: center;
      background: linear-gradient(180deg, var(--bg-primary), var(--bg-secondary));
      border-bottom: 1px solid var(--chat-border);
    }

    .hero-content {
      max-width: 600px;
      margin: 0 auto;
    }

    .hero-title {
      font-size: clamp(32px, 5vw, 48px);
      color: var(--accent-primary);
      margin-bottom: 20px;
      line-height: 1.2;
    }

    .hero-subtitle {
      font-size: clamp(16px, 3vw, 18px);
      color: var(--text-secondary);
      line-height: 1.5;
    }

    /* STORIES SECTION */
    .stories-section {
      padding: 60px 20px;
      max-width: 1400px;
      margin: 0 auto;
    }

    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 40px;
      flex-wrap: wrap;
      gap: 15px;
    }

    .section-header h2 {
      margin: 0;
      color: var(--accent-primary);
      font-size: 28px;
    }

    .stories-count {
      color: var(--text-secondary);
      font-size: 16px;
    }

    .stories-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
      gap: 25px;
    }

    .story-card {
      background: linear-gradient(180deg, var(--bg-card), #07070a);
      border-radius: 15px;
      padding: 25px;
      border: 1px solid var(--chat-border);
      cursor: pointer;
      transition: var(--transition-smooth);
      position: relative;
      overflow: hidden;
    }

    .story-card:hover {
      transform: translateY(-5px);
      border-color: rgba(255,232,31,0.3);
      box-shadow: 0 10px 30px rgba(255,232,31,0.1);
    }

    .story-card.scheduled {
      border-color: #ffc107;
      background: linear-gradient(180deg, #0b0b0f, #1a1a1f);
    }

    .story-card.soon {
      border-color: #9e9e9e;
      background: linear-gradient(180deg, #0b0b0f, #15151a);
    }

    .story-card.blocked {
      cursor: not-allowed;
      opacity: 0.7;
    }

    .story-card.blocked:hover {
      transform: none;
      border-color: var(--chat-border);
      box-shadow: none;
    }

    .story-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 15px;
    }

    .story-title {
      margin: 0;
      color: var(--accent-primary);
      font-size: 20px;
      line-height: 1.3;
      flex: 1;
    }

    .story-badge {
      background: rgba(255,232,31,0.1);
      color: var(--accent-primary);
      padding: 6px 12px;
      border-radius: 15px;
      font-size: 12px;
      font-weight: bold;
      margin-left: 10px;
      white-space: nowrap;
    }

    .story-badge.scheduled {
      background: rgba(255, 193, 7, 0.1);
      color: #ffc107;
    }

    .story-badge.soon {
      background: rgba(158, 158, 158, 0.1);
      color: #9e9e9e;
    }

    .story-badge.chat {
      background: rgba(99, 102, 241, 0.1);
      color: var(--accent-secondary);
    }

    .story-desc {
      color: var(--text-secondary);
      font-size: 15px;
      line-height: 1.5;
      margin-bottom: 20px;
      display: -webkit-box;
      -webkit-line-clamp: 3;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }

    .story-meta {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 13px;
      color: var(--text-secondary);
    }

    .story-stats {
      display: flex;
      gap: 15px;
    }

    .stat {
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .status-published {
      background: #00c853;
      color: white;
      padding: 4px 10px;
      border-radius: 10px;
      font-size: 11px;
      font-weight: bold;
    }

    .status-scheduled {
      background: rgba(255, 193, 7, 0.1);
      color: #ffc107;
      padding: 4px 10px;
      border-radius: 10px;
      font-size: 11px;
      font-weight: bold;
    }

    .status-soon {
      background: rgba(158, 158, 158, 0.1);
      color: #9e9e9e;
      padding: 4px 10px;
      border-radius: 10px;
      font-size: 11px;
      font-weight: bold;
    }

    .blocked-overlay {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(2,2,5,0.9);
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      transition: opacity 0.3s ease;
      backdrop-filter: blur(5px);
    }

    .story-card.blocked:hover .blocked-overlay {
      opacity: 1;
    }

    .blocked-message {
      text-align: center;
      padding: 20px;
      color: var(--accent-primary);
    }

    .blocked-message h4 {
      margin: 0 0 10px 0;
      color: var(--accent-primary);
    }

    .blocked-message p {
      margin: 0;
      color: var(--text-secondary);
      font-size: 14px;
    }

    /* FOOTER */
    footer {
      background: var(--bg-secondary);
      border-top: 1px solid var(--chat-border);
      padding: 40px 20px;
      text-align: center;
      margin-top: 60px;
    }

    /* Seasonal theme variables */
    .theme-newyear { --accent-primary: #aee0ff; }
    .theme-halloween { --accent-primary: #ff8c00; }
    .theme-valentine { --accent-primary: #ff9bb3; }
    .theme-fear { --accent-primary: #ff4d4d; }

    /* effects container */
    #seasonal-effects { pointer-events: none; position: fixed; inset: 0; z-index: 9999; }
    #seasonal-effects .effect-item { position: absolute; will-change: transform, opacity; }

    /* Theme crossfade helper and notification */
    .theme-fade * { transition: color 400ms ease, background-color 400ms ease, border-color 400ms ease, box-shadow 400ms ease, opacity 400ms ease; }
    #theme-notice { position: fixed; top: 16px; right: 16px; background: rgba(0,0,0,0.7); color: var(--accent-primary); padding: 8px 12px; border-radius: 8px; font-weight: bold; opacity: 0; pointer-events: none; transform: translateY(-8px); transition: opacity 300ms ease, transform 300ms ease; z-index: 10000; }
    #theme-notice.show { opacity: 1; transform: translateY(0); }

    .footer-content {
      max-width: 1200px;
      margin: 0 auto;
    }

    .footer-text {
      color: var(--text-secondary);
      margin-bottom: 20px;
    }

    /* –ê–î–ê–ü–¢–ò–í–ù–û–°–¢–¨ */
    @media (max-width: 768px) {
      :root { 
        --header-height: 60px; 
      }
      
      .header-content { 
        padding: 0 15px; 
        flex-wrap: wrap; 
        gap: 10px; 
      }
      
      .logo h1 { 
        font-size: 16px; 
      }
      
      .main-nav { 
        gap: 8px; 
        overflow-x: auto; 
        padding: 10px 0; 
        justify-content: flex-start; 
      }
      
      .nav-btn { 
        padding: 6px 12px; 
        font-size: 12px; 
        flex-shrink: 0; 
      }
      
      .btn-admin { 
        padding: 6px 12px; 
        font-size: 12px; 
      }
      
      .hero-section { 
        padding: 60px 15px; 
      }
      
      .stories-section { 
        padding: 40px 15px; 
      }
      
      .stories-grid { 
        grid-template-columns: 1fr; 
      }
      
      .section-header { 
        flex-direction: column; 
        align-items: flex-start; 
        gap: 10px; 
      }
      
      .story-header { 
        flex-direction: column; 
        gap: 10px; 
      }
      
      .story-badge { 
        margin-left: 0; 
        align-self: flex-start; 
      }
      
      .story-meta { 
        flex-direction: column; 
        gap: 10px; 
        align-items: flex-start; 
      }
      
      .story-stats { 
        width: 100%; 
        justify-content: space-between; 
      }
    }
  </style>
</head>
<body>
  <div id="mainApp">
    <header>
      <div class="header-content">
        <a href="index.html" class="logo">
          <h1>üí¨ CRAWL.STORIES</h1>
        </a>
        <nav class="main-nav" id="mainNav"></nav>
        <div class="header-controls">
          <button id="btnAdmin" class="btn-admin">‚öôÔ∏è –ê–¥–º–∏–Ω</button>
        </div>
      </div>
    </header>

    <main>
      <section class="hero-section">
        <div class="hero-content">
          <h1 class="hero-title">–ß–∞—Ç-–∏—Å—Ç–æ—Ä–∏–∏</h1>
          <p class="hero-subtitle">
            –ü–æ–≥—Ä—É–∑–∏—Å—å –≤ —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ –∏—Å—Ç–æ—Ä–∏–∏, —Ä–∞—Å—Å–∫–∞–∑–∞–Ω–Ω—ã–µ —á–µ—Ä–µ–∑ –ø–µ—Ä–µ–ø–∏—Å–∫—É –≤ –º–µ—Å—Å–µ–Ω–¥–∂–µ—Ä–µ
          </p>
        </div>
      </section>

      <section class="stories-section">
        <div class="section-header">
          <h2 id="currentCategoryTitle">–í—Å–µ –∏—Å—Ç–æ—Ä–∏–∏</h2>
          <div class="stories-count" id="storiesCount">0 –∏—Å—Ç–æ—Ä–∏–π</div>
        </div>
        <div id="storiesList" class="stories-grid"></div>
      </section>
    </main>

    <footer>
      <div class="footer-content">
        <p class="footer-text">CRAWL.STORIES ‚Äî –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞ –¥–ª—è –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã—Ö —á–∞—Ç-–∏—Å—Ç–æ—Ä–∏–π</p>
      </div>
    </footer>
  </div>

  <script>
    class PublicApp {
      constructor() {
        this.stories = [];
        this.categories = {};
        this.currentCategory = 'all';
        this.init();
      }

      initCategories() {
        this.categories = {
          'all': 'üìö –í—Å–µ –∏—Å—Ç–æ—Ä–∏–∏',
          'published': 'üöÄ –û–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–æ',
          'scheduled': '‚è∞ –û–∂–∏–¥–∞–Ω–∏–µ', 
          'soon': 'üïê –°–∫–æ—Ä–æ',
          'fantasy': 'üßô –§—ç–Ω—Ç–µ–∑–∏',
          'sci-fi': 'üöÄ –ù–∞—É—á–Ω–∞—è —Ñ–∞–Ω—Ç–∞—Å—Ç–∏–∫–∞', 
          'horror': 'üëª –•–æ—Ä—Ä–æ—Ä',
          'adventure': 'üó∫Ô∏è –ü—Ä–∏–∫–ª—é—á–µ–Ω–∏—è',
          'mystery': 'üïµÔ∏è –ú–∏—Å—Ç–∏–∫–∞',
          'chat': 'üí¨ –ß–∞—Ç-–∏—Å—Ç–æ—Ä–∏–∏'
        };
      }

      renderCategoryFilters() {
        const nav = document.getElementById('mainNav');
        if (!nav) return;

        nav.innerHTML = Object.keys(this.categories).map(category => `
          <button class="nav-btn ${this.currentCategory === category ? 'active' : ''}" 
                  data-category="${category}">
            ${this.categories[category]}
          </button>
        `).join('');

        const categoryTitle = document.getElementById('currentCategoryTitle');
        if (categoryTitle) {
          categoryTitle.textContent = this.categories[this.currentCategory];
        }

        nav.querySelectorAll('.nav-btn').forEach(btn => {
          btn.addEventListener('click', (e) => {
            this.currentCategory = e.target.dataset.category;
            this.renderCategoryFilters();
            this.renderContent();
          });
        });
      }

      async init() {
        await this.loadPublicData();
        this.initCategories();
        this.renderCategoryFilters();
        this.setupEventListeners();
        console.log('üí¨ –ü—É–±–ª–∏—á–Ω—ã–π —Å–∞–π—Ç –∑–∞–ø—É—â–µ–Ω');
      }

      async loadPublicData() {
        try {
          console.log('üîÑ –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...');
          const storiesSnapshot = await db.collection('stories').get();
          
          this.stories = storiesSnapshot.docs.map(doc => ({
            id: doc.id,
            ...doc.data()
          })).filter(story => {
            if (story.isPublic === false) return false;
            
            if (story.publishDate) {
              const publishDate = story.publishDate?.toDate ? story.publishDate.toDate() : new Date(story.publishDate);
              const now = new Date();
              
              if (publishDate <= now && !story.published) {
                console.log(`üîÑ –ê–≤—Ç–æ–ø—É–±–ª–∏–∫–∞—Ü–∏—è –∏—Å—Ç–æ—Ä–∏–∏: ${story.title}`);
                this.autoPublishStory(doc.id);
                story.published = true;
              }
            }
            
            return true;
          });

          console.log('‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–æ –∏—Å—Ç–æ—Ä–∏–π:', this.stories.length);
          this.renderContent();

        } catch (error) {
          console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö:', error);
          this.showError('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏—Å—Ç–æ—Ä–∏–∏');
        }
      }

      async autoPublishStory(storyId) {
        try {
          await db.collection('stories').doc(storyId).update({
            published: true,
            publishDate: null,
            updatedAt: new Date()
          });
          console.log(`‚úÖ –ò—Å—Ç–æ—Ä–∏—è ${storyId} –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–∞`);
        } catch (error) {
          console.error('‚ùå –û—à–∏–±–∫–∞ –∞–≤—Ç–æ–ø—É–±–ª–∏–∫–∞—Ü–∏–∏:', error);
        }
      }

      renderContent() {
        const container = document.getElementById('storiesList');
        if (!container) return;
        container.innerHTML = this.renderStories();
      }

      renderStories() {
        let filteredStories = this.stories;
        
        if (this.currentCategory === 'published') {
          filteredStories = this.stories.filter(story => story.published === true);
        } else if (this.currentCategory === 'scheduled') {
          filteredStories = this.stories.filter(story => 
            story.publishDate && new Date(story.publishDate) > new Date()
          );
        } else if (this.currentCategory === 'soon') {
          filteredStories = this.stories.filter(story => 
            !story.published && !story.publishDate
          );
        } else if (this.currentCategory === 'chat') {
          filteredStories = this.stories.filter(story => 
            story.format === 'chat' || story.isChat === true
          );
        } else if (this.currentCategory !== 'all') {
          filteredStories = this.stories.filter(story => 
            story.category === this.currentCategory
          );
        }

        this.updateStoriesCount(filteredStories.length);

        if (filteredStories.length === 0) {
          return `
            <div style="grid-column: 1 / -1; text-align: center; padding: 60px 20px; color: var(--text-secondary);">
              <div style="font-size: 64px; margin-bottom: 20px;">üìù</div>
              <h3 style="margin-bottom: 10px; color: var(--text-secondary);">–ü–æ–∫–∞ –∑–¥–µ—Å—å –ø—É—Å—Ç–æ</h3>
              <p>–ò—Å—Ç–æ—Ä–∏–∏ –ø–æ—è–≤—è—Ç—Å—è —Å–∫–æ—Ä–æ...</p>
            </div>
          `;
        }

        return filteredStories.map(story => {
          const isScheduled = story.publishDate && new Date(story.publishDate) > new Date();
          const isSoon = !story.published && !story.publishDate;
          const isPublished = story.published === true;
          const isChat = story.format === 'chat' || story.isChat === true;
          
          const isBlocked = !isPublished;

          return `
            <div class="story-card ${isScheduled ? 'scheduled' : ''} ${isSoon ? 'soon' : ''} ${isBlocked ? 'blocked' : ''}" 
                 data-story-id="${story.id}">
              <div class="story-header">
                <h3 class="story-title">${story.title || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è'}</h3>
                <div>
                  ${story.episode ? `<span class="story-badge">–≠–ø–∏–∑–æ–¥ ${story.episode}</span>` : ''}
                  ${isChat ? `<span class="story-badge chat">üí¨ –ß–∞—Ç</span>` : ''}
                  <span class="story-badge ${isScheduled ? 'scheduled' : ''} ${isSoon ? 'soon' : ''}">
                    ${this.getCategoryName(story.category, story.customCategory)}
                  </span>
                </div>
              </div>
              <p class="story-desc">${story.description || '–û–ø–∏—Å–∞–Ω–∏–µ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç'}</p>
              
              <div class="story-meta">
                <div class="story-stats">
                  ${story.chaptersCount ? `<div class="stat">üìñ ${story.chaptersCount} –≥–ª–∞–≤</div>` : ''}
                  ${story.messagesCount ? `<div class="stat">üí¨ ${story.messagesCount} —Å–æ–æ–±—â–µ–Ω–∏–π</div>` : ''}
                  ${story.duration ? `<div class="stat">‚è±Ô∏è ${story.duration} –º–∏–Ω</div>` : ''}
                </div>
                <span class="${isScheduled ? 'status-scheduled' : isSoon ? 'status-soon' : 'status-published'}">
                  ${isScheduled ? '‚è∞ –û–∂–∏–¥–∞–Ω–∏–µ' : isSoon ? 'üïê –°–∫–æ—Ä–æ' : '‚úÖ –û–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–æ'}
                </span>
              </div>
              
              ${isBlocked ? `
                <div class="blocked-overlay">
                  <div class="blocked-message">
                    <h4>‚è≥ –ï—â–µ –Ω–µ –¥–æ—Å—Ç—É–ø–Ω–æ</h4>
                    <p>–û–∂–∏–¥–∞–π—Ç–µ –≤—ã—Ö–æ–¥–∞, –∞ –ø–æ–∫–∞ –º–æ–∂–µ—Ç–µ –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å –¥—Ä—É–≥–∏–µ –Ω–∞—à–∏ –∏—Å—Ç–æ—Ä–∏–∏</p>
                  </div>
                </div>
              ` : ''}
            </div>
          `;
        }).join('');
      }

      getCategoryName(category, customCategory) {
        const categories = {
          'fantasy': 'üßô –§—ç–Ω—Ç–µ–∑–∏',
          'sci-fi': 'üöÄ –ù–∞—É—á–Ω–∞—è —Ñ–∞–Ω—Ç–∞—Å—Ç–∏–∫–∞', 
          'horror': 'üëª –•–æ—Ä—Ä–æ—Ä',
          'adventure': 'üó∫Ô∏è –ü—Ä–∏–∫–ª—é—á–µ–Ω–∏—è',
          'mystery': 'üïµÔ∏è –ú–∏—Å—Ç–∏–∫–∞',
          'chat': 'üí¨ –ß–∞—Ç-–∏—Å—Ç–æ—Ä–∏–∏'
        };
        return customCategory || categories[category] || category;
      }

      updateStoriesCount(count) {
        const countElement = document.getElementById('storiesCount');
        if (countElement) {
          const word = this.getStoriesWord(count);
          countElement.textContent = `${count} ${word}`;
        }
      }

      getStoriesWord(count) {
        if (count % 10 === 1 && count % 100 !== 11) return '–∏—Å—Ç–æ—Ä–∏—è';
        if (count % 10 >= 2 && count % 10 <= 4 && (count % 100 < 10 || count % 100 >= 20)) return '–∏—Å—Ç–æ—Ä–∏–∏';
        return '–∏—Å—Ç–æ—Ä–∏–π';
      }

      setupEventListeners() {
        document.getElementById('btnAdmin')?.addEventListener('click', () => {
          window.open('admin.html', '_blank');
        });

        document.addEventListener('click', (e) => {
          const storyCard = e.target.closest('.story-card');
          if (storyCard && !storyCard.classList.contains('blocked')) {
            const storyId = storyCard.dataset.storyId;
            if (storyId) {
              this.openStory(storyId);
            }
          } else if (storyCard && storyCard.classList.contains('blocked')) {
            this.showBlockedMessage();
          }
        });
      }

      openStory(storyId) {
        const story = this.stories.find(s => s.id === storyId);
        if (!story) {
          console.warn('–ò—Å—Ç–æ—Ä–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞:', storyId);
          return;
        }

        if (!story.published) {
          this.showBlockedMessage();
          return;
        }

        window.open(`reader.html?story=${storyId}`, '_blank');
      }

      showBlockedMessage() {
        alert('–û–π! –î–∞–Ω–Ω—ã–π —ç–ø–∏–∑–æ–¥ –µ—â–µ –Ω–µ –¥–æ—Å—Ç—É–ø–µ–Ω, –æ–∂–∏–¥–∞–π—Ç–µ –≤—ã—Ö–æ–¥–∞, –∞ –ø–æ–∫–∞ –º–æ–∂–µ—Ç–µ –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å –¥—Ä—É–≥–∏–µ –Ω–∞—à–∏ –∏—Å—Ç–æ—Ä–∏–∏ –∏ —ç–ø–∏–∑–æ–¥—ã.');
      }

      showError(message) {
        const container = document.getElementById('storiesList');
        if (container) {
          container.innerHTML = `
            <div style="grid-column: 1 / -1; text-align: center; padding: 40px; color: #ff6b6b;">
              <div style="font-size: 48px; margin-bottom: 20px;">‚ùå</div>
              <h3 style="margin-bottom: 10px;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</h3>
              <p>${message}</p>
            </div>
          `;
        }
      }
    }

    document.addEventListener('DOMContentLoaded', () => {
      window.app = new PublicApp();
    });
    
    // –ü—Ä–∏–º–µ–Ω—è–µ–º —Ç–µ–º—É –Ω–∞ –ø—É–±–ª–∏—á–Ω–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü–µ
    async function applyPublicTheme(){
      // start theme crossfade
      try { document.documentElement.classList.add('theme-fade'); } catch (e) {}
      // remove fade helper after transition
      setTimeout(() => { try { document.documentElement.classList.remove('theme-fade'); } catch (e) {} }, 450);

      let setting = null;
      try { const doc = await db.collection('settings').doc('theme').get(); if (doc.exists) setting = doc.data(); } catch (e) {}
      if (!setting) { try { setting = JSON.parse(localStorage.getItem('siteTheme')); } catch (e) { setting = null; } }
      let theme = null;
      if (setting) {
        theme = setting.auto ? (function(){ const now=new Date(),m=now.getMonth()+1,d=now.getDate(); if((m===12&&d>=20)||(m===1&&d<=10))return'newyear'; if((m===10&&d>=25)||(m===11&&d<=5))return'halloween'; if(m===2&&d>=7&&d<=16)return'valentine'; return null; })() : (setting.theme||null);
      } else {
        // –∞–≤—Ç–æ-–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ –¥–∞—Ç–µ
        const now=new Date(),m=now.getMonth()+1,d=now.getDate(); if((m===12&&d>=20)||(m===1&&d<=10)) theme='newyear'; else if((m===10&&d>=25)||(m===11&&d<=5)) theme='halloween'; else if(m===2&&d>=7&&d<=16) theme='valentine';
      }
      // clear existing classes/effects
      document.documentElement.classList.remove('theme-newyear','theme-halloween','theme-valentine','theme-fear');
      const old = document.getElementById('seasonal-effects'); if (old) old.remove();
      if (!theme) return;
      document.documentElement.classList.add('theme-'+theme);
      const container = document.createElement('div'); container.id='seasonal-effects'; document.body.appendChild(container);
      // Read local tuning if available
      let cfg = null;
      try { const raw = localStorage.getItem('siteTheme'); if (raw) { const parsed = JSON.parse(raw); cfg = parsed.themeSettings && theme ? parsed.themeSettings[theme] : null; } } catch (e) { cfg = null; }
      const frequency = (cfg && cfg.frequency) ? Math.max(1, cfg.frequency) : 1;
      const intensity = (cfg && typeof cfg.intensity === 'number') ? Math.min(1, Math.max(0, cfg.intensity)) : 0.5;
      const computeCount = (base) => Math.max(1, Math.round(base * frequency * (0.5 + intensity)));
      if (theme==='newyear') { const count = computeCount(18); for(let i=0;i<count;i++){const s=document.createElement('div');s.className='snowflake effect-item';s.textContent='‚ùÑ';s.style.left=Math.random()*100+'%';s.style.fontSize=((8+Math.random()*18)*(0.5+intensity))+'px';s.style.animationDuration=(5+Math.random()*6)/(0.5+intensity)+'s';s.style.opacity=0.4+Math.random()*0.6*intensity;container.appendChild(s);} }
      if (theme==='halloween'){ const count = computeCount(6); for(let i=0;i<count;i++){const b=document.createElement('div');b.className='effect-item bat';b.textContent='ü¶á';b.style.left=Math.random()*100+'%';b.style.top=(5+Math.random()*50)+'%';b.style.opacity=0.6+0.4*intensity;container.appendChild(b);} const fog=document.createElement('div');fog.className='fog-overlay';fog.style.opacity=0.2+0.6*intensity;container.appendChild(fog); }
      if (theme==='valentine'){ const count = computeCount(12); for(let i=0;i<count;i++){const h=document.createElement('div');h.className='heart effect-item';h.textContent='‚ù§';h.style.left=Math.random()*100+'%';h.style.bottom=(-10-Math.random()*40)+'px';h.style.animationDuration=(3+Math.random()*5)/(0.5+intensity)+'s';h.style.opacity=0.5+0.5*intensity;container.appendChild(h);} }
    }
    // initial run
    applyPublicTheme();

    // Show a small flash notification when theme is updated
    function showThemeUpdatedNotice(){
      try {
        let n = document.getElementById('theme-notice');
        if (!n) {
          n = document.createElement('div');
          n.id = 'theme-notice';
          n.textContent = '–¢–µ–º–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∞';
          document.body.appendChild(n);
        }
        n.classList.add('show');
        setTimeout(() => n.classList.remove('show'), 2000);
      } catch (e) { console.warn('showThemeUpdatedNotice', e); }
    }

    // React to changes saved in other tabs/windows
    window.addEventListener('storage', (e) => {
      if (e.key === 'siteTheme') {
        try { showThemeUpdatedNotice(); applyPublicTheme(); } catch (err) { console.warn('applyPublicTheme error', err); }
      }
    });
  </script>
</body>
</html>