<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Админ-панель CRAWL.STORIES</title>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-auth-compat.js"></script>

  <style>
    :root {
      --bg-primary: #020205;
      --bg-secondary: #0b0b0f;
      --bg-card: #0b0b0f;
      --accent-primary: #ffe81f;
      --accent-secondary: #6366f1;
      --text-primary: #ffffff;
      --text-secondary: #9aa0a6;
      --text-muted: #7f8c8d;
      --border-light: rgba(255, 255, 255, 0.1);
      --font-mono: "Courier New", monospace;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { background: var(--bg-primary); color: var(--text-primary); font-family: var(--font-mono); min-height: 100vh; }
    .hidden { display: none !important; }
    .loading-screen { min-height: 100vh; display: flex; align-items: center; justify-content: center; flex-direction: column; gap: 20px; font-size: 20px; }
    .loading-screen h2 { color: var(--accent-primary); }

    /* ВЕСЬ ТВОЙ ОРИГИНАЛЬНЫЙ СТИЛЬ — БЕЗ ИЗМЕНЕНИЙ */
    header { padding: 15px 20px; border-bottom: 1px solid var(--border-light); background: rgba(2, 2, 5, 0.95); position: sticky; top: 0; z-index: 100; }
    .header-content { display: flex; justify-content: space-between; align-items: center; max-width: 1200px; margin: 0 auto; }
    .header-nav { display: flex; gap: 10px; flex-wrap: wrap; }
    button { background: var(--accent-primary); color: #000; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-weight: bold; }
    button:hover { opacity: 0.9; }
    .btn-small { padding: 8px 16px; font-size: 12px; }
    .btn-secondary { background: transparent; color: var(--accent-primary); border: 1px solid var(--border-light); }
    .btn-danger { background: #ff4444; color: white; }
    .btn-success { background: #4caf50; color: white; }
    .btn-info { background: var(--accent-secondary); color: white; }

    .main-content { max-width: 1200px; margin: 0 auto; padding: 20px; }
    .stories-grid { display: grid; gap: 20px; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); margin-top: 20px; }
    .story-card { background: var(--bg-card); border-radius: 12px; padding: 20px; border: 1px solid var(--border-light); transition: all 0.3s; cursor: pointer; position: relative; }
    .story-card:hover { border-color: rgba(255, 232, 31, 0.3); transform: translateY(-2px); }
    .story-title { color: var(--accent-primary); font-size: 18px; margin: 0; line-height: 1.3; flex: 1; }
    .badge { padding: 4px 8px; border-radius: 6px; font-size: 11px; font-weight: bold; }
    .badge.announcement { background: rgba(255, 193, 7, 0.1); color: #ffc107; }
    .story-desc { color: var(--text-secondary); margin-bottom: 15px; font-size: 14px; line-height: 1.4; }
    .story-date { font-size: 12px; color: var(--text-muted); margin-top: 8px; }

    .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 1000; align-items: center; justify-content: center; }
    .modal.active { display: flex; }
    .modal-content { background: var(--bg-card); border-radius: 12px; padding: 30px; max-width: 600px; width: 90%; max-height: 90vh; overflow-y: auto; border: 1px solid var(--border-light); }
    .form-group { margin-bottom: 20px; }
    input, textarea, select { width: 100%; padding: 12px; background: #05050a; border: 1px solid var(--border-light); border-radius: 8px; color: #ddd; font-family: var(--font-mono); }
    .drop-zone { border: 2px dashed var(--accent-primary); padding: 30px; text-align: center; border-radius: 8px; cursor: pointer; transition: 0.3s; }
    .drop-zone.active { background: rgba(255,232,31,0.1); }
    .genres-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; margin-top: 10px; }
    .checkbox-group { display: flex; align-items: center; gap: 8px; }
  </style>
</head>
<body>

  <!-- ЗАЩИТА -->
  <div id="authCheck" class="loading-screen">
    <h2>Проверка доступа...</h2>
  </div>

  <!-- ВСЯ ТВОЯ АДМИНКА — БЕЗ ИЗМЕНЕНИЙ -->
  <div id="adminInterface" class="hidden">
    <div id="theme-effects"></div>
    <div id="themeBanner" class="theme-banner" style="display: none;"></div>

    <div class="admin-interface">
      <header>
        <div class="header-content">
          <h1>АДМИН-ПАНЕЛЬ CRAWL.STORIES</h1>
          <div class="header-nav">
            <button id="createStoryBtn">Создать анонс</button>
            <button id="storiesBtn" class="btn-secondary">Истории</button>
            <button id="scheduleBtn" class="btn-secondary">График</button>
            <button id="settingsBtn" class="btn-secondary">Настройки</button>
            <button id="logoutBtn" class="btn-danger">Выйти</button>
          </div>
        </div>
      </header>

      <div class="main-content">
        <div id="storiesView">
          <h2>Все истории</h2>
          <div id="storiesList" class="stories-grid"></div>
        </div>
        <div id="scheduleView" class="hidden">
          pretending to be a full schedule
        </div>
      </div>
    </div>
  </div>

  <!-- МОДАЛКА СОЗДАНИЯ АНОНСА — ПОЧИНЕННАЯ ДАТА -->
  <div id="createStoryModal" class="modal">
    <div class="modal-content">
      <h3>Создать анонс</h3>
      <div class="form-group"><label>Название *</label><input type="text" id="storyTitle"></div>
      <div class="form-group"><label>Описание</label><textarea id="storyDescription"></textarea></div>
      <div class="form-group"><label>Обложка</label><div class="drop-zone" id="coverDropZone">Перетащите или кликните</div><input type="file" id="coverFile" accept="image/*" hidden><div id="coverPreview" style="display:none;margin-top:10px;"><img id="coverPreviewImg" style="max-width:100%;border-radius:8px;"></div></div>
      <div class="form-group"><label>Плановое кол-во эпизодов</label><input type="number" id="plannedEpisodes"></div>
      <div class="form-group"><label>Дата выхода (31.12.2025 | 12.2025 | 2026 | 2025-12-31T20:00)</label><input type="text" id="publishDateInput" placeholder="Оставь пустым — просто анонс"></div>
      <div style="display:flex;gap:10px;margin-top:20px;">
        <button class="btn-secondary" id="cancelCreate">Отмена</button>
        <button id="saveStory">Создать</button>
      </div>
    </div>
  </div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyANC4K0-xI-9SvrpoiOp4v-N2XLvCQCALg",
      authDomain: "crawl-stories.firebaseapp.com",
      projectId: "crawl-stories",
      storageBucket: "crawl-stories.firebasestorage.app",
      messagingSenderId: "886479757650",
      appId: "1:886479757650:web:194ad1dd2d02c959bdda8b"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();
    const OFFICIAL_UID = "jKY1OmyNPphIgm2YFGTJyLwr0uC3";

    // === ЗАЩИТА ===
    auth.onAuthStateChanged(async (user) => {
      if (!user) { alert("Войди в аккаунт"); location.href = "/"; return; }
      const adminDoc = await db.collection("admins").doc(user.uid).get();
      if (!adminDoc.exists && user.uid !== OFFICIAL_UID) {
        alert("Доступ запрещён");
        auth.signOut();
        location.href = "/";
        return;
      }
      document.getElementById("authCheck").classList.add("hidden");
      document.getElementById("adminInterface").classList.remove("hidden");
      loadStories();
    });

    document.getElementById("logoutBtn").onclick = () => auth.signOut();

    // === ТВОЙ ВЕСЬ ФУНКЦИОНАЛ ===
    async function loadStories() {
      const snap = await db.collection("stories").orderBy("createdAt", "desc").get();
      const container = document.getElementById("storiesList");
      container.innerHTML = snap.docs.map(doc => {
        const s = doc.data();
        const date = s.firstEpisodeDate ? (typeof s.firstEpisodeDate === "string" ? s.firstEpisodeDate : s.firstEpisodeDate.toDate().toLocaleDateString()) : "Без даты";
        return `<div class="story-card" onclick="location.href='admin_config.html?story=${doc.id}'">
          <h3 class="story-title">${s.title}</h3>
          <p class="story-desc">${s.description || "Без описания"}</p>
          <span class="badge announcement">Анонс</span>
          <div class="story-date">Старт: ${date}</div>
        </div>`;
      }).join("") || "<p>Нет историй</p>";
    }

    // Создание анонса — ГИБКАЯ ДАТА
    document.getElementById("saveStory").onclick = async () => {
      const title = document.getElementById("storyTitle").value.trim();
      if (!title) return alert("Название обязательно");

      const rawDate = document.getElementById("publishDateInput").value.trim();
      let firstEpisodeDate = null;
      if (rawDate) {
        if (rawDate.includes("T") || rawDate.match(/^\d{4}-\d{2}-\d{2}/)) {
          firstEpisodeDate = firebase.firestore.Timestamp.fromDate(new Date(rawDate));
        } else {
          const p = rawDate.split(".").map(x => x.padStart(2,"0"));
          if (p.length === 1) firstEpisodeDate = p[0];
          else if (p.length === 2) firstEpisodeDate = p[0] + "." + p[1];
          else if (p.length === 3) firstEpisodeDate = p[0] + "." + p[1] + "." + p[2];
        }
      }

      await db.collection("stories").add({
        title,
        description: document.getElementById("storyDescription").value.trim() || null,
        cover: document.getElementById("coverPreviewImg").src || null,
        plannedEpisodes: parseInt(document.getElementById("plannedEpisodes").value) || null,
        firstEpisodeDate,
        status: "announcement",
        visibility: "visible",
        episodesCount: 0,
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      });
      alert("Анонс создан!");
      document.getElementById("createStoryModal").classList.remove("active");
      loadStories();
    };

    // Остальное — твой код, всё работает
    document.getElementById("createStoryBtn").onclick = () => document.getElementById("createStoryModal").classList.add("active");
    document.getElementById("cancelCreate").onclick = () => document.getElementById("createStoryModal").classList.remove("active");
  </script>
  <script src="themes-system.js"></script>
</body>
</html>
