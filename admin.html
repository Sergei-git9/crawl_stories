<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Админ-панель CRAWL.STORIES</title>

  <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-firestore-compat.js"></script>

  <style>
    :root {
      --bg: #020205;
      --card: #0b0b0f;
      --text: #fff;
      --accent: #ffe81f;
      --border: rgba(255,255,255,0.1);
      --muted: #9aa0a6;
    }
    * { margin:0; padding:0; box-sizing:border-box; }
    body { background:var(--bg); color:var(--text); font-family:'Courier New',monospace; min-height:100vh; display:flex; flex-direction:column; align-items:center; justify-content:center; }
    .hidden { display:none!important; }
    .loading { text-align:center; padding:40px; font-size:18px; }
    header { position:fixed; top:0; left:0; right:0; background:rgba(2,2,5,0.95); border-bottom:1px solid var(--border); padding:15px; z-index:100; display:flex; justify-content:space-between; align-items:center; }
    .btn { background:var(--accent); color:#000; border:none; padding:10px 20px; border-radius:8px; cursor:pointer; font-weight:bold; }
    .btn-sec { background:transparent; color:var(--accent); border:1px solid var(--border); }
    .btn-danger { background:#ff4444; color:#fff; }
    .main { max-width:1200px; width:100%; padding:80px 20px 20px; }
    .grid { display:grid; gap:20px; grid-template-columns:repeat(auto-fill,minmax(350px,1fr)); margin-top:20px; }
    .card { background:var(--card); border:1px solid var(--border); border-radius:12px; padding:20px; cursor:pointer; transition:0.3s; }
    .card:hover { border-color:var(--accent); transform:translateY(-4px); }
    .modal { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.9); z-index:1000; align-items:center; justify-content:center; }
    .modal.active { display:flex; }
    .modal-content { background:var(--card); padding:30px; border-radius:12px; width:90%; max-width:600px; max-height:90vh; overflow:auto; border:1px solid var(--border); }
    input, textarea { width:100%; padding:12px; background:#05050a; border:1px solid var(--border); border-radius:8px; color:#fff; margin-bottom:15px; }
    .drop { border:2px dashed var(--accent); padding:40px; text-align:center; border-radius:8px; cursor:pointer; }
    .drop.active { background:rgba(255,232,31,0.1); }
  </style>
</head>
<body>

  <div id="check" class="loading">Перевірка прав доступу...</div>

  <div id="panel" class="hidden">
    <header>
      <h1>Админ-панель CRAWL.STORIES</h1>
      <div>
        <button class="btn" id="createBtn">Створити анонс</button>
        <button class="btn-sec" id="storiesBtn">Історії</button>
        <button class="btn-sec" id="scheduleBtn">Графік</button>
        <button class="btn-danger" id="logoutBtn">Вийти</button>
      </div>
    </header>

    <div class="main">
      <div id="storiesView"><div class="grid" id="storiesGrid">Завантаження...</div></div>
      <div id="scheduleView" class="hidden"><div class="grid" id="scheduleGrid">Графік порожній</div></div>
    </div>
  </div>

  <!-- Модалка створення анонсу -->
  <div id="modal" class="modal">
    <div class="modal-content">
      <h2>Новий анонс</h2>
      <input type="text" id="title" placeholder="Назва *" required>
      <textarea id="desc" placeholder="Опис (необов'язково)"></textarea>
      <input type="number" id="epCount" placeholder="Планована кількість епізодів">
      
      <div class="drop" id="dropZone">Обкладинка — перетягни або клікни</div>
      <input type="file" id="coverInput" accept="image/*" hidden>
      <div id="preview" style="display:none; margin:10px 0;"><img id="prevImg" style="max-width:100%; border-radius:8px;"></div>

      <input type="text" id="dateInput" placeholder="Дата: 31.12.2025 або 12.2025 або 2026 або 2025-12-31T20:00">

      <div style="margin-top:20px; display:flex; gap:10px;">
        <button class="btn-sec" id="cancelBtn">Скасувати</button>
        <button class="btn" id="saveBtn">Створити</button>
      </div>
    </div>
  </div>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyANC4K0-xI-9SvrpoiOp4v-N2XLvCQCALg",
    authDomain: "crawl-stories.firebaseapp.com",
    projectId: "crawl-stories",
    storageBucket: "crawl-stories.firebasestorage.app",
    messagingSenderId: "886479757650",
    appId: "1:886479757650:web:194ad1dd2d02c959bdda8b"
  };

  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();
  const ADMIN_UID = "jKY1OmyNPphIgm2YFGTJyLwr0uC3";

  auth.onAuthStateChanged(async user => {
    if (!user) { alert("Увійди в акаунт"); location.href="/"; return; }

    const isOfficial = user.uid === ADMIN_UID;
    const adminDoc = await db.collection("admins").doc(user.uid).get();

    if (!isOfficial && !adminDoc.exists) {
      alert("Доступ заборонено. Ти не адмін.");
      auth.signOut();
      location.href = "/";
      return;
    }

    document.getElementById("check").classList.add("hidden");
    document.getElementById("panel").classList.remove("hidden");
    loadStories();
  });

  document.getElementById("logoutBtn").onclick = () => auth.signOut();
  document.getElementById("createBtn").onclick = () => document.getElementById("modal").classList.add("active");
  document.getElementById("cancelBtn").onclick = () => document.getElementById("modal").classList.remove("active");
  document.getElementById("modal").onclick = e => e.target === document.getElementById("modal") && e.target.classList.remove("active");

  // Обкладинка
  const drop = document.getElementById("dropZone");
  const input = document.getElementById("coverInput");
  drop.onclick = () => input.click();
  input.onchange = e => e.target.files[0] && previewFile(e.target.files[0]);
  drop.ondragover = e => { e.preventDefault(); drop.classList.add("active"); };
  drop.ondragleave = drop.ondrop = e => { e.preventDefault(); drop.classList.remove("active"); if (e.dataTransfer?.files[0]) previewFile(e.dataTransfer.files[0]); };

  function previewFile(file) {
    const reader = new FileReader();
    reader.onload = e => {
      document.getElementById("prevImg").src = e.target.result;
      document.getElementById("preview").style.display = "block";
    };
    reader.readAsDataURL(file);
  }

  // Гнучкий парсер дати
  function parseDate(str) {
    if (!str?.trim()) return null;
    str = str.trim();

    if (str.includes("T") || str.match(/^\d{4}-\d{2}-\d{2}/)) {
      return firebase.firestore.Timestamp.fromDate(new Date(str));
    }
    const p = str.split(".").map(x => x.padStart(2,"0"));
    if (p.length === 1) return p[0];
    if (p.length === 2) return `${p[0]}.${p[1]}`;
    if (p.length === 3) return `${p[0]}.${p[1]}.${p[2]}`;
    return null;
  }

  // Створення анонсу
  document.getElementById("saveBtn").onclick = async () => {
    const title = document.getElementById("title").value.trim();
    if (!title) return alert("Вкажи назву!");

    const data = {
      title,
      description: document.getElementById("desc").value.trim() || null,
      cover: document.getElementById("prevImg").src || null,
      plannedEpisodes: parseInt(document.getElementById("epCount").value) || null,
      firstEpisodeDate: parseDate(document.getElementById("dateInput").value),
      status: "announcement",
      visibility: "visible",
      episodesCount: 0,
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    };

    try {
      await db.collection("stories").add(data);
      alert("Анонс створено!");
      document.getElementById("modal").classList.remove("active");
      loadStories();
    } catch (e) { console.error(e); alert("Помилка"); }
  };

  async function loadStories() {
    const snap = await db.collection("stories").where("status", "==", "announcement").orderBy("createdAt", "desc").get();
    const grid = document.getElementById("storiesGrid");
    if (snap.empty) {
      grid.innerHTML = "<div style='grid-column:1/-1; text-align:center; padding:40px;'>Анонсів немає</div>";
      return;
    }
    grid.innerHTML = snap.docs.map(doc => {
      const d = doc.data();
      return `<div class="card" onclick="location.href='admin_config.html?story=${doc.id}'">
        <h3>${d.title}</h3>
        <p>${d.firstEpisodeDate || "Без дати"}</p>
      </div>`;
    }).join("");
  }

  // Перемикання вкладок
  document.getElementById("storiesBtn").onclick = () => {
    document.getElementById("storiesView").classList.remove("hidden");
    document.getElementById("scheduleView").classList.add("hidden");
  };
  document.getElementById("scheduleBtn").onclick = () => {
    document.getElementById("storiesView").classList.add("hidden");
    document.getElementById("scheduleView").classList.remove("hidden");
  };
</script>
</body>
</html>
