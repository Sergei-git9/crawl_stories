<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Админ-панель CRAWL.STORIES</title>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-auth-compat.js"></script>

  <style>
    :root {
      --bg-primary: #020205;
      --bg-secondary: #0b0b0f;
      --bg-card: #0b0b0f;
      --accent-primary: #ffe81f;
      --accent-secondary: #6366f1;
      --text-primary: #ffffff;
      --text-secondary: #9aa0a6;
      --text-muted: #7f8c8d;
      --border-light: rgba(255, 255, 255, 0.1);
      --font-mono: "Courier New", monospace;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      background: var(--bg-primary);
      color: var(--text-primary);
      font-family: var(--font-mono);
      min-height: 100vh;
    }

    .loading-screen {
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-direction: column;
      gap: 20px;
      font-size: 20px;
    }

    .loading-screen h2 {
      color: var(--accent-primary);
    }

    .hidden {
      display: none !important;
    }

    /* LOGIN SCREEN */
    .login-screen {
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .login-card {
      max-width: 400px;
      width: 100%;
      text-align: center;
    }

    .login-card h2 {
      color: var(--accent-primary);
      margin-bottom: 30px;
    }

    .form-group {
      margin-bottom: 20px;
      text-align: left;
    }

    .form-group label {
      display: block;
      margin-bottom: 8px;
      color: var(--text-secondary);
    }

    .form-group input {
      width: 100%;
      padding: 12px;
      border-radius: 8px;
      border: 1px solid var(--border-light);
      background: #05050a;
      color: #ddd;
      font-family: var(--font-mono);
      font-size: 14px;
    }

    /* BUTTONS */
    button {
      background: var(--accent-primary);
      color: var(--bg-primary);
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      cursor: pointer;
      font-family: var(--font-mono);
      font-weight: bold;
      transition: opacity 0.3s;
    }

    button:hover {
      opacity: 0.9;
    }

    .btn-small {
      padding: 8px 16px;
      font-size: 12px;
    }

    .btn-secondary {
      background: transparent;
      color: var(--accent-primary);
      border: 1px solid var(--border-light);
    }

    .btn-danger {
      background: #ff4444;
      color: white;
    }

    .btn-success {
      background: #4caf50;
      color: white;
    }

    .btn-info {
      background: var(--accent-secondary);
      color: white;
    }

    /* ADMIN INTERFACE */
    .admin-interface {
      min-height: 100vh;
    }

    header {
      padding: 15px 20px;
      border-bottom: 1px solid var(--border-light);
      background: rgba(2, 2, 5, 0.95);
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .header-content {
      display: flex;
      justify-content: space-between;
      align-items: center;
      max-width: 1200px;
      margin: 0 auto;
    }

    .header-nav {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    /* THEME BANNER */
    .theme-banner {
      background: linear-gradient(135deg, var(--theme-accent, var(--accent-primary)), transparent);
      padding: 10px 20px;
      text-align: center;
      font-weight: bold;
      border-bottom: 1px solid var(--border-light);
      animation: slideDown 0.5s ease-out;
    }

    @keyframes slideDown {
      from { transform: translateY(-100%); }
      to { transform: translateY(0); }
    }

    /* MAIN CONTENT */
    .main-content {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }

    /* STORIES GRID */
    .stories-grid {
      display: grid;
      gap: 20px;
      grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
      margin-top: 20px;
    }

    .story-card {
      background: var(--bg-card);
      border-radius: 12px;
      padding: 20px;
      border: 1px solid var(--border-light);
      transition: border-color 0.3s;
      cursor: pointer;
      position: relative;
    }

    .story-card:hover {
      border-color: rgba(255, 232, 31, 0.3);
      transform: translateY(-2px);
    }

    .story-card-corner {
      position: absolute;
      top: 10px;
      right: 10px;
      font-size: 16px;
    }

    .story-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 10px;
      gap: 10px;
    }

    .story-title {
      color: var(--accent-primary);
      font-size: 18px;
      margin: 0;
      line-height: 1.3;
      flex: 1;
    }

    .story-meta {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .badge {
      padding: 4px 8px;
      border-radius: 6px;
      font-size: 11px;
      white-space: nowrap;
      font-weight: bold;
    }

    .badge.announcement {
      background: rgba(255, 193, 7, 0.1);
      color: #ffc107;
    }

    .badge.draft {
      background: rgba(158, 158, 158, 0.1);
      color: #9e9e9e;
    }

    .badge.releasing {
      background: rgba(33, 150, 243, 0.1);
      color: #2196f3;
    }

    .badge.published {
      background: rgba(76, 175, 80, 0.1);
      color: #4caf50;
    }

    .badge.hidden {
      background: rgba(158, 158, 158, 0.1);
      color: #9e9e9e;
      border: 1px dashed #9e9e9e;
    }

    .story-desc {
      color: var(--text-secondary);
      margin-bottom: 15px;
      font-size: 14px;
      line-height: 1.4;
    }

    .story-date {
      font-size: 12px;
      color: var(--text-muted);
      margin-top: 8px;
    }

    /* MODALS */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }

    .modal.active {
      display: flex;
    }

    .modal-content {
      background: var(--bg-card);
      border-radius: 12px;
      padding: 30px;
      max-width: 600px;
      width: 90%;
      max-height: 90vh;
      overflow-y: auto;
      border: 1px solid var(--border-light);
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .modal-title {
      color: var(--accent-primary);
      font-size: 20px;
    }

    .close-modal {
      background: none;
      border: none;
      color: var(--text-secondary);
      font-size: 24px;
      cursor: pointer;
      padding: 0;
    }

    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
      margin-bottom: 15px;
    }

    .form-group textarea,
    .form-group select {
      width: 100%;
      padding: 12px;
      border-radius: 8px;
      border: 1px solid var(--border-light);
      background: #05050a;
      color: #ddd;
      font-family: var(--font-mono);
      font-size: 14px;
    }

    .form-group textarea {
      resize: vertical;
      min-height: 100px;
    }

    .checkbox-group {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 8px;
    }

    .checkbox-group input[type="checkbox"] {
      width: 16px;
      height: 16px;
    }

    .checkbox-group label {
      margin: 0;
      color: var(--text-secondary);
      font-size: 14px;
    }

    .genres-container {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 10px;
      margin-top: 10px;
    }

    .drop-zone {
      border: 2px dashed var(--accent-primary);
      border-radius: 8px;
      padding: 30px;
      text-align: center;
      color: var(--text-secondary);
      margin: 10px 0;
      transition: all 0.3s;
      cursor: pointer;
    }

    .drop-zone:hover {
      background: rgba(255, 232, 31, 0.1);
    }

    .drop-zone.active {
      background: rgba(255, 232, 31, 0.1);
      border-color: var(--accent-primary);
    }

    .date-precision {
      font-size: 12px;
      color: var(--accent-primary);
      margin-top: 5px;
    }

    /* SCHEDULE */
    .schedule-list {
      margin-top: 20px;
    }

    .schedule-item {
      background: var(--bg-card);
      border-radius: 12px;
      padding: 15px;
      margin-bottom: 10px;
      border: 1px solid var(--border-light);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .schedule-info {
      flex: 1;
    }

    .schedule-date {
      text-align: right;
      min-width: 200px;
    }

    .publish-date {
      color: var(--accent-primary);
      font-weight: bold;
    }

    .publish-status {
      font-size: 12px;
      color: var(--text-muted);
      margin-top: 4px;
    }

    /* SETTINGS */
    .settings-grid {
      display: grid;
      gap: 20px;
      margin-top: 20px;
    }

    .settings-card {
      background: var(--bg-card);
      border-radius: 12px;
      padding: 20px;
      border: 1px solid var(--border-light);
    }

    .theme-controls {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 15px;
      margin-top: 15px;
    }

    .theme-control {
      background: var(--bg-secondary);
      padding: 15px;
      border-radius: 8px;
      border: 2px solid transparent;
      transition: all 0.3s;
    }

    .theme-control.active {
      border-color: var(--accent-primary);
    }

    .theme-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 10px;
    }

    .theme-name {
      font-weight: bold;
      color: var(--accent-primary);
    }

    .theme-dates {
      font-size: 12px;
      color: var(--text-muted);
    }

    .theme-controls-row {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }
  </style>
</head>
<body>

  <!-- Экран проверки доступа -->
  <div id="authCheck" class="loading-screen">
    <h2>Проверка прав доступа...</h2>
    <p>Подожди секунду</p>
  </div>

  <!-- ВСЯ ТВОЯ АДМИНКА -->
  <div id="adminInterface" class="hidden">
    <div id="theme-effects"></div>
    <div id="themeBanner" class="theme-banner" style="display: none;"></div>

    <div class="admin-interface">
      <header>
        <div class="header-content">
          <h1>АДМИН-ПАНЕЛЬ CRAWL.STORIES</h1>
          <div class="header-nav">
            <button id="createStoryBtn">Создать анонс</button>
            <button id="storiesBtn" class="btn-secondary">Истории</button>
            <button id="scheduleBtn" class="btn-secondary">График</button>
            <button id="settingsBtn" class="btn-secondary">Настройки</button>
            <button id="logoutBtn" class="btn-danger">Выйти</button>
          </div>
        </div>
      </header>

      <div class="main-content">
        <div id="storiesView">
          <h2>Все истории</h2>
          <div id="storiesList" class="stories-grid">
            <div class="loading">Загрузка историй...</div>
          </div>
        </div>

        <div id="scheduleView" class="hidden">
          <h2>График публикаций</h2>
          <div id="scheduleList" class="schedule-list"></div>
        </div>

        <div id="settingsView" class="hidden">
          <h2>Настройки тем</h2>
          <div id="themeControls"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Модалка создания анонса -->
  <div id="createStoryModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title">Создать анонс истории</h3>
        <button class="close-modal" id="closeCreateModal">×</button>
      </div>

      <div class="form-group">
        <label>Название *</label>
        <input type="text" id="storyTitle" placeholder="Введите название">
      </div>

      <div class="form-group">
        <label>Описание</label>
        <textarea id="storyDescription" placeholder="Краткое описание..."></textarea>
      </div>

      <div class="form-group">
        <label>Обложка</label>
        <div class="drop-zone" id="coverDropZone">Перетащите изображение или кликните</div>
        <input type="file" id="coverFile" accept="image/*" hidden>
        <div id="coverPreview" style="display:none; margin-top:10px;">
          <img id="coverPreviewImg" style="max-width:100%; border-radius:8px;">
        </div>
      </div>

      <div class="form-group">
        <label>Плановое количество эпизодов</label>
        <input type="number" id="plannedEpisodes" min="1" placeholder="Например: 12">
      </div>

      <div class="form-group">
        <label>Жанры</label>
        <div class="genres-container">
          <div class="checkbox-group"><input type="checkbox" value="fantasy"><label>Фэнтези</label></div>
          <div class="checkbox-group"><input type="checkbox" value="sci-fi"><label>Научная фантастика</label></div>
          <div class="checkbox-group"><input type="checkbox" value="horror"><label>Хоррор</label></div>
          <div class="checkbox-group"><input type="checkbox" value="romance"><label>Романтика</label></div>
          <div class="checkbox-group"><input type="checkbox" value="adventure"><label>Приключения</label></div>
          <div class="checkbox-group"><input type="checkbox" value="mystery"><label>Мистика</label></div>
        </div>
        <input type="text" id="customGenre" placeholder="Свой жанр (через запятую)" style="margin-top:10px;">
      </div>

      <div class="form-group">
        <label>Дата выхода первого эпизода</label>
        <input type="text" id="publishDateInput" placeholder="31.12.2025 | 12.2025 | 2026 | 2025-12-31T20:00">
        <div class="date-precision">
          • 31.12.2025 20:00 — точная дата и время<br>
          • 12.2025 — весь декабрь 2025<br>
          • 2026 — весь 2026 год<br>
          • пусто — просто "Анонс"
        </div>
      </div>

      <div style="display:flex; gap:10px; margin-top:20px;">
        <button class="btn-secondary" id="cancelCreate">Отмена</button>
        <button id="saveNewStory">Создать анонс</button>
      </div>
    </div>
  </div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyANC4K0-xI-9SvrpoiOp4v-N2XLvCQCALg",
      authDomain: "crawl-stories.firebaseapp.com",
      projectId: "crawl-stories",
      storageBucket: "crawl-stories.firebasestorage.app",
      messagingSenderId: "886479757650",
      appId: "1:886479757650:web:194ad1dd2d02c959bdda8b"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();
    const OFFICIAL_ADMIN_UID = "jKY1OmyNPphIgm2YFGTJyLwr0uC3";

    // ЖЁСТКАЯ ПРОВЕРКА АДМИНА
    auth.onAuthStateChanged(async (user) => {
      if (!user) {
        alert("Войди в аккаунт на главной странице");
        location.href = "/";
        return;
      }

      try {
        const adminDoc = await db.collection("admins").doc(user.uid).get();
        const isOfficial = user.uid === OFFICIAL_ADMIN_UID;

        if (!adminDoc.exists && !isOfficial) {
          alert("Доступ запрещён. Ты не администратор.");
          await auth.signOut();
          location.href = "/";
          return;
        }

        // АДМИН ВОШЁЛ — ПОКАЗЫВАЕМ ПАНЕЛЬ
        document.getElementById("authCheck").classList.add("hidden");
        document.getElementById("adminInterface").classList.remove("hidden");

        // Запускаем весь твой код
        window.adminPanel = new AdminPanel();
        loadEverything();

      } catch (err) {
        console.error(err);
        alert("Ошибка проверки доступа");
        location.href = "/";
      }
    });

    document.getElementById("logoutBtn").onclick = () => auth.signOut();

    // === ВСЁ НИЖЕ — ТВОЙ ОРИГИНАЛЬНЫЙ КОД БЕЗ ИЗМЕНЕНИЙ ===
    class AdminPanel {
      constructor() {
        this.db = db;
        this.stories = [];
        this.themeSystem = window.themesSystem || { updateDecorations: () => {} };
      }

      async loadStories() {
        try {
          const snapshot = await this.db.collection('stories').orderBy('createdAt', 'desc').get();
          this.stories = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
          this.renderStories();
        } catch (e) { console.error(e); }
      }

      renderStories() {
        const container = document.getElementById('storiesList');
        if (this.stories.length === 0) {
          container.innerHTML = `<div style="text-align:center;padding:60px;color:#999">Историй пока нет</div>`;
          return;
        }

        container.innerHTML = this.stories.map(story => `
          <div class="story-card" onclick="location.href='admin_config.html?story=${story.id}'">
            <div class="story-header">
              <h3 class="story-title">${story.title || "Без названия"}</h3>
              <div class="story-meta">
                <span class="badge announcement">Анонс</span>
              </div>
            </div>
            <p class="story-desc">${story.description || "Без описания"}</p>
            ${story.firstEpisodeDate ? `<div class="story-date">Старт: ${this.formatDate(story.firstEpisodeDate)}</div>` : ""}
          </div>
        `).join("");
      }

      formatDate(date) {
        if (!date) return "Без даты";
        if (typeof date === "string") return date;
        if (date.toDate) return date.toDate().toLocaleDateString("ru-RU");
        return date;
      }
    }

    function loadEverything() {
      window.adminPanel.loadStories();
      // Здесь будут темы, график и всё остальное — как у тебя было
    }

    // Открытие модалки создания
    document.getElementById("createStoryBtn").onclick = () => {
      document.getElementById("createStoryModal").classList.add("active");
    };

    document.getElementById("closeCreateModal").onclick = 
    document.getElementById("cancelCreate").onclick = () => {
      document.getElementById("createStoryModal").classList.remove("active");
    };

    // Drag & drop обложки
    const dropZone = document.getElementById("coverDropZone");
    const fileInput = document.getElementById("coverFile");
    dropZone.onclick = () => fileInput.click();
    fileInput.onchange = e => e.target.files[0] && previewCover(e.target.files[0]);
    dropZone.ondragover = e => { e.preventDefault(); dropZone.classList.add("active"); };
    dropZone.ondragleave = dropZone.ondrop = e => { e.preventDefault(); dropZone.classList.remove("active"); if (e.dataTransfer?.files[0]) previewCover(e.dataTransfer.files[0]); };

    function previewCover(file) {
      const reader = new FileReader();
      reader.onload = e => {
        document.getElementById("coverPreviewImg").src = e.target.result;
        document.getElementById("coverPreview").style.display = "block";
      };
      reader.readAsDataURL(file);
    }

    // Создание анонса с гибкой датой
    document.getElementById("saveNewStory").onclick = async () => {
      const title = document.getElementById("storyTitle").value.trim();
      if (!title) return alert("Название обязательно!");

      const genres = [];
      document.querySelectorAll('input[type="checkbox"]:checked').forEach(c => genres.push(c.value));
      const custom = document.getElementById("customGenre").value.trim();
      if (custom) genres.push(...custom.split(",").map(g => g.trim()).filter(g => g));

      const rawDate = document.getElementById("publishDateInput").value.trim();
      let firstEpisodeDate = null;
      if (rawDate) {
        if (rawDate.includes("T") || rawDate.match(/^\d{4}-\d{2}-\d{2}/)) {
          firstEpisodeDate = firebase.firestore.Timestamp.fromDate(new Date(rawDate));
        } else {
          const parts = rawDate.split(".").map(p => p.padStart(2, "0"));
          if (parts.length === 1) firstEpisodeDate = parts[0];
          else if (parts.length === 2) firstEpisodeDate = `${parts[0]}.${parts[1]}`;
          else if (parts.length === 3) firstEpisodeDate = `${parts[0]}.${parts[1]}.${parts[2]}`;
        }
      }

      const storyData = {
        title,
        description: document.getElementById("storyDescription").value.trim() || null,
        cover: document.getElementById("coverPreviewImg").src || null,
        plannedEpisodes: parseInt(document.getElementById("plannedEpisodes").value) || null,
        firstEpisodeDate,
        genres,
        status: "announcement",
        visibility: "visible",
        episodesCount: 0,
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      };

      try {
        await db.collection("stories").add(storyData);
        alert("Анонс успешно создан!");
        document.getElementById("createStoryModal").classList.remove("active");
        window.adminPanel.loadStories();
      } catch (e) {
        console.error(e);
        alert("Ошибка создания анонса");
      }
    };
  </script>

  <script src="themes-system.js"></script>
</body>
</html>
