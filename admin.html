<!doctype html>
<html lang="ru">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å CRAWL.STORIES</title>

    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-auth-compat.js"></script>

    <script>
      // Firebase –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
      const firebaseConfig = {
        apiKey: "AIzaSyANC4K0-xI-9SvrpoiOp4v-N2XLvCQCALg",
        authDomain: "crawl-stories.firebaseapp.com",
        projectId: "crawl-stories",
        storageBucket: "crawl-stories.firebasestorage.app",
        messagingSenderId: "886479757650",
        appId: "1:886479757650:web:194ad1dd2d02c959bdda8b",
        measurementId: "G-SGC2HF0455",
      };

      firebase.initializeApp(firebaseConfig);
      const db = firebase.firestore();
      console.log("üî• Firebase –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω –≤ –∞–¥–º–∏–Ω–∫–µ");
    </script>

    <style>
      /* CRAWL.STORIES - –ê–î–ú–ò–ù –ü–ê–ù–ï–õ–¨ –°–¢–ò–õ–ò */
      :root {
        --bg-primary: #020205;
        --bg-secondary: #0b0b0f;
        --bg-card: #0b0b0f;
        --accent-primary: #ffe81f;
        --accent-secondary: #6366f1;
        --text-primary: #ffffff;
        --text-secondary: #9aa0a6;
        --text-muted: #7f8c8d;
        --chat-bubble-user: #6366f1;
        --chat-bubble-other: #374151;
        --chat-bubble-system: #f59e0b;
        --chat-bubble-thought: #8b5cf6;
        --border-light: rgba(255, 255, 255, 0.1);
        --font-mono: "Courier New", monospace;
      }

      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }

      body {
        background: var(--bg-primary);
        color: var(--text-primary);
        font-family: var(--font-mono);
        min-height: 100vh;
      }

      /* LOGIN SCREEN */
      .login-screen {
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 20px;
      }

      .login-card {
        max-width: 400px;
        width: 100%;
        text-align: center;
      }

      .login-card h2 {
        color: var(--accent-primary);
        margin-bottom: 30px;
      }

      .form-group {
        margin-bottom: 20px;
        text-align: left;
      }

      .form-group label {
        display: block;
        margin-bottom: 8px;
        color: var(--text-secondary);
      }

      .form-group input,
      .form-group textarea,
      .form-group select {
        width: 100%;
        padding: 12px;
        border-radius: 8px;
        border: 1px solid var(--border-light);
        background: #05050a;
        color: #ddd;
        font-family: var(--font-mono);
        font-size: 14px;
      }

      .form-group textarea {
        resize: vertical;
        min-height: 100px;
      }

      .checkbox-group {
        display: flex;
        align-items: center;
        gap: 10px;
        margin: 15px 0;
      }

      .checkbox-group input[type="checkbox"] {
        width: 18px;
        height: 18px;
      }

      .checkbox-group label {
        margin: 0;
        color: var(--text-secondary);
      }

      /* BUTTONS */
      button {
        background: var(--accent-primary);
        color: var(--bg-primary);
        border: none;
        padding: 12px 24px;
        border-radius: 8px;
        cursor: pointer;
        font-family: var(--font-mono);
        font-weight: bold;
        transition: opacity 0.3s;
      }

      button:hover {
        opacity: 0.9;
      }
      button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }

      .btn-small {
        padding: 8px 16px;
        font-size: 12px;
      }
      .btn-secondary {
        background: transparent;
        color: var(--accent-primary);
        border: 1px solid var(--border-light);
      }
      .btn-danger {
        background: #ff4444;
        color: white;
      }
      .btn-success {
        background: #4caf50;
        color: white;
      }
      .btn-warning {
        background: #ff9800;
        color: white;
      }
      .btn-info {
        background: var(--accent-secondary);
        color: white;
      }

      /* ADMIN INTERFACE */
      .admin-interface {
        display: none;
        min-height: 100vh;
      }

      header {
        padding: 15px 20px;
        border-bottom: 1px solid var(--border-light);
        background: rgba(2, 2, 5, 0.95);
        position: sticky;
        top: 0;
        z-index: 100;
      }

      .header-content {
        display: flex;
        justify-content: space-between;
        align-items: center;
        max-width: 1200px;
        margin: 0 auto;
      }

      /* TABS */
      .tabs {
        display: flex;
        gap: 10px;
        margin: 20px auto;
        max-width: 1200px;
        padding: 0 20px;
        flex-wrap: wrap;
      }

      .tab {
        padding: 10px 20px;
        background: transparent;
        border: 1px solid var(--border-light);
        color: var(--text-secondary);
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.3s;
      }

      .tab.active {
        background: var(--accent-primary);
        color: var(--bg-primary);
      }

      .tab-content {
        display: none;
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
      }

      .tab-content.active {
        display: block;
      }

      /* STORIES GRID */
      .stories-grid {
        display: grid;
        gap: 20px;
        grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
      }

      .story-card {
        background: var(--bg-card);
        border-radius: 12px;
        padding: 20px;
        border: 1px solid var(--border-light);
        transition: border-color 0.3s;
      }

      .story-card:hover {
        border-color: rgba(255, 232, 31, 0.3);
      }

      .story-card.scheduled {
        border-color: #ffc107;
      }

      .story-card.soon {
        border-color: #9e9e9e;
      }

      .story-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 10px;
        gap: 10px;
      }

      .story-title {
        color: var(--accent-primary);
        font-size: 18px;
        margin: 0;
        line-height: 1.3;
        flex: 1;
      }

      .story-meta {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
      }

      /* BADGES */
      .badge {
        padding: 4px 8px;
        border-radius: 6px;
        font-size: 11px;
        white-space: nowrap;
        font-weight: bold;
      }

      .badge.category {
        background: rgba(100, 200, 255, 0.1);
        color: #64c8ff;
      }

      .badge.episode {
        background: rgba(255, 200, 100, 0.1);
        color: #ffc864;
      }

      .badge.status-published {
        background: rgba(76, 175, 80, 0.1);
        color: #4caf50;
      }

      .badge.status-scheduled {
        background: rgba(255, 193, 7, 0.1);
        color: #ffc107;
      }

      .badge.status-soon {
        background: rgba(158, 158, 158, 0.1);
        color: #9e9e9e;
      }

      .badge.status-hidden {
        background: rgba(158, 158, 158, 0.1);
        color: #9e9e9e;
        border: 1px dashed #9e9e9e;
      }

      .story-desc {
        color: var(--text-secondary);
        margin-bottom: 15px;
        font-size: 14px;
        line-height: 1.4;
      }

      .story-date {
        font-size: 12px;
        color: var(--text-muted);
        margin-top: 8px;
      }
      modal.innerHTML = ` .story-actions {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
        margin-top: 15px;
      }

      /* CONSTRUCTOR LAYOUT */
      .constructor-layout {
        display: grid;
        grid-template-columns: 300px 1fr 350px;
        gap: 20px;
        height: calc(100vh - 200px);
      }

      /* CHARACTERS PANEL */
      .characters-panel {
        background: var(--bg-card);
        border-radius: 12px;
        padding: 20px;
        border: 1px solid var(--border-light);
        overflow-y: auto;
      }

      .panel-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
      }

      .panel-title {
        color: var(--accent-primary);
        font-size: 18px;
      }

      .character-list {
        display: flex;
        flex-direction: column;
        gap: 10px;
      }

      .character-item {
        background: rgba(255, 255, 255, 0.05);
        padding: 15px;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.3s;
        border: 1px solid transparent;
      }

      .character-item.active {
        border-color: var(--accent-primary);
        background: rgba(255, 232, 31, 0.1);
      }

      .character-item:hover {
        border-color: var(--accent-secondary);
      }

      .character-header {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 8px;
      }

      .character-avatar {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        background: var(--accent-secondary);
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        color: white;
        flex-shrink: 0;
      }

      .character-name {
        font-weight: bold;
        color: var(--text-primary);
      }

      .character-role {
        font-size: 12px;
        color: var(--text-secondary);
      }

      /* CHAT PREVIEW */
      .chat-preview {
        background: #17212b;
        border-radius: 12px;
        border: 1px solid var(--border-light);
        display: flex;
        flex-direction: column;
        overflow: hidden;
      }

      .preview-header {
        background: #0e1621;
        padding: 15px 20px;
        border-bottom: 1px solid var(--border-light);
      }

      .preview-messages {
        flex: 1;
        padding: 20px;
        overflow-y: auto;
        display: flex;
        flex-direction: column;
        gap: 10px;
      }

      .message-preview {
        max-width: 70%;
        display: flex;
        flex-direction: column;
        animation: messageAppear 0.3s ease-out;
      }

      .message-preview.user {
        align-self: flex-end;
      }
      .message-preview.other {
        align-self: flex-start;
      }
      .message-preview.system {
        align-self: center;
        max-width: 90%;
      }
      .message-preview.thought {
        align-self: flex-end;
      }

      .message-bubble-preview {
        padding: 12px 16px;
        border-radius: 18px;
        word-wrap: break-word;
        line-height: 1.4;
        font-size: 14px;
      }

      .message-preview.user .message-bubble-preview {
        background: var(--chat-bubble-user);
        border-bottom-right-radius: 6px;
      }

      .message-preview.other .message-bubble-preview {
        background: var(--chat-bubble-other);
        border-bottom-left-radius: 6px;
      }

      .message-preview.system .message-bubble-preview {
        background: var(--chat-bubble-system);
        border-radius: 12px;
        text-align: center;
        font-style: italic;
      }

      .message-preview.thought .message-bubble-preview {
        background: var(--chat-bubble-thought);
        border: 1px dashed var(--accent-secondary);
        border-radius: 18px;
        font-style: italic;
      }

      /* MESSAGES EDITOR */
      .messages-editor {
        background: var(--bg-card);
        border-radius: 12px;
        padding: 20px;
        border: 1px solid var(--border-light);
        overflow-y: auto;
      }

      .message-list {
        display: flex;
        flex-direction: column;
        gap: 10px;
        margin-bottom: 20px;
      }

      .message-editor-item {
        background: rgba(255, 255, 255, 0.05);
        padding: 15px;
        border-radius: 8px;
        border: 1px solid transparent;
        cursor: grab;
        transition: all 0.3s;
      }

      .message-editor-item:hover {
        border-color: var(--accent-secondary);
      }

      .message-editor-item.dragging {
        opacity: 0.5;
        border: 2px dashed var(--accent-primary);
      }

      .message-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 8px;
      }

      .message-type-badge {
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 11px;
        font-weight: bold;
      }

      .badge-text {
        background: rgba(99, 102, 241, 0.2);
        color: var(--accent-secondary);
      }

      .badge-thought {
        background: rgba(139, 92, 246, 0.2);
        color: var(--chat-bubble-thought);
      }

      .badge-system {
        background: rgba(245, 158, 11, 0.2);
        color: var(--chat-bubble-system);
      }

      .message-actions {
        display: flex;
        gap: 5px;
      }

      .message-content-preview {
        font-size: 14px;
        color: var(--text-secondary);
        margin-bottom: 8px;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
      }

      .message-meta {
        display: flex;
        justify-content: space-between;
        font-size: 12px;
        color: var(--text-muted);
      }

      /* MESSAGE FORM */
      .message-form {
        background: rgba(255, 255, 255, 0.03);
        padding: 20px;
        border-radius: 8px;
        border: 1px solid var(--border-light);
      }

      .form-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 15px;
        margin-bottom: 15px;
      }

      .form-actions {
        display: flex;
        gap: 10px;
        margin-top: 20px;
        flex-wrap: wrap;
      }

      /* CHARACTER FORM */
      .character-form {
        background: rgba(255, 255, 255, 0.03);
        padding: 20px;
        border-radius: 8px;
        border: 1px solid var(--border-light);
        margin-top: 20px;
      }

      /* DROP ZONE */
      .drop-zone {
        border: 2px dashed var(--accent-primary);
        border-radius: 8px;
        padding: 20px;
        text-align: center;
        color: var(--text-secondary);
        margin: 10px 0;
        transition: all 0.3s;
      }

      .drop-zone.active {
        background: rgba(255, 232, 31, 0.1);
        border-color: var(--accent-primary);
      }

      /* SCHEDULE TIMELINE */
      .schedule-timeline {
        display: flex;
        flex-direction: column;
        gap: 10px;
      }

      .timeline-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
      }

      .timeline-item {
        background: var(--bg-card);
        border-radius: 12px;
        padding: 15px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        border: 1px solid var(--border-light);
        transition: border-color 0.3s;
      }

      .timeline-item:hover {
        border-color: rgba(255, 232, 31, 0.3);
      }

      .timeline-info {
        flex: 1;
      }

      .timeline-date {
        text-align: right;
        min-width: 150px;
      }

      .publish-date {
        color: var(--accent-primary);
        font-weight: bold;
        font-size: 14px;
      }

      .publish-status {
        font-size: 12px;
        color: var(--text-muted);
        margin-top: 4px;
      }

      /* ANIMATIONS */
      @keyframes messageAppear {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      /* RESPONSIVE */
      @media (max-width: 1024px) {
        .constructor-layout {
          grid-template-columns: 1fr;
          grid-template-rows: auto auto auto;
          height: auto;
        }

        .characters-panel,
        .messages-editor {
          max-height: 300px;
        }
      }

      @media (max-width: 768px) {
        .header-content {
          flex-direction: column;
          gap: 15px;
          text-align: center;
        }

        .tabs {
          flex-direction: column;
        }

        .stories-grid {
          grid-template-columns: 1fr;
        }

        .form-row {
          grid-template-columns: 1fr;
        }

        .form-actions {
          flex-direction: row;
          flex-wrap: wrap;
          gap: 8px;
          overflow-x: auto;
        }

        .form-actions button {
          flex-shrink: 0;
          min-width: 80px;
        }

        .story-header {
          flex-direction: column;
        }

        .story-meta {
          width: 100%;
          justify-content: flex-start;
          overflow-x: auto;
          flex-wrap: wrap;
        }

        .story-actions {
          justify-content: center;
        }

        .timeline-item {
          flex-direction: column;
          align-items: flex-start;
          gap: 10px;
        }

        .timeline-date {
          text-align: left;
          width: 100%;
        }

        #themeButtons {
          display: flex;
          flex-wrap: wrap;
          gap: 8px;
          overflow-x: auto;
        }

        #themeButtons button {
          flex-shrink: 0;
        }
      }

      /* LOADING STATES */
      .loading-state {
        text-align: center;
        padding: 40px;
        color: var(--text-secondary);
      }

      .loading-state .icon {
        font-size: 48px;
        margin-bottom: 20px;
      }

      /* EMPTY STATES */
      .empty-state {
        text-align: center;
        padding: 40px;
        color: var(--text-secondary);
      }

      .empty-state .icon {
        font-size: 48px;
        margin-bottom: 20px;
      }

      /* COLOR PICKER STYLES */
      .color-picker {
        margin-top: 10px;
      }

      .color-options {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        margin-bottom: 10px;
      }

      .color-option {
        width: 30px;
        height: 30px;
        border-radius: 50%;
        cursor: pointer;
        border: 2px solid transparent;
        transition: all 0.3s ease;
        position: relative;
      }

      .color-option:hover {
        transform: scale(1.1);
        border-color: var(--text-primary);
      }

      .color-option.selected {
        border-color: var(--accent-primary);
        transform: scale(1.1);
        box-shadow:
          0 0 0 2px var(--bg-primary),
          0 0 0 4px var(--accent-primary);
      }

      .color-option.selected::after {
        content: "‚úì";
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        color: white;
        font-size: 14px;
        font-weight: bold;
        text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
      }

      /* –î–ª—è —Å–≤–µ—Ç–ª—ã—Ö —Ü–≤–µ—Ç–æ–≤ –º–µ–Ω—è–µ–º —Ü–≤–µ—Ç –≥–∞–ª–æ—á–∫–∏ */
      .color-option[data-color="#FFE81F"].selected::after,
      .color-option[data-color="#8bc34a"].selected::after {
        color: var(--bg-primary);
      }
      /* Seasonal theme variables and helpers */
      .theme-newyear {
        --theme-accent: #aee0ff;
      }
      .theme-halloween {
        --theme-accent: #ff8c00;
      }
      .theme-valentine {
        --theme-accent: #ff9bb3;
      }
      .theme-fear {
        --theme-accent: #ff4d4d;
      }

      /* Effects container */
      #seasonal-effects {
        pointer-events: none;
        position: fixed;
        inset: 0;
        z-index: 9999;
      }
      #seasonal-effects .effect-item {
        position: absolute;
        will-change: transform, opacity;
      }
      /* Snow */
      .snowflake {
        position: absolute;
        top: -10px;
        color: white;
        opacity: 0.9;
        font-size: 10px;
        animation: fall linear infinite;
      }
      @keyframes fall {
        to {
          transform: translateY(110vh) rotate(360deg);
        }
      }
      /* Hearts */
      .heart {
        position: absolute;
        font-size: 18px;
        color: #ff6b9a;
        opacity: 0.9;
        animation: floatUp 6s linear infinite;
      }
      @keyframes floatUp {
        to {
          transform: translateY(-120vh);
          opacity: 0;
        }
      }
      /* Fog overlay */
      .fog-overlay {
        position: absolute;
        left: 0;
        right: 0;
        bottom: 0;
        height: 30%;
        background: linear-gradient(transparent, rgba(0, 0, 0, 0.35));
        opacity: 0.6;
        filter: blur(8px);
      }
      /* Minimal decorative icons */
      .corner-icon {
        position: absolute;
        width: 28px;
        height: 28px;
        opacity: 0.9;
      }
      /* Small pumpkins */
      .pumpkin {
        width: 18px;
        height: 18px;
      }
      /* bats */
      .bat {
        width: 20px;
        height: 12px;
        transform-origin: center;
      }
      /* quick disable button style */
      .theme-control-btn {
        margin-left: 8px;
        padding: 6px 10px;
        font-size: 13px;
      }
    </style>
  </head>
  <body>
    <div id="loginScreen" class="login-screen">
      <div class="login-card">
        <h2>üîê –í—Ö–æ–¥ –≤ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</h2>
        <form id="loginForm">
          <div class="form-group">
            <label>–ü–∞—Ä–æ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞</label>
            <input type="password" id="adminPassword" required />
          </div>
          <button type="submit">–í–æ–π—Ç–∏ –≤ –∞–¥–º–∏–Ω–∫—É</button>
        </form>
      </div>
    </div>

    <div id="adminInterface" class="admin-interface">
      <header>
        <div class="header-content">
          <h1>‚öôÔ∏è –ê–î–ú–ò–ù-–ü–ê–ù–ï–õ–¨ CRAWL.STORIES</h1>
          <div style="display: flex; align-items: center; gap: 8px">
            <label style="font-size: 13px; margin-right: 6px">–¢–µ–º–∞:</label>
            <select
              id="themeSelect"
              style="
                background: transparent;
                border: 1px solid var(--border-light);
                color: var(--text-primary);
                padding: 6px;
                border-radius: 6px;
              "
            >
              <option value="none">–ü–æ —É–º–æ–ª—á–∞–Ω–∏—é</option>
              <option value="newyear">–ù–æ–≤—ã–π –≥–æ–¥</option>
              <option value="halloween">–•—ç–ª–ª–æ—É–∏–Ω</option>
              <option value="valentine">–î–µ–Ω—å –≤–ª—é–±–ª—ë–Ω–Ω—ã—Ö</option>
              <option value="fear">Fear week</option>
            </select>
            <label style="font-size: 13px; margin-left: 6px"
              ><input type="checkbox" id="themeAuto" /> –ê–≤—Ç–æ</label
            >
            <button id="btnApplyTheme" class="theme-control-btn">
              –ü—Ä–∏–º–µ–Ω–∏—Ç—å
            </button>
            <button id="btnSaveTheme" class="theme-control-btn">
              –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
            </button>
            <button id="btnClearTheme" class="theme-control-btn">–°–±—Ä–æ—Å</button>
            <!-- Theme tuning -->
            <label
              style="
                font-size: 13px;
                margin-left: 8px;
                display: flex;
                align-items: center;
                gap: 6px;
              "
              >–í–∫–ª:<input type="checkbox" id="themeEnabled"
            /></label>
            <label
              style="
                font-size: 13px;
                display: flex;
                align-items: center;
                gap: 6px;
              "
              >–ß–∞—Å—Ç–æ—Ç–∞:<input
                id="themeFrequency"
                type="range"
                min="1"
                max="10"
                value="1"
                style="width: 80px"
            /></label>
            <label
              style="
                font-size: 13px;
                display: flex;
                align-items: center;
                gap: 6px;
              "
              >–ò–Ω—Ç–µ–Ω—Å.:<input
                id="themeIntensity"
                type="range"
                min="0"
                max="100"
                value="50"
                style="width: 100px"
            /></label>
            <!-- Fear week quick controls -->
            <div
              id="fearControls"
              style="
                display: flex;
                align-items: center;
                gap: 6px;
                margin-left: 6px;
              "
            >
              <input
                id="fearDays"
                type="number"
                min="1"
                max="30"
                value="7"
                style="
                  width: 64px;
                  padding: 6px;
                  border-radius: 6px;
                  background: transparent;
                  border: 1px solid var(--border-light);
                  color: var(--text-primary);
                "
              />
              <button id="btnStartFear" class="theme-control-btn">
                –ó–∞–ø—É—Å—Ç–∏—Ç—å Fear
              </button>
              <button id="btnStopFear" class="theme-control-btn">
                –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å
              </button>
            </div>
            <!-- Auth -->
            <div
              id="authBlock"
              style="
                display: flex;
                align-items: center;
                gap: 6px;
                margin-left: 8px;
              "
            >
              <span
                id="adminUserInfo"
                style="font-size: 13px; color: var(--text-secondary)"
              ></span>
              <button id="btnSignInAuth" class="btn btn-secondary btn-small">
                –í–æ–π—Ç–∏ (Auth)
              </button>
              <button
                id="btnSignOutAuth"
                class="btn btn-secondary btn-small"
                style="display: none"
              >
                –í—ã–π—Ç–∏
              </button>
            </div>
            <div style="margin-left: 12px; display: flex; gap: 8px">
              <button id="btnRefresh" class="btn btn-secondary">
                üîÑ –û–±–Ω–æ–≤–∏—Ç—å
              </button>
              <button id="btnLogout" class="btn btn-secondary">üö™ –í—ã–π—Ç–∏</button>
              <button id="btnBackToSite" class="btn">üåê –ù–∞ —Å–∞–π—Ç</button>
            </div>
          </div>
        </div>
      </header>

      <div class="tabs">
        <button class="tab active" data-tab="stories">üìö –í—Å–µ –∏—Å—Ç–æ—Ä–∏–∏</button>
        <button class="tab" data-tab="constructor">
          üõ†Ô∏è –ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä –∏—Å—Ç–æ—Ä–∏–π
        </button>
        <button class="tab" data-tab="schedule">üìÖ –ì—Ä–∞—Ñ–∏–∫ –ø—É–±–ª–∏–∫–∞—Ü–∏–π</button>
        <button class="tab" data-tab="new-story">‚ûï –ù–æ–≤–∞—è –∏—Å—Ç–æ—Ä–∏—è</button>
        <button class="tab" data-tab="import">üì• –ò–º–ø–æ—Ä—Ç</button> 
      </div>

      <div id="storiesTab" class="tab-content active">
        <div style="text-align: center; margin-bottom: 30px">
          <button
            class="btn btn-success"
            id="btnQuickCreate"
            style="font-size: 16px; padding: 15px 30px"
          >
            üöÄ –ë—ã—Å—Ç—Ä–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–∏
          </button>
        </div>
        <div id="storiesList" class="stories-grid">
          <div class="loading-state">
            <div class="icon">‚è≥</div>
            <p>–ó–∞–≥—Ä—É–∑–∫–∞ –∏—Å—Ç–æ—Ä–∏–π...</p>
          </div>
        </div>
      </div>

      <div id="constructorTab" class="tab-content">
        <div class="constructor-layout">
          <div class="characters-panel">
            <!-- EPISODES PANEL -->
            <div class="panel-header">
              <h3 class="panel-title">üìñ –≠–ø–∏–∑–æ–¥—ã</h3>
              <button class="btn btn-success btn-small" id="btnAddEpisode">
                + –≠–ø–∏–∑–æ–¥
              </button>
              <button class="btn btn-info btn-small" id="btnImportEpisode" style="margin-left: 4px;">
                üì• –ò–º–ø–æ—Ä—Ç —Ñ–∞–π–ª–∞
              </button>
            </div>
            <div id="episodesList" style="margin-bottom: 16px">
              <div class="empty-state">
                <div class="icon">üìö</div>
                <p>–≠–ø–∏–∑–æ–¥—ã –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç. –î–æ–±–∞–≤—å—Ç–µ –ø–µ—Ä–≤—ã–π —ç–ø–∏–∑–æ–¥.</p>
              </div>
            </div>
            <div class="panel-header">
              <h3 class="panel-title">üë• –ü–µ—Ä—Å–æ–Ω–∞–∂–∏</h3>
              <button class="btn btn-success btn-small" id="btnAddCharacter">
                + –î–æ–±–∞–≤–∏—Ç—å
              </button>
            </div>
            <div class="character-list" id="characterList">
              <div class="empty-state">
                <div class="icon">üë•</div>
                <p>–í—ã–±–µ—Ä–∏—Ç–µ –∏—Å—Ç–æ—Ä–∏—é –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è</p>
              </div>
            </div>

            <!-- –§–æ—Ä–º–∞ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞ -->
            <div
              class="character-form"
              id="characterForm"
              style="display: none"
            >
              <div class="form-group">
                <label>–ò–º—è –ø–µ—Ä—Å–æ–Ω–∞–∂–∞</label>
                <input type="text" id="characterName" required />
              </div>
              <div class="form-group">
                <label>–û–ø–∏—Å–∞–Ω–∏–µ/—Ä–æ–ª—å</label>
                <textarea id="characterBio" rows="3"></textarea>
              </div>
              <div class="form-group">
                <label>–¶–≤–µ—Ç –∞–≤–∞—Ç–∞—Ä–∞</label>
                <div class="color-picker">
                  <div class="color-options">
                    <div
                      class="color-option selected"
                      data-color="#6366f1"
                      style="background-color: #6366f1"
                    ></div>
                    <div
                      class="color-option"
                      data-color="#FFE81F"
                      style="background-color: #ffe81f"
                    ></div>
                    <div
                      class="color-option"
                      data-color="#4caf50"
                      style="background-color: #4caf50"
                    ></div>
                    <div
                      class="color-option"
                      data-color="#ff9800"
                      style="background-color: #ff9800"
                    ></div>
                    <div
                      class="color-option"
                      data-color="#e91e63"
                      style="background-color: #e91e63"
                    ></div>
                    <div
                      class="color-option"
                      data-color="#9c27b0"
                      style="background-color: #9c27b0"
                    ></div>
                    <div
                      class="color-option"
                      data-color="#00bcd4"
                      style="background-color: #00bcd4"
                    ></div>
                    <div
                      class="color-option"
                      data-color="#8bc34a"
                      style="background-color: #8bc34a"
                    ></div>
                    <!-- custom swatch for arbitrary colors -->
                    <div
                      class="color-option custom"
                      data-color="#000000"
                      style="background-color: #000000; display: none"
                    ></div>
                  </div>
                  <input type="hidden" id="characterColor" value="#6366f1" />
                  <input
                    type="color"
                    id="characterColorPicker"
                    value="#6366f1"
                    title="–í—ã–±—Ä–∞—Ç—å —Ü–≤–µ—Ç"
                    style="margin-left: 10px; vertical-align: middle"
                  />
                </div>
              </div>
              <div class="form-actions">
                <button type="button" class="btn" id="btnSaveCharacter">
                  üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
                </button>
                <button
                  type="button"
                  class="btn btn-secondary"
                  id="btnCancelCharacter"
                >
                  ‚ùå –û—Ç–º–µ–Ω–∞
                </button>
                <button
                  type="button"
                  class="btn btn-danger"
                  id="btnDeleteCharacter"
                >
                  üóëÔ∏è –£–¥–∞–ª–∏—Ç—å
                </button>
              </div>
            </div>
          </div>

          <div class="chat-preview">
            <div class="preview-header">
              <h3>üí¨ –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä —á–∞—Ç–∞</h3>
            </div>
            <div class="preview-messages" id="previewMessages">
              <div class="message-preview system">
                <div class="message-bubble-preview">
                  –í—ã–±–µ—Ä–∏—Ç–µ –∏—Å—Ç–æ—Ä–∏—é –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
                </div>
              </div>
            </div>
          </div>

          <div class="messages-editor">
            <div class="panel-header">
              <h3 class="panel-title">üí≠ –°–æ–æ–±—â–µ–Ω–∏—è</h3>
              <button class="btn btn-info btn-small" id="btnAddMessage">
                + –°–æ–æ–±—â–µ–Ω–∏–µ
              </button>
            </div>

            <div class="message-list" id="messageList">
              <div class="empty-state">
                <div class="icon">üí≠</div>
                <p>–í—ã–±–µ—Ä–∏—Ç–µ –∏—Å—Ç–æ—Ä–∏—é –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è</p>
              </div>
            </div>

            <div class="message-form" id="messageForm" style="display: none">
              <div class="form-row">
                <div class="form-group">
                  <label>–¢–∏–ø —Å–æ–æ–±—â–µ–Ω–∏—è</label>
                  <select id="messageType">
                    <option value="text">üí¨ –¢–µ–∫—Å—Ç</option>
                    <option value="thought">ü§î –ú—ã—Å–ª—å</option>
                    <option value="system">‚öôÔ∏è –°–∏—Å—Ç–µ–º–Ω–æ–µ</option>
                  </select>
                </div>
                <div class="form-group">
                  <label>–ü–µ—Ä—Å–æ–Ω–∞–∂</label>
                  <select id="messageCharacter">
                    <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞</option>
                  </select>
                </div>
              </div>

              <div class="form-group">
                <label>–¢–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è</label>
                <textarea
                  id="messageContent"
                  rows="4"
                  placeholder="–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è..."
                ></textarea>
              </div>

              <div class="form-row">
                <div class="form-group">
                  <label>–ó–∞–¥–µ—Ä–∂–∫–∞ (–º—Å)</label>
                  <input
                    type="number"
                    id="messageDelay"
                    value="2000"
                    min="0"
                    step="500"
                  />
                </div>
                <div class="form-group">
                  <label>–ü–æ—Ä—è–¥–æ–∫</label>
                  <input type="number" id="messageOrder" min="1" value="1" />
                </div>
              </div>

              <div class="form-actions">
                <button type="button" class="btn" id="btnSaveMessage">
                  üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
                </button>
                <button
                  type="button"
                  class="btn btn-secondary"
                  id="btnCancelMessage"
                >
                  ‚ùå –û—Ç–º–µ–Ω–∞
                </button>
                <button
                  type="button"
                  class="btn btn-danger"
                  id="btnDeleteMessage"
                >
                  üóëÔ∏è –£–¥–∞–ª–∏—Ç—å
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div id="scheduleTab" class="tab-content">
        <div class="timeline-header">
          <h3>üìÖ –ó–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏</h3>
          <button id="btnClearSchedule" class="btn btn-warning">
            üßπ –û—á–∏—Å—Ç–∏—Ç—å –≥—Ä–∞—Ñ–∏–∫
          </button>
        </div>
        <div id="scheduleList" class="schedule-timeline">
          <div class="empty-state">
            <div class="icon">üìÖ</div>
            <p>–ù–µ—Ç –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –ø—É–±–ª–∏–∫–∞—Ü–∏–π</p>
          </div>
        </div>
      </div>

      <div id="importTab" class="tab-content">
        <div style="max-width: 900px; margin: 0 auto;">
          <h3>üì• –ò–º–ø–æ—Ä—Ç —Ü–µ–ª–æ–π –∏—Å—Ç–æ—Ä–∏–∏</h3>

          <!-- –î–∞–Ω–Ω—ã–µ –∏—Å—Ç–æ—Ä–∏–∏ -->
          <div class="form-group">
            <label>–ù–∞–∑–≤–∞–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–∏</label>
            <input type="text" id="bulkImportTitle" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –Ω–æ–≤–æ–π –∏—Å—Ç–æ—Ä–∏–∏" required>
          </div>

          <div class="form-group">
            <label>–û–ø–∏—Å–∞–Ω–∏–µ</label>
            <textarea id="bulkImportDescription" rows="3" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–∏..."></textarea>
          </div>

          <div class="form-group">
            <label>–ö–∞—Ç–µ–≥–æ—Ä–∏—è</label>
            <select id="bulkImportCategory">
              <option value="fantasy">üßô –§—ç–Ω—Ç–µ–∑–∏</option>
              <option value="sci-fi">üöÄ –ù–∞—É—á–Ω–∞—è —Ñ–∞–Ω—Ç–∞—Å—Ç–∏–∫–∞</option>
              <option value="horror">üëª –•–æ—Ä—Ä–æ—Ä</option>
              <option value="adventure">üó∫Ô∏è –ü—Ä–∏–∫–ª—é—á–µ–Ω–∏—è</option>
              <option value="mystery">üïµÔ∏è –ú–∏—Å—Ç–∏–∫–∞</option>
            </select>
          </div>

          <!-- –ë–ª–æ–∫–∏ —ç–ø–∏–∑–æ–¥–æ–≤ -->
          <div class="form-group">
            <label>–≠–ø–∏–∑–æ–¥—ã –¥–ª—è –∏–º–ø–æ—Ä—Ç–∞:</label>
            <div id="bulkEpisodeBlocks" style="border: 1px solid var(--border-light); padding: 15px; border-radius: 4px; background: var(--bg-primary);">
              <div style="color: var(--text-secondary); text-align: center; padding: 20px;">
                üìö –ù–∞–∂–º–∏ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ, —á—Ç–æ–±—ã –¥–æ–±–∞–≤–∏—Ç—å –ø–µ—Ä–≤—ã–π —ç–ø–∏–∑–æ–¥
              </div>
            </div>
            <button class="btn btn-secondary btn-small" id="btnAddBulkEpisode" style="margin-top: 8px;">
              ‚ûï –î–æ–±–∞–≤–∏—Ç—å —ç–ø–∏–∑–æ–¥
            </button>
          </div>

          <!-- –ü—Ä–µ–≤—å—é –∏ –∑–∞–≥—Ä—É–∑–∫–∞ -->
          <div class="form-actions">
            <button class="btn btn-info" id="btnPreviewBulkImport">üëÅÔ∏è –ü—Ä–µ–≤—å—é –≤—Å–µ—Ö —ç–ø–∏–∑–æ–¥–æ–≤</button>
            <button class="btn btn-success" id="btnConfirmBulkImport">‚úÖ –°–æ–∑–¥–∞—Ç—å –∏—Å—Ç–æ—Ä–∏—é –∏ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
            <button class="btn btn-secondary" id="btnCancelBulkImport">‚ùå –û—Ç–º–µ–Ω–∞</button>
          </div>

          <!-- –ü—Ä–µ–≤—å—é -->
          <div id="bulkImportPreview" style="margin-top: 20px; display: none;">
            <h4>–ü—Ä–µ–≤—å—é –∏—Å—Ç–æ—Ä–∏–∏ –∏ —ç–ø–∏–∑–æ–¥–æ–≤:</h4>
            <div id="bulkPreviewContent" style="border: 1px solid var(--border-light); border-radius: 8px; padding: 10px; max-height: 500px; overflow-y: auto; background: var(--bg-secondary);"></div>
          </div>
        </div>
      </div>

      <div id="episodeImportTab" class="tab-content" style="display: none;">
        <div style="max-width: 900px; margin: 0 auto;">
          <h3>üì• –ò–º–ø–æ—Ä—Ç —ç–ø–∏–∑–æ–¥–∞ –≤ –∏—Å—Ç–æ—Ä–∏—é</h3>
          <p style="color: var(--text-secondary);">–û—Ç–∫—Ä–æ–π—Ç–µ –∏—Å—Ç–æ—Ä–∏—é –≤ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä–µ –∏ –Ω–∞–∂–º–∏—Ç–µ "üì• –ò–º–ø–æ—Ä—Ç —Ñ–∞–π–ª–∞"</p>

          <div class="form-group">
            <label>1Ô∏è‚É£ –í—ã–±–µ—Ä–∏ —Ñ–æ—Ä–º–∞—Ç —Ñ–∞–π–ª–∞:</label>
            <select id="episodeImportFormat" style="width: 200px;">
              <option value="txt">üìÑ TXT (—Å —Ç–µ–≥–∞–º–∏)</option>
              <option value="json">üì¶ JSON (—Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π)</option>
              <option value="python">üêç Python (—Å—Ü–µ–Ω–∞—Ä–∏–π)</option>
            </select>
          </div>

          <div class="form-group">
            <label>2Ô∏è‚É£ –ó–∞–≥—Ä—É–∑–∏ —Ñ–∞–π–ª:</label>
            <input type="file" id="episodeImportFile" accept=".txt,.json,.py">
          </div>

          <div class="form-group">
            <label>–ò–ª–∏ –≤—Å—Ç–∞–≤—å —Ç–µ–∫—Å—Ç:</label>
            <textarea id="episodeImportText" rows="10" placeholder="–í—Å—Ç–∞–≤—å —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ —Ñ–∞–π–ª–∞..." style="width: 100%; font-family: monospace; font-size: 12px;"></textarea>
          </div>

          <div class="form-actions">
            <button class="btn btn-info" id="btnPreviewEpisodeImport">üëÅÔ∏è –ü—Ä–µ–≤—å—é</button>
            <button class="btn btn-success" id="btnConfirmEpisodeImport">‚úÖ –ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –≤ —ç–ø–∏–∑–æ–¥</button>
            <button class="btn btn-secondary" id="btnCancelEpisodeImport">‚ùå –û—Ç–º–µ–Ω–∞</button>
          </div>

          <div id="episodeImportPreview" style="margin-top: 20px; display: none;">
            <h4>–ü—Ä–µ–≤—å—é —Å–æ–æ–±—â–µ–Ω–∏–π:</h4>
            <div id="episodePreviewMessages" style="border: 1px solid var(--border-light); border-radius: 8px; padding: 10px; max-height: 400px; overflow-y: auto; background: var(--bg-secondary);"></div>
            <div id="episodeImportCharacters" style="margin-top: 10px; padding: 10px; background: var(--bg-card); border-radius: 8px;"></div>
          </div>
        </div>
      </div>

      <div id="newStoryTab" class="tab-content">
        <div class="character-form">
          <h3>‚ûï –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é –∏—Å—Ç–æ—Ä–∏—é</h3>
          <div class="form-group">
            <label>–ù–∞–∑–≤–∞–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–∏</label>
            <input
              type="text"
              id="newStoryTitle"
              placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–∏"
              required
            />
          </div>
          <div class="form-group">
            <label>–û–ø–∏—Å–∞–Ω–∏–µ</label>
            <textarea
              id="newStoryDescription"
              rows="4"
              placeholder="–ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ —Å—é–∂–µ—Ç–∞..."
            ></textarea>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>–ö–∞—Ç–µ–≥–æ—Ä–∏—è</label>
              <select id="newStoryCategory">
                <option value="fantasy">üßô –§—ç–Ω—Ç–µ–∑–∏</option>
                <option value="sci-fi">üöÄ –ù–∞—É—á–Ω–∞—è —Ñ–∞–Ω—Ç–∞—Å—Ç–∏–∫–∞</option>
                <option value="horror">üëª –•–æ—Ä—Ä–æ—Ä</option>
                <option value="adventure">üó∫Ô∏è –ü—Ä–∏–∫–ª—é—á–µ–Ω–∏—è</option>
                <option value="mystery">üïµÔ∏è –ú–∏—Å—Ç–∏–∫–∞</option>
                <option value="chat">üí¨ –ß–∞—Ç-–∏—Å—Ç–æ—Ä–∏–∏</option>
              </select>
            </div>
            <div class="form-group">
              <label>–ü–ª–∞–Ω–∏—Ä—É–µ–º—ã—Ö —ç–ø–∏–∑–æ–¥–æ–≤</label>
              <input
                type="number"
                id="newStoryPlannedEpisodes"
                min="1"
                value="10"
              />
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>–°—Ç–∞—Ç—É—Å –∏—Å—Ç–æ—Ä–∏–∏</label>
              <select id="newStoryStatus">
                <option value="announced">üîí –ê–Ω–æ–Ω—Å</option>
                <option value="new">üÜï –ù–æ–≤–∏–Ω–∫–∞</option>
                <option value="ongoing">üìñ –ü—Ä–æ–¥–æ–ª–∂–∞–µ—Ç—Å—è</option>
                <option value="finished">‚úÖ –ó–∞–≤–µ—Ä—à–µ–Ω–∞</option>
                <option value="abandoned">üíî –ë—Ä–æ—à–µ–Ω–∞</option>
              </select>
            </div>
            <div class="form-group">
              <label>–í–∏–¥–∏–º–æ—Å—Ç—å</label>
              <select id="newStoryVisibility">
                <option value="public">üëÅÔ∏è –û–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–∞</option>
                <option value="closed">üîê –ó–∞–∫—Ä—ã—Ç–∞ (—Ç–æ–ª—å–∫–æ –∞–Ω–æ–Ω—Å)</option>
                <option value="hidden">üëª –°–∫—Ä—ã—Ç–∞ (—Ç–æ–ª—å–∫–æ –∞–¥–º–∏–Ω)</option>
              </select>
            </div>
          </div>
          <div class="form-group">
            <label>–î–∞—Ç–∞ –≤—ã—Ö–æ–¥–∞ –ø–µ—Ä–≤–æ–≥–æ —ç–ø–∏–∑–æ–¥–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</label>
            <input type="date" id="newStoryFirstEpisodeDate" />
          </div>
          <div class="form-actions">
            <button type="button" class="btn btn-success" id="btnCreateStory">
              üöÄ –°–æ–∑–¥–∞—Ç—å –∏—Å—Ç–æ—Ä–∏—é
            </button>
          </div>
        </div>
      </div>
    </div>

    <script>
      class AdminPanel {
        constructor() {
          this.stories = [];
          this.currentStory = null;
          this.characters = [];
          this.messages = [];
          this.currentEditingMessage = null;
          this.currentEditingCharacter = null;
          this.draggedMessage = null;
          this.importedMessages = [];
          this.importedCharacters = [];

          this.adminPassword = "1111";
          this.currentFilter = "all";

          this.init();
        }

        async init() {
          this.setupEventListeners();
          this.showLoginScreen();
          this.initDragAndDrop();
          this.initTheme();
          this.initAuth();
          this.startAutoPublishScheduler();
          this.startRealtimeListeners();
        }

        showLoginScreen() {
          document.getElementById("loginScreen").style.display = "flex";
          document.getElementById("adminInterface").style.display = "none";
        }

        showAdminInterface() {
          document.getElementById("loginScreen").style.display = "none";
          document.getElementById("adminInterface").style.display = "block";
          this.loadData();
        }

        setupEventListeners() {
          // –õ–æ–≥–∏–Ω
          document
            .getElementById("loginForm")
            .addEventListener("submit", (e) => {
              e.preventDefault();
              this.handleLogin();
            });

          // –ù–∞–≤–∏–≥–∞—Ü–∏—è
          document
            .getElementById("btnBackToSite")
            .addEventListener("click", () => {
              window.open("index.html", "_self");
            });

          document.getElementById("btnLogout").addEventListener("click", () => {
            this.showLoginScreen();
          });

          document
            .getElementById("btnRefresh")
            .addEventListener("click", () => {
              this.loadData();
            });

          // –≠–ø–∏–∑–æ–¥—ã
          document
            .getElementById("btnAddEpisode")
            ?.addEventListener("click", () => {
              this.createEpisode();
            });

          // –¢–∞–±—ã
          document.querySelectorAll(".tab").forEach((tab) => {
            tab.addEventListener("click", (e) => {
              this.switchTab(e.target.dataset.tab);
            });
          });

          // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏—è–º–∏
          document
            .getElementById("btnCreateStory")
            .addEventListener("click", () => {
              this.createNewStory();
            });
          // –ë—ã—Å—Ç—Ä–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–∏
          document
            .getElementById("btnQuickCreate")
            ?.addEventListener("click", () => {
              this.quickCreateStory();
            });

          // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞–º–∏
          document
            .getElementById("btnAddCharacter")
            .addEventListener("click", () => {
              this.showCharacterForm();
            });

          document
            .getElementById("btnSaveCharacter")
            .addEventListener("click", () => {
              this.saveCharacter();
            });

          document
            .getElementById("btnCancelCharacter")
            .addEventListener("click", () => {
              this.hideCharacterForm();
            });

          document
            .getElementById("btnDeleteCharacter")
            .addEventListener("click", () => {
              this.deleteCharacter();
            });

          // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏
          document
            .getElementById("btnAddMessage")
            .addEventListener("click", () => {
              this.showMessageForm();
            });

          document
            .getElementById("btnSaveMessage")
            .addEventListener("click", () => {
              this.saveMessage();
            });

          // –ò–ú–ü–û–†–¢ –í –ö–û–ù–°–¢–†–£–ö–¢–û–†–ï
          document.getElementById('btnImportEpisode')?.addEventListener('click', () => {
            this.showConstructorImportModal();
          });
          
          document
            .getElementById("btnCancelMessage")
            .addEventListener("click", () => {
              this.hideMessageForm();
            });

          document
            .getElementById("btnDeleteMessage")
            .addEventListener("click", () => {
              this.deleteMessage();
            });

          // –ò–ú–ü–û–†–¢ –≠–ü–ò–ó–û–î–û–í
          document.getElementById('importFile')?.addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;
            const text = await file.text();
            document.getElementById('importText').value = text;
          });

          document.getElementById('btnPreviewImport')?.addEventListener('click', () => {
            this.previewImport();
          });

          document.getElementById('btnImportMessages')?.addEventListener('click', () => {
            this.confirmImport();
          });

          document.getElementById('btnAddEpisodeSlot')?.addEventListener('click', () => {
            this.addEpisodeSlot();
          });
          
          document.getElementById('btnCancelImport')?.addEventListener('click', () => {
            document.getElementById('importPreview').style.display = 'none';
            document.getElementById('importText').value = '';
            this.importedMessages = [];
            this.importedCharacters = [];
          });


          // ===== –ò–ú–ü–û–†–¢ –¶–ï–õ–û–ô –ò–°–¢–û–†–ò–ò - –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò =====
          document.getElementById('btnAddBulkEpisode')?.addEventListener('click', () => {
            this.addBulkEpisodeBlock();
          });

          document.getElementById('btnPreviewBulkImport')?.addEventListener('click', () => {
            this.previewBulkImport();
          });

          document.getElementById('btnConfirmBulkImport')?.addEventListener('click', () => {
            this.confirmBulkImport();
          });

          document.getElementById('btnCancelBulkImport')?.addEventListener('click', () => {
            document.getElementById('bulkImportTitle').value = '';
            document.getElementById('bulkImportDescription').value = '';
            document.getElementById('bulkEpisodeBlocks').innerHTML = '<div style="color: var(--text-secondary); text-align: center; padding: 20px;">üìö –ù–∞–∂–º–∏ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ, —á—Ç–æ–±—ã –¥–æ–±–∞–≤–∏—Ç—å –ø–µ—Ä–≤—ã–π —ç–ø–∏–∑–æ–¥</div>';
            document.getElementById('bulkImportPreview').style.display = 'none';
          });

          // ===== –ò–ú–ü–û–†–¢ –≠–ü–ò–ó–û–î–ê –í –ò–°–¢–û–†–ò–Æ - –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò =====
          document.getElementById('episodeImportFile')?.addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;
            const text = await file.text();
            document.getElementById('episodeImportText').value = text;
          });

          document.getElementById('btnPreviewEpisodeImport')?.addEventListener('click', () => {
            this.previewEpisodeImport();
          });

          document.getElementById('btnConfirmEpisodeImport')?.addEventListener('click', () => {
            this.confirmEpisodeImport();
          });

          document.getElementById('btnCancelEpisodeImport')?.addEventListener('click', () => {
            document.getElementById('episodeImportText').value = '';
            document.getElementById('episodeImportPreview').style.display = 'none';
            this.episodeImportMessages = [];
          });

          // –ì—Ä–∞—Ñ–∏–∫ –ø—É–±–ª–∏–∫–∞—Ü–∏–π
          document
            .getElementById("btnClearSchedule")
            .addEventListener("click", () => {
              this.clearSchedule();
            });

          // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –≤—ã–±–æ—Ä–∞ —Ü–≤–µ—Ç–∞
          document.addEventListener("click", (e) => {
            if (e.target.classList.contains("color-option")) {
              const color = e.target.dataset.color;
              this.selectColor(color);
            }
          });
          // –¶–≤–µ—Ç–æ–≤–æ–π picker –¥–ª—è –ø—Ä–æ–∏–∑–≤–æ–ª—å–Ω—ã—Ö —Ü–≤–µ—Ç–æ–≤
          document
            .getElementById("characterColorPicker")
            ?.addEventListener("input", (e) => {
              this.selectColor(e.target.value);
            });

          // Theme controls
          const themeSelect = document.getElementById("themeSelect");
          const themeAuto = document.getElementById("themeAuto");
          const btnApplyTheme = document.getElementById("btnApplyTheme");
          const btnSaveTheme = document.getElementById("btnSaveTheme");
          const btnClearTheme = document.getElementById("btnClearTheme");

          btnApplyTheme?.addEventListener("click", () => {
            const t = themeSelect.value;
            if (t === "none") this.applyTheme(null);
            else this.applyTheme(t);
          });

          btnSaveTheme?.addEventListener("click", async () => {
            const themeSelectEl = document.getElementById("themeSelect");
            const themeAutoEl = document.getElementById("themeAuto");
            const themeEnabledEl = document.getElementById("themeEnabled");
            const themeFrequencyEl = document.getElementById("themeFrequency");
            const themeIntensityEl = document.getElementById("themeIntensity");

            const t =
              themeSelectEl.value === "none" ? null : themeSelectEl.value;
            const auto = themeAutoEl.checked;

            // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ç–µ–∫—É—â–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∏ –æ–±–Ω–æ–≤–ª—è–µ–º
            const setting = (await this.loadThemeSetting()) || {};
            setting.theme = t;
            setting.auto = !!auto;
            setting.themeSettings = setting.themeSettings || {};

            if (t) {
              setting.themeSettings[t] = setting.themeSettings[t] || {};
              setting.themeSettings[t].enabled = !!(
                themeEnabledEl && themeEnabledEl.checked
              );
              setting.themeSettings[t].frequency = parseInt(
                themeFrequencyEl?.value || 1,
              );
              setting.themeSettings[t].intensity =
                parseInt(themeIntensityEl?.value || 50) / 100;
            }

            await this.saveThemeSetting(setting);
            alert("‚úÖ –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ç–µ–º—ã —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞");
          });

          btnClearTheme?.addEventListener("click", async () => {
            if (!confirm("–°–±—Ä–æ—Å–∏—Ç—å —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—É—é —Ç–µ–º—É?")) return;
            await this.clearThemeSetting();
            this.applyTheme(null);
            themeSelect.value = "none";
            themeAuto.checked = false;
            alert("‚úÖ –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Ç–µ–º—ã —Å–±—Ä–æ—à–µ–Ω—ã");
          });

          // Theme tuning controls
          const themeEnabled = document.getElementById("themeEnabled");
          const themeFrequency = document.getElementById("themeFrequency");
          const themeIntensity = document.getElementById("themeIntensity");
          const fearDays = document.getElementById("fearDays");
          const btnStartFear = document.getElementById("btnStartFear");
          const btnStopFear = document.getElementById("btnStopFear");
          const btnSignInAuth = document.getElementById("btnSignInAuth");
          const btnSignOutAuth = document.getElementById("btnSignOutAuth");
          const adminUserInfo = document.getElementById("adminUserInfo");

          // When selected theme changes, populate tuning UI from stored settings
          themeSelect?.addEventListener("change", async () => {
            const s = await this.loadThemeSetting();
            const themeKey =
              themeSelect.value === "none" ? null : themeSelect.value;
            if (!s || !s.themeSettings) {
              themeEnabled.checked = true;
              themeFrequency.value = 1;
              themeIntensity.value = 50;
              // apply default/no theme
              if (themeKey) {
                this.applyTheme(themeKey);
                this.createEffectsForTheme(themeKey);
              } else {
                this.applyTheme(null);
              }
              return;
            }
            if (themeKey && s.themeSettings && s.themeSettings[themeKey]) {
              const cfg = s.themeSettings[themeKey];
              themeEnabled.checked = cfg.enabled !== false;
              themeFrequency.value = cfg.frequency || 1;
              themeIntensity.value = Math.round((cfg.intensity || 0.5) * 100);
              // apply the selected theme with loaded settings
              if (themeEnabled.checked) {
                this.applyTheme(themeKey);
                this.createEffectsForTheme(themeKey, {
                  frequency: cfg.frequency || 1,
                  intensity: cfg.intensity || 0.5,
                });
              } else {
                this.applyTheme(null);
              }
            } else {
              themeEnabled.checked = true;
              themeFrequency.value = 1;
              themeIntensity.value = 50;
              if (themeKey) {
                this.applyTheme(themeKey);
                this.createEffectsForTheme(themeKey);
              } else {
                this.applyTheme(null);
              }
            }
          });

          // Live-preview handlers for tuning controls (–Ω–µ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç –Ω–∞—Å—Ç—Ä–æ–π–∫–∏)
          const applyPreview = () => {
            const themeKey =
              themeSelect.value === "none" ? null : themeSelect.value;
            if (!themeKey) return;
            // ensure classes applied
            this.applyTheme(themeKey);
            const freq = parseInt(themeFrequency.value || 1);
            const intensityVal = Math.round(themeIntensity.value || 50);
            const intensity = Math.min(100, Math.max(0, intensityVal)) / 100;
            this.createEffectsForTheme(themeKey, {
              frequency: freq,
              intensity: intensity,
            });
          };

          themeFrequency?.addEventListener("input", () => applyPreview());
          themeIntensity?.addEventListener("input", () => applyPreview());
          themeEnabled?.addEventListener("change", () => {
            const themeKey =
              themeSelect.value === "none" ? null : themeSelect.value;
            if (!themeKey) return;
            if (!themeEnabled.checked) {
              this.applyTheme(null);
            } else {
              this.applyTheme(themeKey);
            }
          });

          btnStartFear?.addEventListener("click", async () => {
            const days = parseInt(fearDays.value) || 7;
            await this.startFearWeek(days);
            alert("‚úÖ Fear week –∑–∞–ø—É—â–µ–Ω–∞ –Ω–∞ " + days + " –¥–Ω–µ–π");
          });

          btnStopFear?.addEventListener("click", async () => {
            await this.stopFearWeek();
            alert("‚úÖ Fear week –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞");
          });

          btnSignInAuth?.addEventListener("click", () => this.showAuthModal());
          btnSignOutAuth?.addEventListener("click", () => this.signOut());
        }

        handleLogin() {
          const password = document.getElementById("adminPassword").value;
          if (password === this.adminPassword) {
            this.showAdminInterface();
          } else {
            alert("‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å");
          }
        }

        switchTab(tabName) {
          // –°–∫—Ä—ã—Ç—å –≤—Å–µ —Ç–∞–±—ã
          document.querySelectorAll(".tab-content").forEach((tab) => {
            tab.classList.remove("active");
          });
          document.querySelectorAll(".tab").forEach((tab) => {
            tab.classList.remove("active");
          });

          // –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º –∏–º—è —Ç–∞–±–∞ –¥–ª—è –ø–æ–∏—Å–∫–∞ id (–Ω–∞–ø—Ä–∏–º–µ—Ä, 'new-story' -> 'newStory')
          const normalize = (name) =>
            name.replace(/-([a-z])/g, (m, c) => c.toUpperCase());
          const normalized = normalize(tabName);

          // –ü–æ–∫–∞–∑–∞—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–π —Ç–∞–± (–∑–∞—â–∏—â–∞–µ–º—Å—è –æ—Ç null)
          const contentElement =
            document.getElementById(tabName + "Tab") ||
            document.getElementById(normalized + "Tab");
          if (contentElement) {
            contentElement.classList.add("active");
          } else {
            console.warn("switchTab: –Ω–µ –Ω–∞–π–¥–µ–Ω –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è —Ç–∞–±–∞", tabName);
          }

          const tabButton = document.querySelector(`[data-tab="${tabName}"]`);
          if (tabButton) {
            tabButton.classList.add("active");
          } else {
            console.warn("switchTab: –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –∫–Ω–æ–ø–∫–∞ —Ç–∞–±–∞", tabName);
          }

          if (tabName === "schedule") {
            this.renderSchedule();
          }
        }

        async loadData() {
          try {
            console.log("üîÑ –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –∞–¥–º–∏–Ω–∫–∏...");
            const storiesSnapshot = await db
              .collection("stories")
              .orderBy("createdAt", "desc")
              .get();
            this.stories = storiesSnapshot.docs.map((doc) => ({
              id: doc.id,
              ...doc.data(),
            }));

            await this.checkAndUnblockAnnouncedStories();

            console.log("‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–æ –∏—Å—Ç–æ—Ä–∏–π:", this.stories.length);
            this.renderStories();
          } catch (error) {
            console.error("‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏:", error);
            alert("‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö");
          }
        }

        renderStories() {
          const container = document.getElementById("storiesList");
          if (!container) return;

          if (this.stories.length === 0) {
            container.innerHTML = `
            <div class="empty-state">
              <div class="icon">üìù</div>
              <h3>–ò—Å—Ç–æ—Ä–∏–π –ø–æ–∫–∞ –Ω–µ—Ç</h3>
              <p>–°–æ–∑–¥–∞–π—Ç–µ –ø–µ—Ä–≤—É—é –∏—Å—Ç–æ—Ä–∏—é —á–µ—Ä–µ–∑ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä</p>
            </div>
          `;
            return;
          }

          container.innerHTML = this.stories
            .map((story) => {
              const status = story.status || "announced";
              const visibility =
                story.visibility ||
                (story.isPublic === false ? "hidden" : "public");
              const episodesCount = story.episodesCount || 0;
              const plannedEpisodes = story.plannedEpisodes || 0;

              return `
            <div class="story-card ${status === "announced" ? "soon" : ""}" style="border-left: 3px solid ${visibility === "hidden" ? "#6b7280" : visibility === "closed" ? "#f59e0b" : "#10b981"}">
              <div class="story-header">
                <h3 class="story-title">${story.title || "–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è"}</h3>
                <div class="story-meta">
                  <span class="badge category">${this.getCategoryName(story.category, story.customCategory)}</span>
                  <span class="badge status-${status}">${this.getStoryStatusText(status)}</span>
                  <span class="badge status-${visibility}">${this.getVisibilityText(visibility)}</span>
                  ${plannedEpisodes > 0 ? `<span class="badge">üìä ${episodesCount}/${plannedEpisodes}</span>` : ""}
                </div>
              </div>
              <p class="story-desc">${story.description || "–û–ø–∏—Å–∞–Ω–∏–µ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç"}</p>
              <div class="story-actions">
                <button class="btn btn-secondary btn-small" onclick="adminPanel.editStory('${story.id}')">‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
                <button class="btn btn-danger btn-small" onclick="adminPanel.deleteStoryPrompt('${story.id}')">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å</button>
                <select class="btn btn-small" onchange="if(this.value) adminPanel.toggleVisibility('${story.id}', this.value); this.value='';" style="padding:8px;font-size:12px;">
                  <option value="">–ò–∑–º–µ–Ω–∏—Ç—å –≤–∏–¥–∏–º–æ—Å—Ç—å</option>
                  <option value="public">üëÅÔ∏è –û–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–∞</option>
                  <option value="closed">üîê –ó–∞–∫—Ä—ã—Ç–∞ (–∞–Ω–æ–Ω—Å)</option>
                  <option value="hidden">üëª –°–∫—Ä—ã—Ç–∞</option>
                </select>
                <button class="btn btn-info btn-small" onclick="adminPanel.safeOpenConstructor('${story.id}')">üõ†Ô∏è –ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä</button>
              </div>
            </div>
          `;
            })
            .join("");
        }

        getCategoryName(category, customCategory) {
          const categories = {
            fantasy: "üßô –§—ç–Ω—Ç–µ–∑–∏",
            "sci-fi": "üöÄ –ù–∞—É—á–Ω–∞—è —Ñ–∞–Ω—Ç–∞—Å—Ç–∏–∫–∞",
            horror: "üëª –•–æ—Ä—Ä–æ—Ä",
            adventure: "üó∫Ô∏è –ü—Ä–∏–∫–ª—é—á–µ–Ω–∏—è",
            mystery: "üïµÔ∏è –ú–∏—Å—Ç–∏–∫–∞",
            chat: "üí¨ –ß–∞—Ç-–∏—Å—Ç–æ—Ä–∏–∏",
          };
          return customCategory || categories[category] || category;
        }

        getStatusType(story) {
          if (story.published) return "published";
          if (story.publishDate && new Date(story.publishDate) > new Date())
            return "scheduled";
          return "soon";
        }

        getStatusText(story) {
          if (story.published) return "‚úÖ –û–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–æ";
          if (story.publishDate && new Date(story.publishDate) > new Date()) {
            const date = this.getStoryDate(story.publishDate);
            return `‚è∞ ${date.toLocaleDateString()}`;
          }
          return "üïê –°–∫–æ—Ä–æ";
        }

        getStoryStatusText(status) {
          switch (status) {
            case "announced":
              return "üîí –ê–Ω–æ–Ω—Å";
            case "new":
              return "üÜï –ù–æ–≤–∏–Ω–∫–∞";
            case "ongoing":
              return "üìñ –ü—Ä–æ–¥–æ–ª–∂–∞–µ—Ç—Å—è";
            case "finished":
              return "‚úÖ –ó–∞–≤–µ—Ä—à–µ–Ω–∞";
            case "abandoned":
              return "üíî –ë—Ä–æ—à–µ–Ω–∞";
            case "releasing":
              return "üöÄ –í—ã—Ö–æ–¥–∏—Ç";
            case "scheduled":
              return "‚è∞ –û–∂–∏–¥–∞–µ—Ç";
            default:
              return status;
          }
        }

        getVisibilityText(visibility) {
          switch (visibility) {
            case "public":
              return "üëÅÔ∏è –û–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–∞";
            case "closed":
              return "üîê –ó–∞–∫—Ä—ã—Ç–∞";
            case "hidden":
              return "üëª –°–∫—Ä—ã—Ç–∞";
            default:
              return visibility;
          }
        }

        getStoryDate(date) {
          return date?.toDate ? date.toDate() : new Date(date);
        }

        // –£–ü–†–ê–í–õ–ï–ù–ò–ï –ò–°–¢–û–†–ò–Ø–ú–ò
        async createNewStory() {
          const title = document.getElementById("newStoryTitle").value;
          const description = document.getElementById(
            "newStoryDescription",
          ).value;
          const category = document.getElementById("newStoryCategory").value;
          const plannedEpisodes =
            parseInt(
              document.getElementById("newStoryPlannedEpisodes").value,
            ) || 10;
          const status = document.getElementById("newStoryStatus").value;
          const visibility =
            document.getElementById("newStoryVisibility").value;
          const firstEpisodeDate = document.getElementById(
            "newStoryFirstEpisodeDate",
          ).value;

          if (!title.trim()) {
            alert("‚ùå –í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–∏");
            return;
          }

          try {
            const now = new Date();
            const storyData = {
              title: title.trim(),
              description: description.trim(),
              category: category,
              plannedEpisodes: plannedEpisodes,
              status: status,
              visibility: visibility,
              firstEpisodeDate: firstEpisodeDate
                ? new Date(firstEpisodeDate)
                : null,
              episodesCount: 0,
              lastEpisodeDate: null,
              coverUrl: "",
              isPublic: visibility === "public",
              published: visibility === "public",
              createdAt: now,
              updatedAt: now,
            };

            const docRef = await db.collection("stories").add(storyData);
            console.log("‚úÖ –ò—Å—Ç–æ—Ä–∏—è —Å–æ–∑–¥–∞–Ω–∞:", docRef.id);

            // –û—á–∏—â–∞–µ–º —Ñ–æ—Ä–º—É
            document.getElementById("newStoryTitle").value = "";
            document.getElementById("newStoryDescription").value = "";
            document.getElementById("newStoryPlannedEpisodes").value = "10";
            document.getElementById("newStoryStatus").value = "announced";
            document.getElementById("newStoryVisibility").value = "public";
            document.getElementById("newStoryFirstEpisodeDate").value = "";

            // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ
            await this.loadData();

            // –ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä—É –Ω–æ–≤–æ–π –∏—Å—Ç–æ—Ä–∏–∏
            this.openConstructor(docRef.id);

            alert("‚úÖ –ò—Å—Ç–æ—Ä–∏—è —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω–∞!");
          } catch (error) {
            console.error("‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∏—Å—Ç–æ—Ä–∏–∏:", error);
            alert("‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∏—Å—Ç–æ—Ä–∏–∏");
          }
        }

        async quickCreateStory() {
          if (!confirm("–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é –∏—Å—Ç–æ—Ä–∏—é —Å –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–º–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏?"))
            return;

          try {
            const now = new Date();
            const storyData = {
              title: "–ù–æ–≤–∞—è –∏—Å—Ç–æ—Ä–∏—è (–±—ã—Å—Ç—Ä–æ)",
              description: "",
              category: "chat",
              plannedEpisodes: 10,
              episodesCount: 0,
              status: "announced",
              visibility: "public",
              firstEpisodeDate: null,
              lastEpisodeDate: null,
              coverUrl: "",
              isPublic: true,
              published: true,
              createdAt: now,
              updatedAt: now,
            };

            const docRef = await db.collection("stories").add(storyData);
            console.log("‚úÖ –ë—ã—Å—Ç—Ä–∞—è –∏—Å—Ç–æ—Ä–∏—è —Å–æ–∑–¥–∞–Ω–∞:", docRef.id);

            await this.loadData();
            this.openConstructor(docRef.id);
            alert("‚úÖ –ë—ã—Å—Ç—Ä–∞—è –∏—Å—Ç–æ—Ä–∏—è —Å–æ–∑–¥–∞–Ω–∞ –∏ –æ—Ç–∫—Ä—ã—Ç–∞ –≤ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä–µ");
          } catch (error) {
            console.error("‚ùå –û—à–∏–±–∫–∞ –±—ã—Å—Ç—Ä–æ–π –ø—É–±–ª–∏–∫–∞—Ü–∏–∏:", error);
            alert("‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∏—Å—Ç–æ—Ä–∏–∏");
          }
        }

        editStory(storyId) {
          const story = this.stories.find((s) => s.id === storyId);
          if (story) {
            // –ü–µ—Ä–µ—Ö–æ–¥–∏–º –≤ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
            this.openConstructor(storyId);
          }
        }

        deleteStoryPrompt(storyId) {
          const story = this.stories.find((s) => s.id === storyId);
          if (!story) return;

          if (
            confirm(
              `–£–¥–∞–ª–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é "${story.title}"? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.`,
            )
          ) {
            this.deleteStory(storyId);
          }
        }

        async deleteStory(storyId) {
          try {
            await db.collection("stories").doc(storyId).delete();
            await this.loadData();
            alert("üóëÔ∏è –ò—Å—Ç–æ—Ä–∏—è —É–¥–∞–ª–µ–Ω–∞");
          } catch (error) {
            console.error("–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è:", error);
            alert("‚ùå –û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –∏—Å—Ç–æ—Ä–∏–∏");
          }
        }

        async publishNow(storyId) {
          try {
            await db.collection("stories").doc(storyId).update({
              published: true,
              publishDate: null,
              updatedAt: new Date(),
            });
            await this.loadData();
            alert("‚úÖ –ò—Å—Ç–æ—Ä–∏—è –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–∞!");
          } catch (error) {
            alert("‚ùå –û—à–∏–±–∫–∞ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏");
          }
        }

        async toggleVisibility(storyId, newVisibility) {
          try {
            const isPublic = newVisibility === "public";
            await db.collection("stories").doc(storyId).update({
              visibility: newVisibility,
              isPublic: isPublic,
              published: isPublic,
              updatedAt: new Date(),
            });
            await this.loadData();
            alert(
              `‚úÖ –í–∏–¥–∏–º–æ—Å—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∞: ${this.getVisibilityText(newVisibility)}`,
            );
          } catch (error) {
            alert("‚ùå –û—à–∏–±–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤–∏–¥–∏–º–æ—Å—Ç–∏");
          }
        }

        // –ö–û–ù–°–¢–†–£–ö–¢–û–† –ò–°–¢–û–†–ò–ô
        async openConstructor(storyId) {
          this.currentStory = this.stories.find((s) => s.id === storyId);
          if (this.currentStory) {
            this.switchTab("constructor");
            await this.loadConstructorData(storyId);
          }
        }

        // –î–æ–±–∞–≤–ª—è–µ–º –º–µ—Ç–æ–¥ –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ –ø–µ—Ä–µ—Ö–æ–¥–∞ –≤ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä
        safeOpenConstructor(storyId) {
          if (!storyId) {
            alert("‚ùå ID –∏—Å—Ç–æ—Ä–∏–∏ –Ω–µ —É–∫–∞–∑–∞–Ω");
            return;
          }
          this.openConstructor(storyId);
        }

        async loadConstructorData(storyId) {
          if (!storyId) return;

          try {
            console.log(
              "üîÑ –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä–∞ (—ç–ø–∏–∑–æ–¥—ã –∏ –ø–µ—Ä—Å–æ–Ω–∞–∂–∏ –∏—Å—Ç–æ—Ä–∏–∏)...",
            );

            // –ó–∞–≥—Ä—É–∂–∞–µ–º —ç–ø–∏–∑–æ–¥—ã —ç—Ç–æ–π –∏—Å—Ç–æ—Ä–∏–∏
            const episodesSnapshot = await db
              .collection("episodes")
              .where("storyId", "==", storyId)
              .orderBy("episodeNumber")
              .get();
            this.episodes = episodesSnapshot.docs.map((doc) => ({
              id: doc.id,
              ...doc.data(),
            }));

            // –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π —É—Ä–æ–≤–Ω—è –∏—Å—Ç–æ—Ä–∏–∏ (–ø–æ–≤—Ç–æ—Ä–Ω–æ –∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ)
            const charactersSnapshot = await db
              .collection("story_characters")
              .where("storyId", "==", storyId)
              .get();
            this.characters = charactersSnapshot.docs.map((doc) => ({
              id: doc.id,
              ...doc.data(),
            }));

            console.log("‚úÖ –≠–ø–∏–∑–æ–¥–æ–≤:", this.episodes.length);
            console.log("‚úÖ –ü–µ—Ä—Å–æ–Ω–∞–∂–µ–π –∏—Å—Ç–æ—Ä–∏–∏:", this.characters.length);

            this.renderEpisodes();
            this.renderCharacters();

            // –°–±—Ä–æ—Å —Ç–µ–∫—É—â–µ–≥–æ —ç–ø–∏–∑–æ–¥–∞ ‚Äî —Å–æ–æ–±—â–µ–Ω–∏—è –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–∞—Ç—å—Å—è –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ —ç–ø–∏–∑–æ–¥–∞
            this.currentEpisode = null;
            this.messages = [];
            this.renderMessages();
            this.updatePreview();
          } catch (error) {
            console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä–∞:", error);
            alert("‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä–∞");
          }
        }

        // –ó–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —ç–ø–∏–∑–æ–¥–∞ (—Å–æ–æ–±—â–µ–Ω–∏—è)
        async loadEpisodeData(episodeId) {
          if (!episodeId) return;
          try {
            const episodeDoc = await db
              .collection("episodes")
              .doc(episodeId)
              .get();
            this.currentEpisode = { id: episodeDoc.id, ...episodeDoc.data() };

            const messagesSnapshot = await db
              .collection("episode_messages")
              .where("episodeId", "==", episodeId)
              .orderBy("order")
              .get();
            this.messages = messagesSnapshot.docs.map((doc) => ({
              id: doc.id,
              ...doc.data(),
            }));

            console.log("‚úÖ –°–æ–æ–±—â–µ–Ω–∏–π –≤ —ç–ø–∏–∑–æ–¥–µ:", this.messages.length);

            this.renderMessages();
            this.updatePreview();
          } catch (error) {
            console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —ç–ø–∏–∑–æ–¥–∞:", error);
            alert("‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —ç–ø–∏–∑–æ–¥–∞");
          }
        }

        renderCharacters() {
          const container = document.getElementById("characterList");
          const select = document.getElementById("messageCharacter");

          if (!container) return;

          container.innerHTML = "";
          if (select)
            select.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞</option>';

          this.characters.forEach((character) => {
            // –°–ø–∏—Å–æ–∫ –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π
            if (container) {
              const characterElement = document.createElement("div");
              characterElement.className = "character-item";
              characterElement.innerHTML = `
              <div class="character-header">
                <div class="character-avatar" style="background: ${character.color || "#6366f1"}">
                  ${character.name.charAt(0).toUpperCase()}
                </div>
                <div>
                  <div class="character-name">${character.name}</div>
                  <div class="character-role">${character.bio || "–ü–µ—Ä—Å–æ–Ω–∞–∂"}</div>
                </div>
              </div>
            `;
              characterElement.addEventListener("click", () => {
                this.editCharacter(character.id);
              });
              container.appendChild(characterElement);
            }

            // –û–ø—Ü–∏–∏ –¥–ª—è –≤—ã–±–æ—Ä–∞ –≤ —Ñ–æ—Ä–º–µ —Å–æ–æ–±—â–µ–Ω–∏—è
            if (select) {
              const option = document.createElement("option");
              option.value = character.id;
              option.textContent = character.name;
              select.appendChild(option);
            }
          });

          // –ï—Å–ª–∏ –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π –Ω–µ—Ç, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
          if (this.characters.length === 0 && container) {
            container.innerHTML = `
            <div class="empty-state">
              <div class="icon">üë•</div>
              <p>–ù–µ—Ç –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π</p>
              <p>–î–æ–±–∞–≤—å—Ç–µ –ø–µ—Ä–≤–æ–≥–æ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞</p>
            </div>
          `;
          }
        }

        
        renderMessages() {
          const container = document.getElementById("messageList");
          if (!container) return;

          container.innerHTML = "";

          this.messages.forEach((message) => {
            const messageElement = document.createElement("div");
            messageElement.className = "message-editor-item";
            messageElement.draggable = true;
            messageElement.dataset.messageId = message.id;

            const character = this.characters.find(
              (c) => c.id === message.characterId,
            );
            const characterName = character ? character.name : "–°–∏—Å—Ç–µ–º–∞";

            messageElement.innerHTML = `
            <div class="message-header">
              <span class="message-type-badge badge-${message.type || "text"}">
                ${this.getMessageTypeIcon(message.type)} ${this.getMessageTypeText(message.type)}
              </span>
              <div class="message-actions">
                <button class="btn btn-small btn-secondary" onclick="adminPanel.editMessage('${message.id}')">‚úèÔ∏è</button>
                <button class="btn btn-small btn-danger" onclick="adminPanel.deleteMessagePrompt('${message.id}')">üóëÔ∏è</button>
              </div>
            </div>
            <div class="message-content-preview">
              ${characterName}: ${message.content || ""}
            </div>
            <div class="message-meta">
              <span>–ü–æ—Ä—è–¥–æ–∫: ${message.order || 1}</span>
              <span>–ó–∞–¥–µ—Ä–∂–∫–∞: ${message.delay || 2000}–º—Å</span>
            </div>
          `;

            // Drag & Drop —Å–æ–±—ã—Ç–∏—è
            messageElement.addEventListener("dragstart", (e) => {
              this.draggedMessage = message;
              e.target.classList.add("dragging");
            });

            messageElement.addEventListener("dragend", (e) => {
              e.target.classList.remove("dragging");
            });

            container.appendChild(messageElement);
          });

          // –ï—Å–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–π –Ω–µ—Ç, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
          if (this.messages.length === 0) {
            container.innerHTML = `
            <div class="empty-state">
              <div class="icon">üí≠</div>
              <p>–ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π</p>
              <p>–î–æ–±–∞–≤—å—Ç–µ –ø–µ—Ä–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ</p>
            </div>
          `;
          }
        }

        /* EPISODES MANAGEMENT */
        renderEpisodes() {
          const container = document.getElementById("episodesList");
          if (!container) return;

          if (!this.episodes || this.episodes.length === 0) {
            container.innerHTML = `
            <div class="empty-state">
              <div class="icon">üìö</div>
              <p>–≠–ø–∏–∑–æ–¥—ã –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç. –î–æ–±–∞–≤—å—Ç–µ –ø–µ—Ä–≤—ã–π —ç–ø–∏–∑–æ–¥.</p>
            </div>
          `;
            return;
          }

          container.innerHTML = this.episodes
            .map((ep) => {
              const isScheduled =
                ep.publishDate &&
                new Date(ep.publishDate) > new Date() &&
                ep.status !== "published";
              const isPublished = ep.status === "published";
              return `
            <div class="story-card ${isScheduled ? "scheduled" : ""} ${isPublished ? "" : "soon"}" style="padding:10px;">
              <div style="display:flex;justify-content:space-between;align-items:center;">
                <div>
                  <strong>–≠–ø–∏–∑–æ–¥ ${ep.episodeNumber}: ${ep.title || "–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è"}</strong>
                  <div style="font-size:12px;color:var(--text-secondary);">–°—Ç–∞—Ç—É—Å: ${ep.status}</div>
                </div>
                <div style="display:flex;gap:8px;">
                  <button class="btn btn-small" onclick="adminPanel.openEpisode('${ep.id}')">–û—Ç–∫—Ä—ã—Ç—å</button>
                  <button class="btn btn-secondary btn-small" onclick="adminPanel.editEpisodePrompt('${ep.id}')">‚úèÔ∏è</button>
                  ${isPublished ? `<button class="btn btn-warning btn-small" onclick="adminPanel.unpublishEpisode('${ep.id}')">–°–Ω—è—Ç—å</button>` : `<button class="btn btn-small" onclick="adminPanel.publishEpisode('${ep.id}')">üöÄ –û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å</button>`}
                  <button class="btn btn-danger btn-small" onclick="adminPanel.deleteEpisodePrompt('${ep.id}')">üóëÔ∏è</button>
                </div>
              </div>
            </div>
          `;
            })
            .join("");
        }

        async createEpisode() {
          if (!this.currentStory) {
            alert("‚ùå –°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –∏—Å—Ç–æ—Ä–∏—é");
            return;
          }

          const title =
            prompt("–ù–∞–∑–≤–∞–Ω–∏–µ —ç–ø–∏–∑–æ–¥–∞", `–≠–ø–∏–∑–æ–¥ ${this.episodes.length + 1}`) ||
            `–≠–ø–∏–∑–æ–¥ ${this.episodes.length + 1}`;
          const number = parseInt(
            prompt("–ù–æ–º–µ—Ä —ç–ø–∏–∑–æ–¥–∞", `${this.episodes.length + 1}`) ||
              `${this.episodes.length + 1}`,
          );

          try {
            const epData = {
              storyId: this.currentStory.id,
              episodeNumber: number,
              title: title.trim(),
              description: "",
              status: "draft", // draft | scheduled | published
              publishDate: null,
              createdAt: new Date(),
              updatedAt: new Date(),
            };

            const docRef = await db.collection("episodes").add(epData);
            console.log("‚úÖ –≠–ø–∏–∑–æ–¥ —Å–æ–∑–¥–∞–Ω:", docRef.id);

            // –û–±–Ω–æ–≤–∏–º —Å—á—ë—Ç—á–∏–∫ —ç–ø–∏–∑–æ–¥–æ–≤ –≤ –∏—Å—Ç–æ—Ä–∏–∏ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
            await db
              .collection("stories")
              .doc(this.currentStory.id)
              .update({
                episodeCount: (this.currentStory.episodeCount || 0) + 1,
                updatedAt: new Date(),
              });

            await this.loadConstructorData(this.currentStory.id);
            setTimeout(() => this.openEpisode(docRef.id), 300);
          } catch (error) {
            console.error("–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —ç–ø–∏–∑–æ–¥–∞:", error);
            alert("‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —ç–ø–∏–∑–æ–¥–∞");
          }
        }

        async openEpisode(episodeId) {
          await this.loadEpisodeData(episodeId);
        }

        editEpisodePrompt(episodeId) {
          const ep = this.episodes.find((e) => e.id === episodeId);
          if (!ep) return;
          const newTitle = prompt("–ù–∞–∑–≤–∞–Ω–∏–µ —ç–ø–∏–∑–æ–¥–∞", ep.title || "");
          const newNumber = parseInt(
            prompt("–ù–æ–º–µ—Ä —ç–ø–∏–∑–æ–¥–∞", `${ep.episodeNumber}`) ||
              `${ep.episodeNumber}`,
          );
          if (newTitle == null || isNaN(newNumber)) return;
          this.saveEpisode(episodeId, {
            title: newTitle.trim(),
            episodeNumber: newNumber,
          });
        }

        async saveEpisode(episodeId, updates) {
          try {
            updates.updatedAt = new Date();
            await db.collection("episodes").doc(episodeId).update(updates);
            await this.loadConstructorData(this.currentStory.id);
            alert("‚úÖ –≠–ø–∏–∑–æ–¥ –æ–±–Ω–æ–≤–ª—ë–Ω");
          } catch (error) {
            console.error("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —ç–ø–∏–∑–æ–¥–∞:", error);
            alert("‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —ç–ø–∏–∑–æ–¥–∞");
          }
        }

        async publishEpisode(episodeId) {
          if (!confirm("–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å —ç–ø–∏–∑–æ–¥ –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å?")) return;
          try {
            await db.collection("episodes").doc(episodeId).update({
              status: "published",
              publishDate: new Date(),
              updatedAt: new Date(),
            });
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –∏—Å—Ç–æ—Ä–∏–∏ –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏
            await this.updateStoryStatusOnPublish(this.currentStory.id);
            await this.loadConstructorData(this.currentStory.id);
            alert("‚úÖ –≠–ø–∏–∑–æ–¥ –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω");
          } catch (error) {
            console.error("–û—à–∏–±–∫–∞ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ —ç–ø–∏–∑–æ–¥–∞:", error);
            alert("‚ùå –û—à–∏–±–∫–∞ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ —ç–ø–∏–∑–æ–¥–∞");
          }
        }

        async unpublishEpisode(episodeId) {
          if (!confirm("–°–Ω—è—Ç—å —ç–ø–∏–∑–æ–¥ —Å –ø—É–±–ª–∏–∫–∞—Ü–∏–∏?")) return;
          try {
            await db.collection("episodes").doc(episodeId).update({
              status: "draft",
              publishDate: null,
              updatedAt: new Date(),
            });
            await this.updateStoryStatusOnPublish(this.currentStory.id);
            await this.loadConstructorData(this.currentStory.id);
            alert("‚úÖ –≠–ø–∏–∑–æ–¥ —Å–Ω—è—Ç —Å –ø—É–±–ª–∏–∫–∞—Ü–∏–∏");
          } catch (error) {
            console.error("–û—à–∏–±–∫–∞ —Å–Ω—è—Ç–∏—è —ç–ø–∏–∑–æ–¥–∞:", error);
            alert("‚ùå –û—à–∏–±–∫–∞ —Å–Ω—è—Ç–∏—è —ç–ø–∏–∑–æ–¥–∞");
          }
        }

        deleteEpisodePrompt(episodeId) {
          const ep = this.episodes.find((e) => e.id === episodeId);
          if (!ep) return;
          if (
            !confirm(
              `–£–¥–∞–ª–∏—Ç—å —ç–ø–∏–∑–æ–¥ ${ep.episodeNumber} ‚Äî "${ep.title}"? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.`,
            )
          )
            return;
          this.deleteEpisode(episodeId);
        }

        async deleteEpisode(episodeId) {
          try {
            // –£–¥–∞–ª—è–µ–º –≤—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è —ç–ø–∏–∑–æ–¥–∞
            const msgs = await db
              .collection("episode_messages")
              .where("episodeId", "==", episodeId)
              .get();
            const batch = db.batch();
            msgs.forEach((d) => batch.delete(d.ref));
            batch.delete(db.collection("episodes").doc(episodeId));
            await batch.commit();
            await db
              .collection("stories")
              .doc(this.currentStory.id)
              .update({
                episodeCount: Math.max(
                  (this.currentStory.episodeCount || 1) - 1,
                  0,
                ),
                updatedAt: new Date(),
              });
            await this.loadConstructorData(this.currentStory.id);
            alert("‚úÖ –≠–ø–∏–∑–æ–¥ —É–¥–∞–ª—ë–Ω");
          } catch (error) {
            console.error("–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —ç–ø–∏–∑–æ–¥–∞:", error);
            alert("‚ùå –û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏eÔøΩ —ç–ø–∏–∑–æ–¥–∞");
          }
        }

        // –û–±–Ω–æ–≤–ª—è–µ—Ç —Å—Ç–∞—Ç—É—Å –∏—Å—Ç–æ—Ä–∏–∏ –ø–æ—Å–ª–µ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏/—Å–Ω—è—Ç–∏—è —ç–ø–∏–∑–æ–¥–∞
        async updateStoryStatusOnPublish(storyId) {
          try {
            const episodesSnapshot = await db
              .collection("episodes")
              .where("storyId", "==", storyId)
              .get();
            const episodes = episodesSnapshot.docs.map((d) => ({
              id: d.id,
              ...d.data(),
            }));
            const publishedCount = episodes.filter(
              (e) => e.status === "published",
            ).length;
            let newStatus = "announced";
            if (publishedCount === 0) {
              // –ï—Å–ª–∏ –µ—Å—Ç—å –±—É–¥—É—â–∏–µ –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —ç–ø–∏–∑–æ–¥—ã ‚Äî scheduled, –∏–Ω–∞—á–µ announced
              const hasScheduled = episodes.some(
                (e) => e.status === "scheduled",
              );
              newStatus = hasScheduled ? "scheduled" : "announced";
            } else {
              // –ï—Å—Ç—å –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–Ω—ã–µ —ç–ø–∏–∑–æ–¥—ã ‚Äî —Å—á–∏—Ç–∞–µ–º —Å–µ—Ä–∏–∞–ª –∫–∞–∫ 'releasing' –∏–ª–∏ 'finished'
              const total = episodes.length;
              newStatus =
                publishedCount === total && total > 0
                  ? "finished"
                  : "releasing";
            }

            await db
              .collection("stories")
              .doc(storyId)
              .update({ status: newStatus, updatedAt: new Date() });
          } catch (error) {
            console.error("–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞ –∏—Å—Ç–æ—Ä–∏–∏:", error);
          }
        }

        getMessageTypeIcon(type) {
          const icons = {
            text: "üí¨",
            thought: "ü§î",
            system: "‚öôÔ∏è",
          };
          return icons[type] || "üí¨";
        }

        getMessageTypeText(type) {
          const texts = {
            text: "–¢–µ–∫—Å—Ç",
            thought: "–ú—ã—Å–ª—å",
            system: "–°–∏—Å—Ç–µ–º–Ω–æ–µ",
          };
          return texts[type] || "–¢–µ–∫—Å—Ç";
        }

        updatePreview() {
          const container = document.getElementById("previewMessages");
          if (!container) return;

          container.innerHTML = "";

          // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–µ—Ä–≤—ã–µ 5 —Å–æ–æ–±—â–µ–Ω–∏–π –¥–ª—è –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞
          const previewMessages = this.messages.slice(0, 5);

          if (previewMessages.length === 0) {
            container.innerHTML = `
            <div class="message-preview system">
              <div class="message-bubble-preview">–î–æ–±–∞–≤—å—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞</div>
            </div>
          `;
            return;
          }

          previewMessages.forEach((message) => {
            const messageElement = document.createElement("div");
            let messageClass = "message-preview other";
            let bubbleClass = "message-bubble-preview";

            if (message.type === "system") {
              messageClass = "message-preview system";
            } else if (message.type === "thought") {
              messageClass = "message-preview thought";
            }

            const character = this.characters.find(
              (c) => c.id === message.characterId,
            );
            const characterName = character ? character.name : "–°–∏—Å—Ç–µ–º–∞";

            messageElement.className = messageClass;
            messageElement.innerHTML = `
            <div class="${bubbleClass}">
              ${message.content || "–ü—É—Å—Ç–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ"}
            </div>
          `;

            container.appendChild(messageElement);
          });
        }

        // –£–ü–†–ê–í–õ–ï–ù–ò–ï –ü–ï–†–°–û–ù–ê–ñ–ê–ú–ò
        showCharacterForm(characterId = null) {
          this.currentEditingCharacter = characterId;
          const form = document.getElementById("characterForm");
          form.style.display = "block";

          if (characterId) {
            const character = this.characters.find((c) => c.id === characterId);
            if (character) {
              document.getElementById("characterName").value = character.name;
              document.getElementById("characterBio").value =
                character.bio || "";
              this.selectColor(character.color || "#6366f1");
            }
          } else {
            document.getElementById("characterName").value = "";
            document.getElementById("characterBio").value = "";
            this.selectColor("#6366f1");
          }
        }

        hideCharacterForm() {
          document.getElementById("characterForm").style.display = "none";
          this.currentEditingCharacter = null;
        }

        selectColor(color) {
          // –£–±–∏—Ä–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ —Å–æ –≤—Å–µ—Ö —Ü–≤–µ—Ç–æ–≤
          document.querySelectorAll(".color-option").forEach((option) => {
            option.classList.remove("selected");
          });

          // –í—ã–¥–µ–ª—è–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–π —Ü–≤–µ—Ç
          const selectedOption = document.querySelector(
            `.color-option[data-color="${color}"]`,
          );
          if (selectedOption) {
            selectedOption.classList.add("selected");
            // –µ—Å–ª–∏ –±—ã–ª –∫–∞—Å—Ç–æ–º–Ω—ã–π swatch, —Å–∫—Ä—ã–≤–∞–µ–º –µ–≥–æ
            const custom = document.querySelector(".color-option.custom");
            if (custom) {
              custom.style.display = "none";
            }
          } else {
            // –ø–æ–∫–∞–∑–∞—Ç—å/–æ–±–Ω–æ–≤–∏—Ç—å –∫–∞—Å—Ç–æ–º–Ω—ã–π swatch
            let custom = document.querySelector(".color-option.custom");
            if (!custom) {
              custom = document.createElement("div");
              custom.className = "color-option custom";
              document.querySelector(".color-options").appendChild(custom);
            }
            custom.dataset.color = color;
            custom.style.backgroundColor = color;
            custom.style.display = "inline-block";
            custom.classList.add("selected");
          }

          // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ –≤ —Å–∫—Ä—ã—Ç–æ–µ –ø–æ–ª–µ –∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º picker
          const hidden = document.getElementById("characterColor");
          if (hidden) hidden.value = color;
          const picker = document.getElementById("characterColorPicker");
          if (picker) picker.value = color;
        }

        async saveCharacter() {
          const name = document.getElementById("characterName").value;
          const bio = document.getElementById("characterBio").value;
          const color = document.getElementById("characterColor").value;

          if (!name.trim()) {
            alert("‚ùå –í–≤–µ–¥–∏—Ç–µ –∏–º—è –ø–µ—Ä—Å–æ–Ω–∞–∂–∞");
            return;
          }

          // –ï–°–õ–ò –ò–°–¢–û–†–ò–ò –ï–©–Å –ù–ï–¢ - –°–û–ó–î–ê–Å–ú –ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–ò
          if (!this.currentStory) {
            const createStory = confirm(
              "–°–Ω–∞—á–∞–ª–∞ –Ω—É–∂–Ω–æ —Å–æ–∑–¥–∞—Ç—å –∏—Å—Ç–æ—Ä–∏—é. –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é –∏—Å—Ç–æ—Ä–∏—é –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏?",
            );
            if (!createStory) return;

            await this.quickCreateStory();
            // –ï—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –∏—Å—Ç–æ—Ä–∏—é, –≤—ã—Ö–æ–¥–∏–º
            if (!this.currentStory) return;
          }

          try {
            const characterData = {
              name: name.trim(),
              bio: bio.trim(),
              color: color,
              storyId: this.currentStory.id,
              createdAt: new Date(),
              updatedAt: new Date(),
            };

            if (this.currentEditingCharacter) {
              // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞
              await db
                .collection("story_characters")
                .doc(this.currentEditingCharacter)
                .update(characterData);
              console.log(
                "‚úÖ –ü–µ—Ä—Å–æ–Ω–∞–∂ –æ–±–Ω–æ–≤–ª–µ–Ω:",
                this.currentEditingCharacter,
              );
            } else {
              // –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞
              const docRef = await db
                .collection("story_characters")
                .add(characterData);
              console.log("‚úÖ –ü–µ—Ä—Å–æ–Ω–∞–∂ —Å–æ–∑–¥–∞–Ω:", docRef.id);
            }

            await this.loadConstructorData(this.currentStory.id);
            this.hideCharacterForm();
            alert("‚úÖ –ü–µ—Ä—Å–æ–Ω–∞–∂ —Å–æ—Ö—Ä–∞–Ω–µ–Ω!");
          } catch (error) {
            console.error("‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø–µ—Ä—Å–æ–Ω–∞–∂–∞:", error);
            alert("‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø–µ—Ä—Å–æ–Ω–∞–∂–∞");
          }
        }

        editCharacter(characterId) {
          this.showCharacterForm(characterId);
        }

        async deleteCharacter() {
          if (!this.currentEditingCharacter) return;

          if (
            !confirm(
              "–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ–≥–æ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞? –í—Å–µ —Å–≤—è–∑–∞–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –±—É–¥—É—Ç –ø–æ—Ç–µ—Ä—è–Ω—ã.",
            )
          ) {
            return;
          }

          try {
            await db
              .collection("story_characters")
              .doc(this.currentEditingCharacter)
              .delete();
            await this.loadConstructorData(this.currentStory.id);
            this.hideCharacterForm();
            alert("‚úÖ –ü–µ—Ä—Å–æ–Ω–∞–∂ —É–¥–∞–ª–µ–Ω");
          } catch (error) {
            console.error("‚ùå –û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –ø–µ—Ä—Å–æ–Ω–∞–∂–∞:", error);
            alert("‚ùå –û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –ø–µ—Ä—Å–æ–Ω–∞–∂–∞");
          }
        }

        // –£–ü–†–ê–í–õ–ï–ù–ò–ï –°–û–û–ë–©–ï–ù–ò–Ø–ú–ò
        showMessageForm(messageId = null) {
          // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —ç–ø–∏–∑–æ–¥ –≤—ã–±—Ä–∞–Ω
          if (!this.currentEpisode) {
            alert("‚ùå –°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ —ç–ø–∏–∑–æ–¥ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è");
            return;
          }

          this.currentEditingMessage = messageId;
          const form = document.getElementById("messageForm");
          form.style.display = "block";
          // ... –æ—Å—Ç–∞–ª—å–Ω–æ–π –∫–æ–¥ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π

          if (messageId) {
            const message = this.messages.find((m) => m.id === messageId);
            if (message) {
              document.getElementById("messageType").value =
                message.type || "text";
              document.getElementById("messageCharacter").value =
                message.characterId || "";
              document.getElementById("messageContent").value =
                message.content || "";
              document.getElementById("messageDelay").value =
                message.delay || 2000;
              document.getElementById("messageOrder").value =
                message.order || 1;
            }
          } else {
            document.getElementById("messageType").value = "text";
            document.getElementById("messageCharacter").value = "";
            document.getElementById("messageContent").value = "";
            document.getElementById("messageDelay").value = 2000;
            document.getElementById("messageOrder").value =
              this.messages.length + 1;
          }
        }

        hideMessageForm() {
          document.getElementById("messageForm").style.display = "none";
          this.currentEditingMessage = null;
        }

        async saveMessage() {
          const type = document.getElementById("messageType").value;
          const characterId = document.getElementById("messageCharacter").value;
          const content = document.getElementById("messageContent").value;
          const delay = parseInt(document.getElementById("messageDelay").value);
          const order = parseInt(document.getElementById("messageOrder").value);

          if (!content.trim()) {
            alert("‚ùå –í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è");
            return;
          }

          // –¢—Ä–µ–±—É–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–π —ç–ø–∏–∑–æ–¥
          if (!this.currentEpisode) {
            alert("‚ùå –í—ã–±–µ—Ä–∏—Ç–µ —ç–ø–∏–∑–æ–¥ –ø–µ—Ä–µ–¥ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è");
            return;
          }

          try {
            const messageData = {
              type: type,
              characterId: characterId || null,
              content: content.trim(),
              delay: delay,
              order: order,
              storyId: this.currentStory.id,
              episodeId: this.currentEpisode.id,
              createdAt: new Date(),
              updatedAt: new Date(),
            };

            if (this.currentEditingMessage) {
              // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
              await db
                .collection("episode_messages")
                .doc(this.currentEditingMessage)
                .update(messageData);
              console.log(
                "‚úÖ –°–æ–æ–±—â–µ–Ω–∏–µ –æ–±–Ω–æ–≤–ª–µ–Ω–æ:",
                this.currentEditingMessage,
              );
            } else {
              // –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
              const docRef = await db
                .collection("episode_messages")
                .add(messageData);
              console.log("‚úÖ –°–æ–æ–±—â–µ–Ω–∏–µ —Å–æ–∑–¥–∞–Ω–æ:", docRef.id);
            }

            await this.loadEpisodeData(this.currentEpisode.id);
            this.hideMessageForm();
            alert("‚úÖ –°–æ–æ–±—â–µ–Ω–∏–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ!");
          } catch (error) {
            console.error("‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏—è:", error);
            alert("‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏—è");
          }
        }

        editMessage(messageId) {
          this.showMessageForm(messageId);
        }

        deleteMessagePrompt(messageId) {
          if (confirm("–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ?")) {
            this.deleteMessage(messageId);
          }
        }

        async deleteMessage(messageId) {
          try {
            await db.collection("episode_messages").doc(messageId).delete();
            if (this.currentEpisode)
              await this.loadEpisodeData(this.currentEpisode.id);
            alert("‚úÖ –°–æ–æ–±—â–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–æ");
          } catch (error) {
            console.error("‚ùå –û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏—è:", error);
            alert("‚ùå –û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏—è");
          }
        }

        // DRAG & DROP
        initDragAndDrop() {
          const messageList = document.getElementById("messageList");
          if (!messageList) return;

          messageList.addEventListener("dragover", (e) => {
            e.preventDefault();
            const afterElement = this.getDragAfterElement(
              messageList,
              e.clientY,
            );
            const draggable = document.querySelector(".dragging");
            if (draggable && afterElement) {
              messageList.insertBefore(draggable, afterElement);
            }
          });

          messageList.addEventListener("drop", async (e) => {
            e.preventDefault();
            if (this.draggedMessage) {
              // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ—Ä—è–¥–æ–∫ –≤—Å–µ—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
              const messageElements = messageList.querySelectorAll(
                ".message-editor-item",
              );
              for (let i = 0; i < messageElements.length; i++) {
                const messageId = messageElements[i].dataset.messageId;
                await db
                  .collection("episode_messages")
                  .doc(messageId)
                  .update({
                    order: i + 1,
                    updatedAt: new Date(),
                  });
              }

              if (this.currentEpisode)
                await this.loadEpisodeData(this.currentEpisode.id);
              this.draggedMessage = null;
            }
          });
        }

        parseImportedData() {
          const format = document.getElementById('importFormat').value;
          const text = document.getElementById('importText').value.trim();
          if (!text) { alert('‚ùå –í—Å—Ç–∞–≤—å —Ç–µ–∫—Å—Ç –¥–ª—è –∏–º–ø–æ—Ä—Ç–∞'); return []; }
          if (format === 'txt') return this.parseTXT(text);
          if (format === 'json') return this.parseJSON(text);
          if (format === 'python') return this.parsePython(text);
          return [];
        }
        parseTXT(text) {
          const lines = text.split('\n');
          const messages = [];
          let currentType = 'text';
          let currentCharacter = null;
          const chars = new Set();
          
          lines.forEach(line => {
            line = line.trim();
            if (!line) return;
            
            if (line.startsWith('[DIALOGUE]')) { currentType = 'text'; return; }
            if (line.startsWith('[ACTION]')) { currentType = 'action'; return; }
            if (line.startsWith('[SYSTEM]')) { currentType = 'system'; return; }
            if (line.startsWith('[THOUGHT]')) { currentType = 'thought'; return; }
            
            if (line.startsWith('[CHARACTER:')) {
              const match = line.match(/\[CHARACTER:(.+?)\]/);
              if (match) { currentCharacter = match[1].trim(); chars.add(currentCharacter); }
              return;
            }
            
            if (line.startsWith('[')) return;
            
            // –ï—Å–ª–∏ —Å—Ç—Ä–æ–∫–∞ —Å–æ–¥–µ—Ä–∂–∏—Ç –¥–≤–æ–µ—Ç–æ—á–∏–µ - —ç—Ç–æ –º–æ–∂–µ—Ç –±—ã—Ç—å "–ü–µ—Ä—Å–æ–Ω–∞–∂: —Ç–µ–∫—Å—Ç"
            if (line.includes(':') && !line.startsWith('http')) {
              const colonIdx = line.indexOf(':');
              const possibleName = line.substring(0, colonIdx).trim();
              const possibleContent = line.substring(colonIdx + 1).trim();
              
              if (possibleName && possibleContent && possibleName.length < 30) {
                currentCharacter = possibleName;
                chars.add(currentCharacter);
                messages.push({
                  type: currentType, content: possibleContent, characterId: currentCharacter,
                  delay: 2000, order: messages.length + 1
                });
                return;
              }
            }
            
            messages.push({
              type: currentType, content: line, characterId: currentCharacter,
              delay: 2000, order: messages.length + 1
            });
          });
          
          this.importedCharacters = Array.from(chars).map(name => ({
            name, color: this.getRandomColor(), bio: '–ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω', isLocal: false
          }));
          return messages;
        }
        parseJSON(text) {
          try {
            const data = JSON.parse(text);
            const messages = (data.messages || data).map((msg, idx) => ({
              type: msg.type || 'text', content: msg.content || msg.text || '',
              characterId: msg.character || msg.characterId,
              delay: msg.delay || 2000, order: idx + 1
            }));
            const chars = new Set();
            messages.forEach(msg => { if (msg.characterId) chars.add(msg.characterId); });
            this.importedCharacters = Array.from(chars).map(name => ({
              name, color: this.getRandomColor(), bio: '–ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω', isLocal: false
            }));
            return messages;
          } catch (e) { alert('‚ùå –û—à–∏–±–∫–∞ JSON: ' + e.message); return []; }
        }
        parsePython(text) {
          const messages = [];
          const chars = new Set();
          const regex = /(\w+):\s*"([^"]+)"\s*(?:\|\s*\[(\w+)\])?/g;
          let match;
          while ((match = regex.exec(text)) !== null) {
            const character = match[1];
            const content = match[2];
            const type = match[3] || 'text';
            chars.add(character);
            messages.push({
              type, content, characterId: character,
              delay: 2000, order: messages.length + 1
            });
          }
          this.importedCharacters = Array.from(chars).map(name => ({
            name, color: this.getRandomColor(), bio: '–ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω', isLocal: false
          }));
          return messages;
        }
        getRandomColor() {
          const colors = ['#6366f1', '#FFE81F', '#4caf50', '#ff9800', '#e91e63', '#9c27b0', '#00bcd4'];
          return colors[Math.floor(Math.random() * colors.length)];
        }

        // ===== –ò–ú–ü–û–†–¢ –¶–ï–õ–û–ô –ò–°–¢–û–†–ò–ò =====
        addBulkEpisodeBlock() {
          const container = document.getElementById('bulkEpisodeBlocks');
          const blockId = 'bulk_' + Date.now();
          const blockHTML = `
            <div id="${blockId}" style="background: var(--bg-secondary); padding: 15px; margin: 10px 0; border-radius: 4px; border: 1px solid var(--border-light);">
              <input type="text" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —ç–ø–∏–∑–æ–¥–∞" class="bulkEpisodeName" style="width: 100%; padding: 8px; margin-bottom: 8px; border: 1px solid var(--border-light); border-radius: 4px;">
              <input type="date" class="bulkEpisodeDate" style="width: 100%; padding: 8px; margin-bottom: 8px; border: 1px solid var(--border-light); border-radius: 4px;">
              <select class="bulkEpisodeFormat" style="width: 100%; padding: 8px; margin-bottom: 8px; border: 1px solid var(--border-light); border-radius: 4px;">
                <option value="txt">üìÑ TXT (—Å —Ç–µ–≥–∞–º–∏)</option>
                <option value="json">üì¶ JSON (—Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π)</option>
                <option value="python">üêç Python (—Å—Ü–µ–Ω–∞—Ä–∏–π)</option>
              </select>
              <input type="file" class="bulkEpisodeFile" accept=".txt,.json,.py" style="width: 100%; padding: 8px; margin-bottom: 8px;">
              <textarea class="bulkEpisodeText" rows="6" placeholder="–ò–ª–∏ –≤—Å—Ç–∞–≤—å —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏–π..." style="width: 100%; padding: 8px; font-family: monospace; font-size: 12px; border: 1px solid var(--border-light); border-radius: 4px; margin-bottom: 8px;"></textarea>
              <button class="btn btn-danger btn-small" onclick="admin.removeBulkEpisodeBlock('${blockId}')">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å</button>
            </div>
          `;
          if (container.querySelector('[style*="–ù–∞–∂–º–∏ –∫–Ω–æ–ø–∫—É"]')) {
            container.innerHTML = '';
          }
          container.innerHTML += blockHTML;

          const fileInput = document.querySelector(`#${blockId} .bulkEpisodeFile`);
          fileInput?.addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;
            const text = await file.text();
            document.querySelector(`#${blockId} .bulkEpisodeText`).value = text;
          });
        }

        removeBulkEpisodeBlock(blockId) {
          document.getElementById(blockId)?.remove();
          if (document.querySelectorAll('[id^="bulk_"]').length === 0) {
            document.getElementById('bulkEpisodeBlocks').innerHTML = '<div style="color: var(--text-secondary); text-align: center; padding: 20px;">üìö –ù–∞–∂–º–∏ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ, —á—Ç–æ–±—ã –¥–æ–±–∞–≤–∏—Ç—å –ø–µ—Ä–≤—ã–π —ç–ø–∏–∑–æ–¥</div>';
          }
        }

        getBulkEpisodeBlocks() {
          const blocks = document.querySelectorAll('[id^="bulk_"]');
          return Array.from(blocks).map((block, idx) => ({
            order: idx + 1,
            title: block.querySelector('.bulkEpisodeName').value || ('–≠–ø–∏–∑–æ–¥ ' + (idx + 1)),
            date: block.querySelector('.bulkEpisodeDate').value || new Date().toISOString().split('T')[0],
            format: block.querySelector('.bulkEpisodeFormat').value,
            text: block.querySelector('.bulkEpisodeText').value
          }));
        }

        async previewBulkImport() {
          const title = document.getElementById('bulkImportTitle').value;
          const desc = document.getElementById('bulkImportDescription').value;
          if (!title) { alert('‚ùå –í–≤–µ–¥–∏ –Ω–∞–∑–≤–∞–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–∏'); return; }

          const blocks = this.getBulkEpisodeBlocks();
          if (blocks.length === 0) { alert('‚ùå –î–æ–±–∞–≤—å —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω —ç–ø–∏–∑–æ–¥'); return; }

          let previewHTML = `<div style="padding: 15px; background: var(--bg-card); border-radius: 4px; margin-bottom: 15px;">
            <h4>${title}</h4>
            <p style="color: var(--text-secondary);">${desc || '–ë–µ–∑ –æ–ø–∏—Å–∞–Ω–∏—è'}</p>
          </div>`;

          for (const block of blocks) {
            const msgs = this.parseImportText(block.text, block.format);
            previewHTML += `<div style="padding: 10px; background: var(--bg-secondary); margin: 10px 0; border-radius: 4px;">
              <strong>üìñ ${block.title}</strong> (${block.date})<br>
              –°–æ–æ–±—â–µ–Ω–∏–π: ${msgs.length}
            </div>`;
          }

          document.getElementById('bulkPreviewContent').innerHTML = previewHTML;
          document.getElementById('bulkImportPreview').style.display = 'block';
        }

        async confirmBulkImport() {
          const title = document.getElementById('bulkImportTitle').value;
          const desc = document.getElementById('bulkImportDescription').value;
          const category = document.getElementById('bulkImportCategory').value;

          if (!title) { alert('‚ùå –í–≤–µ–¥–∏ –Ω–∞–∑–≤–∞–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–∏'); return; }

          const blocks = this.getBulkEpisodeBlocks();
          if (blocks.length === 0) { alert('‚ùå –î–æ–±–∞–≤—å —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω —ç–ø–∏–∑–æ–¥'); return; }

          try {
            const storyRef = await db.collection('stories').add({
              title: title,
              description: desc,
              category: category,
              status: 'draft',
              visibility: 'public',
              episodesCount: 0,
              plannedEpisodes: blocks.length,
              createdAt: new Date(),
              updatedAt: new Date()
            });
            const storyId = storyRef.id;
            console.log('‚úÖ –ò—Å—Ç–æ—Ä–∏—è —Å–æ–∑–¥–∞–Ω–∞:', storyId);

            for (const block of blocks) {
              const msgs = this.parseImportText(block.text, block.format);
              const chars = this.extractCharacters(msgs);

              const charMap = {};
              for (const ch of chars) {
                const charRef = await db.collection('story_characters').add({
                  name: ch.name,
                  color: ch.color,
                  bio: '–ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω',
                  storyId: storyId,
                  isLocal: false,
                  createdAt: new Date(),
                  updatedAt: new Date()
                });
                charMap[ch.name] = charRef.id;
              }

              const episodeRef = await db.collection('episodes').add({
                storyId: storyId,
                episodeNumber: block.order,
                title: block.title,
                publishDate: new Date(block.date),
                status: 'draft',
                createdAt: new Date(),
                updatedAt: new Date()
              });
              const episodeId = episodeRef.id;

              for (const msg of msgs) {
                await db.collection('episode_messages').add({
                  episodeId: episodeId,
                  storyId: storyId,
                  type: msg.type,
                  content: msg.content,
                  characterId: msg.characterId ? charMap[msg.characterId] : null,
                  delay: msg.delay,
                  order: msg.order,
                  createdAt: new Date()
                });
              }
            }

            alert('‚úÖ –ò—Å—Ç–æ—Ä–∏—è –∏ ' + blocks.length + ' —ç–ø–∏–∑–æ–¥–æ–≤ —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω—ã!');
            document.getElementById('bulkImportTitle').value = '';
            document.getElementById('bulkImportDescription').value = '';
            document.getElementById('bulkEpisodeBlocks').innerHTML = '<div style="color: var(--text-secondary); text-align: center; padding: 20px;">üìö –ù–∞–∂–º–∏ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ, —á—Ç–æ–±—ã –¥–æ–±–∞–≤–∏—Ç—å –ø–µ—Ä–≤—ã–π —ç–ø–∏–∑–æ–¥</div>';
            document.getElementById('bulkImportPreview').style.display = 'none';
          } catch (error) {
            console.error('–û—à–∏–±–∫–∞:', error);
            alert('‚ùå –û—à–∏–±–∫–∞: ' + error.message);
          }
        }

        // ===== –ò–ú–ü–û–†–¢ –≠–ü–ò–ó–û–î–ê –í –ò–°–¢–û–†–ò–Æ =====
        showConstructorImportModal() {
          if (!this.currentStory) {
            alert('‚ùå –í—ã–±–µ—Ä–∏ –∏—Å—Ç–æ—Ä–∏—é –≤ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä–µ');
            return;
          }
          const episodeTab = document.getElementById('episodeImportTab');
          episodeTab.style.display = 'block';
          document.querySelectorAll('.tab-content').forEach(t => t.style.display = 'none');
          episodeTab.style.display = 'block';
        }

        parseImportText(text, format) {
          if (format === 'json') return this.parseJSON(text);
          if (format === 'python') return this.parsePython(text);
          return this.parseTXT(text);
        }

        extractCharacters(messages) {
          const chars = new Map();
          const colors = ['#6366f1', '#FFE81F', '#4caf50', '#ff9800', '#e91e63', '#9c27b0', '#00bcd4'];

          messages.forEach((msg, idx) => {
            if (msg.characterId && !chars.has(msg.characterId)) {
              chars.set(msg.characterId, {
                name: msg.characterId,
                color: colors[idx % colors.length]
              });
            }
          });

          return Array.from(chars.values());
        }

        previewEpisodeImport() {
          if (!this.currentStory) {
            alert('‚ùå –í—ã–±–µ—Ä–∏ –∏—Å—Ç–æ—Ä–∏—é –≤ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä–µ');
            return;
          }

          const format = document.getElementById('episodeImportFormat').value;
          const text = document.getElementById('episodeImportText').value.trim();

          if (!text) { alert('‚ùå –í—Å—Ç–∞–≤—å —Ç–µ–∫—Å—Ç –∏–ª–∏ –≤—ã–±–µ—Ä–∏ —Ñ–∞–π–ª'); return; }

          this.episodeImportMessages = this.parseImportText(text, format);
          if (this.episodeImportMessages.length === 0) { alert('‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Å–ø–∞—Ä—Å–∏—Ç—å'); return; }

          const preview = document.getElementById('episodePreviewMessages');
          preview.innerHTML = this.episodeImportMessages.slice(0, 10).map(msg => `
            <div style="padding:8px;margin:5px 0;background:var(--bg-primary);border-radius:4px;">
              <span style="color:var(--accent-secondary);font-weight:bold;">[${msg.type}]</span>
              ${msg.characterId ? `<span style="color:var(--accent-primary);">${msg.characterId}:</span>` : ''}
              <span>${msg.content}</span>
            </div>
          `).join('');

          const chars = this.extractCharacters(this.episodeImportMessages);
          const charsDiv = document.getElementById('episodeImportCharacters');
          if (chars.length > 0) {
            charsDiv.innerHTML = `<strong>–ü–µ—Ä—Å–æ–Ω–∞–∂–∏:</strong><br>` + 
              chars.map(ch => 
                `<span style="background:${ch.color};color:#000;padding:2px 6px;border-radius:3px;margin:2px;display:inline-block;">${ch.name}</span>`
              ).join('');
          }

          document.getElementById('episodeImportPreview').style.display = 'block';
        }

        async confirmEpisodeImport() {
          if (!this.currentStory) { alert('‚ùå –í—ã–±–µ—Ä–∏ –∏—Å—Ç–æ—Ä–∏—é'); return; }
          if (!this.episodeImportMessages || this.episodeImportMessages.length === 0) { alert('‚ùå –ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π'); return; }

          try {
            const newEpisodeRef = await db.collection('episodes').add({
              storyId: this.currentStory.id,
              episodeNumber: (this.currentStory.episodesCount || 0) + 1,
              title: '–ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —ç–ø–∏–∑–æ–¥',
              status: 'draft',
              createdAt: new Date(),
              updatedAt: new Date()
            });
            const episodeId = newEpisodeRef.id;

            const chars = this.extractCharacters(this.episodeImportMessages);
            const charMap = {};
            for (const ch of chars) {
              const docRef = await db.collection('story_characters').add({
                name: ch.name, color: ch.color, bio: '–ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω', storyId: this.currentStory.id,
                isLocal: false, createdAt: new Date(), updatedAt: new Date()
              });
              charMap[ch.name] = docRef.id;
            }

            for (const msg of this.episodeImportMessages) {
              const charId = msg.characterId ? charMap[msg.characterId] : null;
              await db.collection('episode_messages').add({
                episodeId: episodeId, storyId: this.currentStory.id,
                type: msg.type, content: msg.content, characterId: charId,
                delay: msg.delay, order: msg.order, createdAt: new Date()
              });
            }

            alert('‚úÖ –ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–æ: ' + this.episodeImportMessages.length + ' —Å–æ–æ–±—â–µ–Ω–∏–π –≤ –Ω–æ–≤—ã–π —ç–ø–∏–∑–æ–¥');
            document.getElementById('episodeImportText').value = '';
            document.getElementById('episodeImportPreview').style.display = 'none';
            this.episodeImportMessages = [];
            await this.loadConstructorData(this.currentStory.id);
            await this.loadEpisodeData(episodeId);
          } catch (error) {
            console.error('–û—à–∏–±–∫–∞:', error);
            alert('‚ùå –û—à–∏–±–∫–∞: ' + error.message);
          }
        }

        startRealtimeListeners() {
          const self = this;
          db.collection('episodes').onSnapshot(function(snapshot) {
            snapshot.docChanges().forEach(function(change) {
              if (change.type === 'added' || change.type === 'modified') {
                const episode = change.doc.data();
                self.updateStoryEpisodeStats(episode.storyId);
                if (change.type === 'added' && episode.status === 'published') {
                  self.notifyNewEpisode(episode, change.doc.id);
                }
              }
            });
          });
          db.collection('stories').onSnapshot(function(snapshot) {
            snapshot.docChanges().forEach(function(change) {
              if (change.type === 'modified') {
                const story = change.doc.data();
                console.log('üì° –ò—Å—Ç–æ—Ä–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∞:', change.doc.id, story);
                if (self.currentStory && self.currentStory.id === change.doc.id) {
                  self.currentStory = { id: change.doc.id, ...story };
                  self.loadConstructorData(change.doc.id);
                }
              }
            });
          });
        }

        async updateStoryEpisodeStats(storyId) {
          try {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ –∏—Å—Ç–æ—Ä–∏—è
            const storyDoc = await db.collection('stories').doc(storyId).get();
            if (!storyDoc.exists) {
              console.log('‚ö†Ô∏è –ò—Å—Ç–æ—Ä–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞:', storyId);
              return;
            }

            const episodes = await db.collection('episodes')
              .where('storyId', '==', storyId)
              .where('status', '==', 'published')
              .get();

            const count = episodes.size;
            const sortedDocs = episodes.docs.sort((a, b) => {
              const aNum = a.data().episodeNumber || 0;
              const bNum = b.data().episodeNumber || 0;
              return bNum - aNum;
            });
            const lastDoc = sortedDocs[0];
            const lastEpisodeDate = lastDoc?.data()?.publishDate || null;

            await db.collection('stories').doc(storyId).update({
              episodesCount: count,
              lastEpisodeDate: lastEpisodeDate,
              updatedAt: new Date()
            });

            console.log('üîÑ episodesCount –æ–±–Ω–æ–≤–ª–µ–Ω –¥–ª—è', storyId, ':', count);
          } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è episodesCount:', error);
          }
        }

        async notifyNewEpisode(episode, episodeId) {
          try {
            const story = await db.collection('stories').doc(episode.storyId).get();
            if (!story.exists) return;

            const storyData = story.data();
            const message = `üéâ –ù–æ–≤—ã–π —ç–ø–∏–∑–æ–¥: "${storyData.title}" - ${episode.title || '–≠–ø–∏–∑–æ–¥ ' + episode.episodeNumber}`;

            console.log(message);

            // –°–æ—Ö—Ä–∞–Ω—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤ –ë–î
            if (episodeId) {
              await db.collection('notifications').add({
                storyId: episode.storyId,
                episodeId: episodeId,
                message: message,
                type: 'new_episode',
                createdAt: new Date(),
                read: false
              });
            }

            // Web Notifications API
            if ('Notification' in window && Notification.permission === 'granted') {
              new Notification('CRAWL.STORIES', {
                body: message,
                icon: 'üìñ'
              });
            }
          } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è:', error);
          }
        }

        // –ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–ò–ï –°–¢–ê–¢–£–°–´ –ò –†–ê–°–ü–ò–°–ê–ù–ò–ï
        startAutoPublishScheduler() {
          setInterval(() => this.checkScheduledEpisodes(), 60000); // –ö–∞–∂–¥—É—é –º–∏–Ω—É—Ç—É
        }

        async checkScheduledEpisodes() {
          try {
            const now = new Date();
            const allScheduled = await db.collection('episodes')
              .where('status', '==', 'scheduled')
              .get();

            for (const doc of allScheduled.docs) {
              const episode = doc.data();
              const publishDate = episode.publishDate ? 
                (episode.publishDate.toDate ? episode.publishDate.toDate() : new Date(episode.publishDate))
                : null;

              if (publishDate && publishDate <= now) {
                await db.collection('episodes').doc(doc.id).update({
                  status: 'published',
                  publishDate: now,
                  updatedAt: now
                });
                console.log('‚úÖ –≠–ø–∏–∑–æ–¥ –∞–≤—Ç–æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω:', doc.id);
                await this.updateStoryStatusOnEpisodePublish(episode.storyId, episode.episodeNumber);
              }
            }
          } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –∞–≤—Ç–æ-–ø—É–±–ª–∏–∫–∞—Ü–∏–∏:', error);
          }
        }

        async updateStoryStatusOnEpisodePublish(storyId, episodeNumber) {
          try {
            const storyDoc = await db.collection('stories').doc(storyId).get();
            if (!storyDoc.exists) return;

            const story = storyDoc.data();
            const currentStatus = story.status || 'announced';

            // –ï—Å–ª–∏ —ç—Ç–æ –ø–µ—Ä–≤—ã–π —ç–ø–∏–∑–æ–¥ - –º–µ–Ω—è–µ–º —Å—Ç–∞—Ç—É—Å —Å "announced" –Ω–∞ "new"
            if (episodeNumber === 1 && currentStatus === 'announced') {
              await db.collection('stories').doc(storyId).update({
                status: 'new',
                updatedAt: new Date(),
                firstEpisodeDate: new Date()
              });
              console.log('‚úÖ –ò—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∞ –Ω–∞ "–ù–æ–≤–∏–Ω–∫–∞":', storyId);
            }

            // –ï—Å–ª–∏ —É–∂–µ 2+ —ç–ø–∏–∑–æ–¥–∞ - –º–µ–Ω—è–µ–º "new" –Ω–∞ "ongoing"
            const episodeCount = await db.collection('episodes')
              .where('storyId', '==', storyId)
              .where('status', '==', 'published')
              .get();

            if (episodeCount.size >= 2 && currentStatus === 'new') {
              await db.collection('stories').doc(storyId).update({
                status: 'ongoing',
                updatedAt: new Date()
              });
              console.log('‚úÖ –ò—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∞ –Ω–∞ "–ü—Ä–æ–¥–æ–ª–∂–∞–µ—Ç—Å—è":', storyId);
            }

            // –û–±–Ω–æ–≤–ª—è–µ–º episodesCount –∏ lastEpisodeDate
            await db.collection('stories').doc(storyId).update({
              episodesCount: episodeCount.size,
              lastEpisodeDate: new Date(),
              updatedAt: new Date()
            });
          } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞:', error);
          }
        }

        async checkAndUnblockAnnouncedStories() {
          try {
            const now = new Date();
            const allAnnounced = await db.collection('stories')
              .where('status', '==', 'announced')
              .get();

            for (const doc of allAnnounced.docs) {
              const story = doc.data();
              const firstEpisodeDate = story.firstEpisodeDate ? 
                (story.firstEpisodeDate.toDate ? story.firstEpisodeDate.toDate() : new Date(story.firstEpisodeDate)) 
                : null;

              if (firstEpisodeDate && firstEpisodeDate <= now) {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –µ—Å—Ç—å –ª–∏ —É–∂–µ –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–Ω—ã–µ —ç–ø–∏–∑–æ–¥—ã
                const episodes = await db.collection('episodes')
                  .where('storyId', '==', doc.id)
                  .where('status', '==', 'published')
                  .get();

                if (episodes.size > 0) {
                  // –ú–µ–Ω—è–µ–º —Å—Ç–∞—Ç—É—Å –Ω–∞ "new"
                  await db.collection('stories').doc(doc.id).update({
                    status: 'new',
                    updatedAt: new Date()
                  });
                  console.log('‚úÖ –ê–Ω–æ–Ω—Å —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω:', doc.id);
                }
              }
            }
          } catch (error) {
            console.error('–û—à–∏–±–∫–∞ —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –∞–Ω–æ–Ω—Å–æ–≤:', error);
          }
        }

        getDragAfterElement(container, y) {
          const draggableElements = [
            ...container.querySelectorAll(
              ".message-editor-item:not(.dragging)",
            ),
          ];

          return draggableElements.reduce(
            (closest, child) => {
              const box = child.getBoundingClientRect();
              const offset = y - box.top - box.height / 2;
              if (offset < 0 && offset > closest.offset) {
                return { offset: offset, element: child };
              } else {
                return closest;
              }
            },
            { offset: Number.NEGATIVE_INFINITY },
          ).element;
        }

        // –ì–†–ê–§–ò–ö –ü–£–ë–õ–ò–ö–ê–¶–ò–ô
        async renderSchedule() {
          const container = document.getElementById("scheduleList");
          if (!container) return;

          const scheduledStories = this.stories.filter(
            (story) =>
              story.publishDate && new Date(story.publishDate) > new Date(),
          );

          if (scheduledStories.length === 0) {
            container.innerHTML = `
            <div class="empty-state">
              <div class="icon">üìÖ</div>
              <p>–ù–µ—Ç –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –ø—É–±–ª–∏–∫–∞—Ü–∏–π</p>
            </div>
          `;
            return;
          }

          container.innerHTML = scheduledStories
            .map((story) => {
              const publishDate = this.getStoryDate(story.publishDate);
              const timeUntil = this.getTimeUntil(publishDate);

              return `
            <div class="timeline-item">
              <div class="timeline-info">
                <h4>${story.title}</h4>
                <p>${story.description || "–ë–µ–∑ –æ–ø–∏—Å–∞–Ω–∏—è"}</p>
              </div>
              <div class="timeline-date">
                <div class="publish-date">${publishDate.toLocaleString()}</div>
                <div class="publish-status">${timeUntil}</div>
              </div>
            </div>
          `;
            })
            .join("");
        }

        getTimeUntil(date) {
          const now = new Date();
          const diff = date.getTime() - now.getTime();
          const days = Math.floor(diff / (1000 * 60 * 60 * 24));
          const hours = Math.floor(
            (diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60),
          );

          if (days > 0) {
            return `–ß–µ—Ä–µ–∑ ${days} –¥–Ω–µ–π ${hours} —á–∞—Å–æ–≤`;
          } else if (hours > 0) {
            return `–ß–µ—Ä–µ–∑ ${hours} —á–∞—Å–æ–≤`;
          } else {
            return "–°–∫–æ—Ä–æ";
          }
        }

        async clearSchedule() {
          if (
            !confirm(
              "–û—á–∏—Å—Ç–∏—Ç—å –≤–µ—Å—å –≥—Ä–∞—Ñ–∏–∫ –ø—É–±–ª–∏–∫–∞—Ü–∏–π? –í—Å–µ –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∏—Å—Ç–æ—Ä–∏–∏ –±—É–¥—É—Ç —Å–Ω—è—Ç—ã —Å –ø—É–±–ª–∏–∫–∞—Ü–∏–∏.",
            )
          ) {
            return;
          }

          try {
            const batch = db.batch();
            const scheduledStories = this.stories.filter(
              (story) =>
                story.publishDate && new Date(story.publishDate) > new Date(),
            );

            scheduledStories.forEach((story) => {
              const storyRef = db.collection("stories").doc(story.id);
              batch.update(storyRef, {
                publishDate: null,
                published: false,
                updatedAt: new Date(),
              });
            });

            await batch.commit();
            await this.loadData();
            this.renderSchedule();
            alert("‚úÖ –ì—Ä–∞—Ñ–∏–∫ –ø—É–±–ª–∏–∫–∞—Ü–∏–π –æ—á–∏—â–µ–Ω");
          } catch (error) {
            console.error("‚ùå –û—à–∏–±–∫–∞ –æ—á–∏—Å—Ç–∫–∏ –≥—Ä–∞—Ñ–∏–∫–∞:", error);
            alert("‚ùå –û—à–∏–±–∫–∞ –æ—á–∏—Å—Ç–∫–∏ –≥—Ä–∞—Ñ–∏–∫–∞ –ø—É–±–ª–∏–∫–∞—Ü–∏–π");
          }
        }

        /* THEME MANAGEMENT */
        async initTheme() {
          try {
            const setting = await this.loadThemeSetting();
            const select = document.getElementById("themeSelect");
            const auto = document.getElementById("themeAuto");
            if (setting) {
              if (setting.theme) select.value = setting.theme;
              else select.value = "none";
              auto.checked = !!setting.auto;
            }

            // –ï—Å–ª–∏ –µ—Å—Ç—å –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–∞—è Fear week ‚Äî –ø—Ä–∏–º–µ–Ω—è–µ–º –µ—ë –ø–æ–≤–µ—Ä—Ö –≤—Å–µ–≥–æ
            if (
              setting &&
              setting.themeSettings &&
              setting.themeSettings.fear &&
              setting.themeSettings.fear.forceUntil
            ) {
              const until = new Date(setting.themeSettings.fear.forceUntil);
              if (
                until > new Date() &&
                setting.themeSettings.fear.enabled !== false
              ) {
                this.applyTheme("fear");
                return;
              }
            }

            // –ï—Å–ª–∏ –∞–≤—Ç–æ ‚Äî –æ–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–µ–º—É –ø–æ –¥–∞—Ç–µ
            if (auto.checked) {
              const detected = this.detectAutoTheme();
              this.applyTheme(detected);
            } else if (select.value && select.value !== "none") {
              this.applyTheme(select.value);
            } else {
              this.applyTheme(null);
            }
          } catch (e) {
            console.warn("initTheme error", e);
          }
        }

        applyTheme(themeName) {
          // –£–±–∏—Ä–∞–µ–º —Å—Ç–∞—Ä—ã–µ –∫–ª–∞—Å—Å—ã
          document.documentElement.classList.remove(
            "theme-newyear",
            "theme-halloween",
            "theme-valentine",
            "theme-fear",
          );
          this.clearSeasonalEffects();
          if (!themeName) return;
          switch (themeName) {
            case "newyear":
              document.documentElement.classList.add("theme-newyear");
              break;
            case "halloween":
              document.documentElement.classList.add("theme-halloween");
              break;
            case "valentine":
              document.documentElement.classList.add("theme-valentine");
              break;
            case "fear":
              document.documentElement.classList.add("theme-fear");
              break;
          }
          this.createEffectsForTheme(themeName);
        }

        detectAutoTheme() {
          const now = new Date();
          const month = now.getMonth() + 1; // 1..12
          const day = now.getDate();
          // New Year: Dec 20 - Jan 10
          if ((month === 12 && day >= 20) || (month === 1 && day <= 10))
            return "newyear";
          // Halloween: Oct 25 - Nov 5
          if ((month === 10 && day >= 25) || (month === 11 && day <= 5))
            return "halloween";
          // Valentine: Feb 7 - Feb 16
          if (month === 2 && day >= 7 && day <= 16) return "valentine";
          // Fear week: user-managed ‚Äî not auto
          return null;
        }

        async loadThemeSetting() {
          // –ü–æ–ø—ã—Ç–∫–∞ –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑ Firestore, –∏–Ω–∞—á–µ –∏–∑ localStorage
          try {
            const doc = await db.collection("settings").doc("theme").get();
            if (doc.exists) return doc.data();
          } catch (e) {
            console.warn("loadThemeSetting firestore failed", e);
          }
          try {
            const raw = localStorage.getItem("siteTheme");
            if (raw) return JSON.parse(raw);
          } catch (e) {}
          return null;
        }

        async saveThemeSetting(setting) {
          // –°–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Ç–µ–º—ã: –µ—Å–ª–∏ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–π –∞–¥–º–∏–Ω ‚Äî –≤ Firestore, –∏–Ω–∞—á–µ —Ç–æ–ª—å–∫–æ –≤ localStorage
          try {
            const canWrite = await this.isUserAdmin();
            if (canWrite) {
              await db.collection("settings").doc("theme").set(setting);
            } else {
              console.warn(
                "–¢—Ä–µ–±—É–µ—Ç—Å—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –¥–ª—è –∑–∞–ø–∏—Å–∏ –≤ Firestore. –°–æ—Ö—Ä–∞–Ω—è–µ–º –ª–æ–∫–∞–ª—å–Ω–æ.",
              );
            }
          } catch (e) {
            console.warn("saveThemeSetting failed firestore", e);
          }
          try {
            localStorage.setItem("siteTheme", JSON.stringify(setting));
          } catch (e) {}
        }

        async clearThemeSetting() {
          try {
            await db.collection("settings").doc("theme").delete();
          } catch (e) {}
          try {
            localStorage.removeItem("siteTheme");
          } catch (e) {}
        }

        createEffectsForTheme(theme, overrideCfg = null) {
          this.clearSeasonalEffects();
          const container = document.createElement("div");
          container.id = "seasonal-effects";
          document.body.appendChild(container);

          // –ü–æ–ø—Ä–æ–±—É–µ–º —á–∏—Ç–∞—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ (localStorage –±—ã—Å—Ç—Ä—ã–π –ø—É—Ç—å)
          let cfg = null;
          try {
            const raw = localStorage.getItem("siteTheme");
            if (raw) {
              const parsed = JSON.parse(raw);
              cfg =
                parsed.themeSettings && theme
                  ? parsed.themeSettings[theme]
                  : null;
            }
          } catch (e) {
            cfg = null;
          }

          // allow overrides for live-preview (passed directly)
          const frequency =
            overrideCfg && typeof overrideCfg.frequency === "number"
              ? Math.max(1, overrideCfg.frequency)
              : cfg && cfg.frequency
                ? Math.max(1, cfg.frequency)
                : 1;
          const intensity =
            overrideCfg && typeof overrideCfg.intensity === "number"
              ? Math.min(1, Math.max(0, overrideCfg.intensity))
              : cfg && typeof cfg.intensity === "number"
                ? Math.min(1, Math.max(0, cfg.intensity))
                : 0.5;

          // Helper to compute count from base by frequency and intensity
          const computeCount = (base) =>
            Math.max(1, Math.round(base * frequency * (0.5 + intensity)));

          if (
            theme === "newyear" &&
            document.body.classList.contains("winter-theme")
          ) {
            const count = computeCount(18);
            for (let i = 0; i < count; i++) {
              const s = document.createElement("div");
              s.className = "snowflake effect-item";
              s.textContent = "‚ùÑ";
              s.style.left = Math.random() * 100 + "%";
              const size = Math.round(
                (6 + Math.random() * 14) * (0.5 + intensity),
              );
              s.style.fontSize = size + "px";
              s.style.animationDuration =
                (5 + Math.random() * 6) / (0.5 + intensity) + "s";
              s.style.opacity = 0.4 + Math.random() * 0.6 * intensity;
              container.appendChild(s);
            }
            const icon = document.createElement("div");
            icon.className = "corner-icon";
            icon.style.right = "12px";
            icon.style.top = "12px";
            icon.textContent = "üéÑ";
            container.appendChild(icon);
          }

          if (theme === "halloween") {
            const count = computeCount(6);
            for (let i = 0; i < count; i++) {
              const b = document.createElement("div");
              b.className = "effect-item bat";
              b.textContent = "ü¶á";
              b.style.left = Math.random() * 100 + "%";
              b.style.top = 5 + Math.random() * 50 + "%";
              b.style.opacity = 0.6 + 0.4 * intensity;
              b.style.transform = `scale(${0.8 + 0.8 * intensity})`;
              container.appendChild(b);
            }
            const fog = document.createElement("div");
            fog.className = "fog-overlay";
            fog.style.opacity = 0.2 + 0.6 * intensity;
            container.appendChild(fog);
          }

          if (theme === "valentine") {
            const count = computeCount(12);
            for (let i = 0; i < count; i++) {
              const h = document.createElement("div");
              h.className = "heart effect-item";
              h.textContent = "‚ù§";
              h.style.left = Math.random() * 100 + "%";
              h.style.bottom = -10 - Math.random() * 40 + "px";
              h.style.animationDuration =
                (3 + Math.random() * 5) / (0.5 + intensity) + "s";
              h.style.opacity = 0.5 + 0.5 * intensity;
              h.style.fontSize = Math.round(12 + 12 * intensity) + "px";
              container.appendChild(h);
            }
          }

          if (theme === "fear") {
            const icon = document.createElement("div");
            icon.className = "corner-icon";
            icon.style.left = "12px";
            icon.style.top = "12px";
            icon.textContent = "‚ö†Ô∏è";
            icon.style.opacity = 0.7 + 0.3 * intensity;
            icon.style.transform = `scale(${1 + intensity * 0.5})`;
            container.appendChild(icon);
          }
        }

        clearSeasonalEffects() {
          const old = document.getElementById("seasonal-effects");
          if (old) old.remove();
        }

        /* AUTH (Firebase) */
        initAuth() {
          if (!firebase || !firebase.auth) return;
          firebase.auth().onAuthStateChanged(async (user) => {
            this.currentUser = user || null;
            const info = document.getElementById("adminUserInfo");
            const btnIn = document.getElementById("btnSignInAuth");
            const btnOut = document.getElementById("btnSignOutAuth");
            if (user) {
              info.textContent = user.email || user.uid;
              if (btnIn) btnIn.style.display = "none";
              if (btnOut) btnOut.style.display = "inline-block";
              // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–¥–º–∏–Ω–æ–º –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å —Ç–æ–ª—å–∫–æ —Ç–æ–≥–¥–∞
              try {
                const isAdmin = await this.isUserAdmin();
                if (isAdmin) {
                  this.showAdminInterface();
                } else {
                  // –ï—Å–ª–∏ –≤–æ—à—ë–ª –Ω–µ-–∞–¥–º–∏–Ω ‚Äî —Å–∫—Ä—ã–≤–∞–µ–º –∞–¥–º–∏–Ω–∫—É –∏ —Å–æ–æ–±—â–∞–µ–º
                  this.showLoginScreen();
                  console.warn("–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ —è–≤–ª—è–µ—Ç—Å—è –∞–¥–º–∏–Ω–æ–º");
                }
              } catch (e) {
                console.warn("–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ admin status", e);
                this.showLoginScreen();
              }
            } else {
              if (info) info.textContent = "";
              if (btnIn) btnIn.style.display = "inline-block";
              if (btnOut) btnOut.style.display = "none";
              this.showLoginScreen();
            }
          });
        }

        showAuthModal() {
          let modal = document.getElementById("authModal");
          if (!modal) {
            // –°–æ–∑–¥–∞—ë–º modal HTML –µ—Å–ª–∏ –µ—â—ë –Ω–µ —Å–æ–∑–¥–∞–Ω
            modal = document.createElement("div");
            modal.id = "authModal";
            modal.className = "auth-modal";
            modal.innerHTML = `
            <div class="auth-modal-backdrop"></div>
            <div class="auth-modal-sheet">
              <h3>–í—Ö–æ–¥ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞</h3>
              <div class="field"><label>Email</label><input id="authEmail" type="email"/></div>
              <div class="field"><label>–ü–∞—Ä–æ–ª—å</label><input id="authPassword" type="password"/></div>
              <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:8px;">
                <button id="authCancel" class="btn">–û—Ç–º–µ–Ω–∞</button>
                <button id="authSubmit" class="btn btn-primary">–í–æ–π—Ç–∏</button>
              </div>
              <div id="authError" style="color:#f33;margin-top:8px;display:none;"></div>
            </div>
          `;
            document.body.appendChild(modal);

            // –°—Ç–∏–ª–∏ –ø—Ä–æ—Å—Ç—ã–µ, –ª–æ–∫–∞–ª—å–Ω—ã–µ –¥–ª—è –º–æ–¥–∞–ª–∫–∏
            const style = document.createElement("style");
            style.textContent = `
            .auth-modal { position: fixed; inset: 0; display:flex;align-items:center;justify-content:center;z-index:2000; }
            .auth-modal-backdrop { position:absolute; inset:0; background:rgba(0,0,0,0.45); }
            .auth-modal-sheet { position:relative; background:var(--bg); color:var(--text); padding:18px; border-radius:8px; width:320px; box-shadow:0 8px 24px rgba(0,0,0,0.3); }
            .auth-modal-sheet .field { margin-bottom:8px; }
            .auth-modal-sheet input { width:100%; padding:8px; box-sizing:border-box; border:1px solid #ddd; border-radius:4px; background:var(--input-bg); color:var(--text); }
            @keyframes spin { from { transform:rotate(0deg);} to { transform:rotate(360deg);} }
          `;
            document.head.appendChild(style);

            // Events
            modal
              .querySelector("#authCancel")
              .addEventListener("click", () => this.hideAuthModal());
            modal
              .querySelector("#authSubmit")
              .addEventListener("click", () => this.performSignIn());
            modal
              .querySelector(".auth-modal-backdrop")
              .addEventListener("click", () => this.hideAuthModal());
          }

          // reset fields
          const emailEl = document.getElementById("authEmail");
          const pwdEl = document.getElementById("authPassword");
          const err = document.getElementById("authError");
          if (emailEl) emailEl.value = "";
          if (pwdEl) pwdEl.value = "";
          if (err) {
            err.style.display = "none";
            err.textContent = "";
          }

          modal.style.display = "flex";
          const emailFocus = document.getElementById("authEmail");
          if (emailFocus) emailFocus.focus();
        }

        hideAuthModal() {
          const modal = document.getElementById("authModal");
          if (modal) modal.style.display = "none";
        }

        async performSignIn() {
          const email = document.getElementById("authEmail").value;
          const password = document.getElementById("authPassword").value;
          const remember = (document.getElementById("authRemember") || {})
            .checked;
          const err = document.getElementById("authError");
          const submitBtn = document.getElementById("authSubmit");
          const spinner = document.getElementById("authSpinner");
          if (err) {
            err.style.display = "none";
            err.textContent = "";
          }
          if (!email || !password) {
            if (err) {
              err.style.display = "block";
              err.textContent = "–í–≤–µ–¥–∏—Ç–µ email –∏ –ø–∞—Ä–æ–ª—å";
            }
            return;
          }
          try {
            // Set persistence based on "remember me"
            if (
              firebase &&
              firebase.auth &&
              firebase.auth.Auth &&
              firebase.auth.Auth.Persistence
            ) {
              const persistence = remember
                ? firebase.auth.Auth.Persistence.LOCAL
                : firebase.auth.Auth.Persistence.SESSION;
              await firebase.auth().setPersistence(persistence);
            }

            // show spinner / disable button
            if (submitBtn) submitBtn.disabled = true;
            if (spinner) spinner.style.display = "inline-block";

            await firebase.auth().signInWithEmailAndPassword(email, password);

            // –ø—Ä–æ–≤–µ—Ä—è–µ–º, –∞–¥–º–∏–Ω –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
            const ok = await this.isUserAdmin();
            if (ok) {
              if (spinner) spinner.style.display = "none";
              if (submitBtn) submitBtn.disabled = false;
              this.hideAuthModal();
              this.showAdminInterface();
              alert("‚úÖ –í—Ö–æ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω (–∞–¥–º–∏–Ω)");
            } else {
              // –í—ã—à–ª–∏ –∏ –ø–æ–∫–∞–∑–∞–ª–∏ –æ—à–∏–±–∫—É
              try {
                await firebase.auth().signOut();
              } catch (e) {}
              if (spinner) spinner.style.display = "none";
              if (submitBtn) submitBtn.disabled = false;
              if (err) {
                err.style.display = "block";
                err.textContent = "–£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞.";
              }
            }
          } catch (e) {
            console.error("Auth signIn error", e);
            if (spinner) spinner.style.display = "none";
            if (submitBtn) submitBtn.disabled = false;
            if (err) {
              err.style.display = "block";
              err.textContent = e.message || "–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞";
            }
          }
        }

        async performPasswordReset() {
          const email = document.getElementById("authEmail").value;
          const err = document.getElementById("authError");
          if (!email) {
            if (err) {
              err.style.display = "block";
              err.textContent = "–í–≤–µ–¥–∏—Ç–µ email –¥–ª—è —Å–±—Ä–æ—Å–∞ –ø–∞—Ä–æ–ª—è";
            }
            return;
          }
          try {
            await firebase.auth().sendPasswordResetEmail(email);
            alert("–ü–∏—Å—å–º–æ –¥–ª—è —Å–±—Ä–æ—Å–∞ –ø–∞—Ä–æ–ª—è –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –Ω–∞ " + email);
          } catch (e) {
            console.error("Password reset error", e);
            if (err) {
              err.style.display = "block";
              err.textContent = e.message || "–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –ø–∏—Å—å–º–∞";
            }
          }
        }

        async signOut() {
          try {
            await firebase.auth().signOut();
            alert("‚úÖ –í—ã—Ö–æ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω");
          } catch (e) {
            console.error("signOut error", e);
            alert("‚ùå –û—à–∏–±–∫–∞ –≤—ã—Ö–æ–¥–∞");
          }
        }

        async isUserAdmin() {
          try {
            const user = firebase.auth().currentUser;
            if (!user) return false;
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ–ª–ª–µ–∫—Ü–∏—é admins –Ω–∞ –Ω–∞–ª–∏—á–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞ —Å uid
            try {
              const doc = await db.collection("admins").doc(user.uid).get();
              if (doc.exists) return true;
            } catch (e) {}
            // –§–æ–ª–ª–±–µ–∫: –ø—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ email
            try {
              const snap = await db
                .collection("admins")
                .where("email", "==", user.email)
                .get();
              if (!snap.empty) return true;
            } catch (e) {}
            return false;
          } catch (e) {
            console.warn("isUserAdmin error", e);
            return false;
          }
        }

        /* Fear week controls */
        async startFearWeek(days = 7) {
          const until = new Date(Date.now() + days * 24 * 60 * 60 * 1000);
          const setting = (await this.loadThemeSetting()) || {};
          setting.themeSettings = setting.themeSettings || {};
          setting.themeSettings.fear = setting.themeSettings.fear || {};
          setting.themeSettings.fear.enabled = true;
          setting.themeSettings.fear.forceUntil = until.toISOString();
          // –æ—Å—Ç–∞–≤–∏–º —Ç–µ–∫—É—â–∏–µ intensity/frequency –µ—Å–ª–∏ –µ—Å—Ç—å
          await this.saveThemeSetting(setting);
          this.applyTheme("fear");
        }

        async stopFearWeek() {
          const setting = await this.loadThemeSetting();
          if (
            !setting ||
            !setting.themeSettings ||
            !setting.themeSettings.fear
          ) {
            // –ø—Ä–æ—Å—Ç–æ —Å–Ω—è—Ç—å
            await this.clearThemeSetting();
            this.applyTheme(null);
            return;
          }
          setting.themeSettings.fear.enabled = false;
          delete setting.themeSettings.fear.forceUntil;
          await this.saveThemeSetting(setting);
          this.applyTheme(null);
        }
      }

      // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏
      document.addEventListener("DOMContentLoaded", () => {
        window.adminPanel = new AdminPanel();
      });
    </script>
  </body>
</html>
