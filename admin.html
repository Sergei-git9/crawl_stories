<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å CRAWL.STORIES</title>
  
  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-firestore-compat.js"></script>
  
  <script>
    // Firebase –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
    const firebaseConfig = {
      apiKey: "AIzaSyANC4K0-xI-9SvrpoiOp4v-N2XLvCQCALg",
      authDomain: "crawl-stories.firebaseapp.com",
      projectId: "crawl-stories",
      storageBucket: "crawl-stories.firebasestorage.app",
      messagingSenderId: "886479757650",
      appId: "1:886479757650:web:194ad1dd2d02c959bdda8b",
      measurementId: "G-SGC2HF0455"
    };
    
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    console.log('üî• Firebase –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω –≤ –∞–¥–º–∏–Ω–∫–µ');
  </script>
  
  <style>
    /* CRAWL.STORIES - –ê–î–ú–ò–ù –ü–ê–ù–ï–õ–¨ –°–¢–ò–õ–ò */
    :root {
      --bg-primary: #020205;
      --bg-secondary: #0b0b0f;
      --bg-card: #0b0b0f;
      --accent-primary: #FFE81F;
      --accent-secondary: #6366f1;
      --text-primary: #ffffff;
      --text-secondary: #9aa0a6;
      --text-muted: #7f8c8d;
      --chat-bubble-user: #6366f1;
      --chat-bubble-other: #374151;
      --chat-bubble-system: #f59e0b;
      --chat-bubble-thought: #8b5cf6;
      --border-light: rgba(255,255,255,0.1);
      --font-mono: "Courier New", monospace;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      background: var(--bg-primary);
      color: var(--text-primary);
      font-family: var(--font-mono);
      min-height: 100vh;
    }

    /* LOGIN SCREEN */
    .login-screen {
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .login-card {
      max-width: 400px;
      width: 100%;
      text-align: center;
    }

    .login-card h2 {
      color: var(--accent-primary);
      margin-bottom: 30px;
    }

    .form-group {
      margin-bottom: 20px;
      text-align: left;
    }

    .form-group label {
      display: block;
      margin-bottom: 8px;
      color: var(--text-secondary);
    }

    .form-group input,
    .form-group textarea,
    .form-group select {
      width: 100%;
      padding: 12px;
      border-radius: 8px;
      border: 1px solid var(--border-light);
      background: #05050a;
      color: #ddd;
      font-family: var(--font-mono);
      font-size: 14px;
    }

    .form-group textarea {
      resize: vertical;
      min-height: 100px;
    }

    .checkbox-group {
      display: flex;
      align-items: center;
      gap: 10px;
      margin: 15px 0;
    }

    .checkbox-group input[type="checkbox"] {
      width: 18px;
      height: 18px;
    }

    .checkbox-group label {
      margin: 0;
      color: var(--text-secondary);
    }

    /* BUTTONS */
    button {
      background: var(--accent-primary);
      color: var(--bg-primary);
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      cursor: pointer;
      font-family: var(--font-mono);
      font-weight: bold;
      transition: opacity 0.3s;
    }

    button:hover { opacity: 0.9; }
    button:disabled { opacity: 0.5; cursor: not-allowed; }

    .btn-small { padding: 8px 16px; font-size: 12px; }
    .btn-secondary { background: transparent; color: var(--accent-primary); border: 1px solid var(--border-light); }
    .btn-danger { background: #ff4444; color: white; }
    .btn-success { background: #4caf50; color: white; }
    .btn-warning { background: #ff9800; color: white; }
    .btn-info { background: var(--accent-secondary); color: white; }

    /* ADMIN INTERFACE */
    .admin-interface { display: none; min-height: 100vh; }

    header {
      padding: 15px 20px;
      border-bottom: 1px solid var(--border-light);
      background: rgba(2,2,5,0.95);
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .header-content {
      display: flex;
      justify-content: space-between;
      align-items: center;
      max-width: 1200px;
      margin: 0 auto;
    }

    /* TABS */
    .tabs {
      display: flex;
      gap: 10px;
      margin: 20px auto;
      max-width: 1200px;
      padding: 0 20px;
      flex-wrap: wrap;
    }

    .tab {
      padding: 10px 20px;
      background: transparent;
      border: 1px solid var(--border-light);
      color: var(--text-secondary);
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s;
    }

    .tab.active {
      background: var(--accent-primary);
      color: var(--bg-primary);
    }

    .tab-content {
      display: none;
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }

    .tab-content.active { display: block; }

    /* STORIES GRID */
    .stories-grid {
      display: grid;
      gap: 20px;
      grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
    }

    .story-card {
      background: var(--bg-card);
      border-radius: 12px;
      padding: 20px;
      border: 1px solid var(--border-light);
      transition: border-color 0.3s;
    }

    .story-card:hover {
      border-color: rgba(255,232,31,0.3);
    }

    .story-card.scheduled {
      border-color: #ffc107;
    }

    .story-card.soon {
      border-color: #9e9e9e;
    }

    .story-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 10px;
      gap: 10px;
    }

    .story-title {
      color: var(--accent-primary);
      font-size: 18px;
      margin: 0;
      line-height: 1.3;
      flex: 1;
    }

    .story-meta {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    /* BADGES */
    .badge {
      padding: 4px 8px;
      border-radius: 6px;
      font-size: 11px;
      white-space: nowrap;
      font-weight: bold;
    }

    .badge.category { 
      background: rgba(100,200,255,0.1); 
      color: #64c8ff; 
    }

    .badge.episode { 
      background: rgba(255,200,100,0.1); 
      color: #ffc864; 
    }

    .badge.status-published { 
      background: rgba(76,175,80,0.1); 
      color: #4caf50; 
    }

    .badge.status-scheduled { 
      background: rgba(255,193,7,0.1); 
      color: #ffc107; 
    }

    .badge.status-soon { 
      background: rgba(158,158,158,0.1); 
      color: #9e9e9e; 
    }

    .badge.status-hidden { 
      background: rgba(158,158,158,0.1); 
      color: #9e9e9e; 
      border: 1px dashed #9e9e9e; 
    }

    .story-desc {
      color: var(--text-secondary);
      margin-bottom: 15px;
      font-size: 14px;
      line-height: 1.4;
    }

    .story-date {
      font-size: 12px;
      color: var(--text-muted);
      margin-top: 8px;
    }

    .story-actions {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-top: 15px;
    }

    /* CONSTRUCTOR LAYOUT */
    .constructor-layout {
      display: grid;
      grid-template-columns: 300px 1fr 350px;
      gap: 20px;
      height: calc(100vh - 200px);
    }

    /* CHARACTERS PANEL */
    .characters-panel {
      background: var(--bg-card);
      border-radius: 12px;
      padding: 20px;
      border: 1px solid var(--border-light);
      overflow-y: auto;
    }

    .panel-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .panel-title {
      color: var(--accent-primary);
      font-size: 18px;
    }

    .character-list {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .character-item {
      background: rgba(255,255,255,0.05);
      padding: 15px;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s;
      border: 1px solid transparent;
    }

    .character-item.active {
      border-color: var(--accent-primary);
      background: rgba(255,232,31,0.1);
    }

    .character-item:hover {
      border-color: var(--accent-secondary);
    }

    .character-header {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 8px;
    }

    .character-avatar {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: var(--accent-secondary);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      color: white;
      flex-shrink: 0;
    }

    .character-name {
      font-weight: bold;
      color: var(--text-primary);
    }

    .character-role {
      font-size: 12px;
      color: var(--text-secondary);
    }

    /* CHAT PREVIEW */
    .chat-preview {
      background: #17212b;
      border-radius: 12px;
      border: 1px solid var(--border-light);
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .preview-header {
      background: #0e1621;
      padding: 15px 20px;
      border-bottom: 1px solid var(--border-light);
    }

    .preview-messages {
      flex: 1;
      padding: 20px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .message-preview {
      max-width: 70%;
      display: flex;
      flex-direction: column;
      animation: messageAppear 0.3s ease-out;
    }

    .message-preview.user { align-self: flex-end; }
    .message-preview.other { align-self: flex-start; }
    .message-preview.system { align-self: center; max-width: 90%; }
    .message-preview.thought { align-self: flex-end; }

    .message-bubble-preview {
      padding: 12px 16px;
      border-radius: 18px;
      word-wrap: break-word;
      line-height: 1.4;
      font-size: 14px;
    }

    .message-preview.user .message-bubble-preview { 
      background: var(--chat-bubble-user); 
      border-bottom-right-radius: 6px; 
    }

    .message-preview.other .message-bubble-preview { 
      background: var(--chat-bubble-other); 
      border-bottom-left-radius: 6px; 
    }

    .message-preview.system .message-bubble-preview { 
      background: var(--chat-bubble-system); 
      border-radius: 12px; 
      text-align: center; 
      font-style: italic; 
    }

    .message-preview.thought .message-bubble-preview { 
      background: var(--chat-bubble-thought); 
      border: 1px dashed var(--accent-secondary); 
      border-radius: 18px; 
      font-style: italic; 
    }

    /* MESSAGES EDITOR */
    .messages-editor {
      background: var(--bg-card);
      border-radius: 12px;
      padding: 20px;
      border: 1px solid var(--border-light);
      overflow-y: auto;
    }

    .message-list {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-bottom: 20px;
    }

    .message-editor-item {
      background: rgba(255,255,255,0.05);
      padding: 15px;
      border-radius: 8px;
      border: 1px solid transparent;
      cursor: grab;
      transition: all 0.3s;
    }

    .message-editor-item:hover {
      border-color: var(--accent-secondary);
    }

    .message-editor-item.dragging {
      opacity: 0.5;
      border: 2px dashed var(--accent-primary);
    }

    .message-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }

    .message-type-badge {
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: bold;
    }

    .badge-text { 
      background: rgba(99, 102, 241, 0.2); 
      color: var(--accent-secondary); 
    }

    .badge-thought { 
      background: rgba(139, 92, 246, 0.2); 
      color: var(--chat-bubble-thought); 
    }

    .badge-system { 
      background: rgba(245, 158, 11, 0.2); 
      color: var(--chat-bubble-system); 
    }

    .message-actions {
      display: flex;
      gap: 5px;
    }

    .message-content-preview {
      font-size: 14px;
      color: var(--text-secondary);
      margin-bottom: 8px;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }

    .message-meta {
      display: flex;
      justify-content: space-between;
      font-size: 12px;
      color: var(--text-muted);
    }

    /* MESSAGE FORM */
    .message-form {
      background: rgba(255,255,255,0.03);
      padding: 20px;
      border-radius: 8px;
      border: 1px solid var(--border-light);
    }

    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
      margin-bottom: 15px;
    }

    .form-actions {
      display: flex;
      gap: 10px;
      margin-top: 20px;
      flex-wrap: wrap;
    }

    /* CHARACTER FORM */
    .character-form {
      background: rgba(255,255,255,0.03);
      padding: 20px;
      border-radius: 8px;
      border: 1px solid var(--border-light);
      margin-top: 20px;
    }

    /* DROP ZONE */
    .drop-zone {
      border: 2px dashed var(--accent-primary);
      border-radius: 8px;
      padding: 20px;
      text-align: center;
      color: var(--text-secondary);
      margin: 10px 0;
      transition: all 0.3s;
    }

    .drop-zone.active {
      background: rgba(255,232,31,0.1);
      border-color: var(--accent-primary);
    }

    /* SCHEDULE TIMELINE */
    .schedule-timeline {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .timeline-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .timeline-item {
      background: var(--bg-card);
      border-radius: 12px;
      padding: 15px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border: 1px solid var(--border-light);
      transition: border-color 0.3s;
    }

    .timeline-item:hover {
      border-color: rgba(255,232,31,0.3);
    }

    .timeline-info {
      flex: 1;
    }

    .timeline-date {
      text-align: right;
      min-width: 150px;
    }

    .publish-date {
      color: var(--accent-primary);
      font-weight: bold;
      font-size: 14px;
    }

    .publish-status {
      font-size: 12px;
      color: var(--text-muted);
      margin-top: 4px;
    }

    /* ANIMATIONS */
    @keyframes messageAppear {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* RESPONSIVE */
    @media (max-width: 1024px) {
      .constructor-layout {
        grid-template-columns: 1fr;
        grid-template-rows: auto auto auto;
        height: auto;
      }
      
      .characters-panel,
      .messages-editor {
        max-height: 300px;
      }
    }

    @media (max-width: 768px) {
      .header-content {
        flex-direction: column;
        gap: 15px;
        text-align: center;
      }
      
      .tabs {
        flex-direction: column;
      }
      
      .stories-grid {
        grid-template-columns: 1fr;
      }
      
      .form-row {
        grid-template-columns: 1fr;
      }
      
      .form-actions {
        flex-direction: column;
      }
      
      .story-header {
        flex-direction: column;
      }
      
      .story-meta {
        width: 100%;
        justify-content: flex-start;
      }
      
      .story-actions {
        justify-content: center;
      }
      
      .timeline-item {
        flex-direction: column;
        align-items: flex-start;
        gap: 10px;
      }
      
      .timeline-date {
        text-align: left;
        width: 100%;
      }
    }

    /* LOADING STATES */
    .loading-state {
      text-align: center;
      padding: 40px;
      color: var(--text-secondary);
    }

    .loading-state .icon {
      font-size: 48px;
      margin-bottom: 20px;
    }

    /* EMPTY STATES */
    .empty-state {
      text-align: center;
      padding: 40px;
      color: var(--text-secondary);
    }

    .empty-state .icon {
      font-size: 48px;
      margin-bottom: 20px;
    }

          /* COLOR PICKER STYLES */
    .color-picker {
      margin-top: 10px;
    }

    .color-options {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-bottom: 10px;
    }

    .color-option {
      width: 30px;
      height: 30px;
      border-radius: 50%;
      cursor: pointer;
      border: 2px solid transparent;
      transition: all 0.3s ease;
      position: relative;
    }

    .color-option:hover {
      transform: scale(1.1);
      border-color: var(--text-primary);
    }

    .color-option.selected {
      border-color: var(--accent-primary);
      transform: scale(1.1);
      box-shadow: 0 0 0 2px var(--bg-primary), 0 0 0 4px var(--accent-primary);
    }

    .color-option.selected::after {
      content: "‚úì";
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      color: white;
      font-size: 14px;
      font-weight: bold;
      text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
    }

    /* –î–ª—è —Å–≤–µ—Ç–ª—ã—Ö —Ü–≤–µ—Ç–æ–≤ –º–µ–Ω—è–µ–º —Ü–≤–µ—Ç –≥–∞–ª–æ—á–∫–∏ */
    .color-option[data-color="#FFE81F"].selected::after,
    .color-option[data-color="#8bc34a"].selected::after {
      color: var(--bg-primary);
    }
    
  </style>
</head>
<body>
  <div id="loginScreen" class="login-screen">
    <div class="login-card">
      <h2>üîê –í—Ö–æ–¥ –≤ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</h2>
      <form id="loginForm">
        <div class="form-group">
          <label>–ü–∞—Ä–æ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞</label>
          <input type="password" id="adminPassword" required>
        </div>
        <button type="submit">–í–æ–π—Ç–∏ –≤ –∞–¥–º–∏–Ω–∫—É</button>
      </form>
    </div>
  </div>

  <div id="adminInterface" class="admin-interface">
    <header>
      <div class="header-content">
        <h1>‚öôÔ∏è –ê–î–ú–ò–ù-–ü–ê–ù–ï–õ–¨ CRAWL.STORIES</h1>
        <div>
          <button id="btnRefresh" class="btn btn-secondary">üîÑ –û–±–Ω–æ–≤–∏—Ç—å</button>
          <button id="btnLogout" class="btn btn-secondary">üö™ –í—ã–π—Ç–∏</button>
          <button id="btnBackToSite" class="btn">üåê –ù–∞ —Å–∞–π—Ç</button>
        </div>
      </div>
    </header>

    <div class="tabs">
      <button class="tab active" data-tab="stories">üìö –í—Å–µ –∏—Å—Ç–æ—Ä–∏–∏</button>
      <button class="tab" data-tab="constructor">üõ†Ô∏è –ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä –∏—Å—Ç–æ—Ä–∏–π</button>
      <button class="tab" data-tab="schedule">üìÖ –ì—Ä–∞—Ñ–∏–∫ –ø—É–±–ª–∏–∫–∞—Ü–∏–π</button>
      <button class="tab" data-tab="new-story">‚ûï –ù–æ–≤–∞—è –∏—Å—Ç–æ—Ä–∏—è</button>
    </div>

    <div id="storiesTab" class="tab-content active">
      <div style="text-align: center; margin-bottom: 30px;">
        <button class="btn btn-success" id="btnQuickCreate" style="font-size: 16px; padding: 15px 30px;">
          üöÄ –ë—ã—Å—Ç—Ä–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–∏
        </button>
      </div>
      <div id="storiesList" class="stories-grid">
        <div class="loading-state">
          <div class="icon">‚è≥</div>
          <p>–ó–∞–≥—Ä—É–∑–∫–∞ –∏—Å—Ç–æ—Ä–∏–π...</p>
        </div>
      </div>
    </div>

    <div id="constructorTab" class="tab-content">
      <div class="constructor-layout">
        <div class="characters-panel">
          <div class="panel-header">
            <h3 class="panel-title">üë• –ü–µ—Ä—Å–æ–Ω–∞–∂–∏</h3>
            <button class="btn btn-success btn-small" id="btnAddCharacter">+ –î–æ–±–∞–≤–∏—Ç—å</button>
          </div>
          <div class="character-list" id="characterList">
            <div class="empty-state">
              <div class="icon">üë•</div>
              <p>–í—ã–±–µ—Ä–∏—Ç–µ –∏—Å—Ç–æ—Ä–∏—é –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è</p>
            </div>
          </div>
          
          <!-- –§–æ—Ä–º–∞ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞ -->
          <div class="character-form" id="characterForm" style="display: none;">
            <div class="form-group">
              <label>–ò–º—è –ø–µ—Ä—Å–æ–Ω–∞–∂–∞</label>
              <input type="text" id="characterName" required>
            </div>
            <div class="form-group">
              <label>–û–ø–∏—Å–∞–Ω–∏–µ/—Ä–æ–ª—å</label>
              <textarea id="characterBio" rows="3"></textarea>
            </div>
            <div class="form-group">
  <label>–¶–≤–µ—Ç –∞–≤–∞—Ç–∞—Ä–∞</label>
  <div class="color-picker">
    <div class="color-options">
      <div class="color-option selected" data-color="#6366f1" style="background-color: #6366f1"></div>
      <div class="color-option" data-color="#FFE81F" style="background-color: #FFE81F"></div>
      <div class="color-option" data-color="#4caf50" style="background-color: #4caf50"></div>
      <div class="color-option" data-color="#ff9800" style="background-color: #ff9800"></div>
      <div class="color-option" data-color="#e91e63" style="background-color: #e91e63"></div>
      <div class="color-option" data-color="#9c27b0" style="background-color: #9c27b0"></div>
      <div class="color-option" data-color="#00bcd4" style="background-color: #00bcd4"></div>
      <div class="color-option" data-color="#8bc34a" style="background-color: #8bc34a"></div>
    </div>
    <input type="hidden" id="characterColor" value="#6366f1">
  </div>
</div>
            <div class="form-actions">
              <button type="button" class="btn" id="btnSaveCharacter">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
              <button type="button" class="btn btn-secondary" id="btnCancelCharacter">‚ùå –û—Ç–º–µ–Ω–∞</button>
              <button type="button" class="btn btn-danger" id="btnDeleteCharacter">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å</button>
            </div>
          </div>
        </div>

        <div class="chat-preview">
          <div class="preview-header">
            <h3>üí¨ –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä —á–∞—Ç–∞</h3>
          </div>
          <div class="preview-messages" id="previewMessages">
            <div class="message-preview system">
              <div class="message-bubble-preview">–í—ã–±–µ—Ä–∏—Ç–µ –∏—Å—Ç–æ—Ä–∏—é –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è</div>
            </div>
          </div>
        </div>

        <div class="messages-editor">
          <div class="panel-header">
            <h3 class="panel-title">üí≠ –°–æ–æ–±—â–µ–Ω–∏—è</h3>
            <button class="btn btn-info btn-small" id="btnAddMessage">+ –°–æ–æ–±—â–µ–Ω–∏–µ</button>
          </div>
          
          <div class="message-list" id="messageList">
            <div class="empty-state">
              <div class="icon">üí≠</div>
              <p>–í—ã–±–µ—Ä–∏—Ç–µ –∏—Å—Ç–æ—Ä–∏—é –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è</p>
            </div>
          </div>

          <div class="message-form" id="messageForm" style="display: none;">
            <div class="form-row">
              <div class="form-group">
                <label>–¢–∏–ø —Å–æ–æ–±—â–µ–Ω–∏—è</label>
                <select id="messageType">
                  <option value="text">üí¨ –¢–µ–∫—Å—Ç</option>
                  <option value="thought">ü§î –ú—ã—Å–ª—å</option>
                  <option value="system">‚öôÔ∏è –°–∏—Å—Ç–µ–º–Ω–æ–µ</option>
                </select>
              </div>
              <div class="form-group">
                <label>–ü–µ—Ä—Å–æ–Ω–∞–∂</label>
                <select id="messageCharacter">
                  <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞</option>
                </select>
              </div>
            </div>
            
            <div class="form-group">
              <label>–¢–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è</label>
              <textarea id="messageContent" rows="4" placeholder="–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è..."></textarea>
            </div>
            
            <div class="form-row">
              <div class="form-group">
                <label>–ó–∞–¥–µ—Ä–∂–∫–∞ (–º—Å)</label>
                <input type="number" id="messageDelay" value="2000" min="0" step="500">
              </div>
              <div class="form-group">
                <label>–ü–æ—Ä—è–¥–æ–∫</label>
                <input type="number" id="messageOrder" min="1" value="1">
              </div>
            </div>

            <div class="form-actions">
              <button type="button" class="btn" id="btnSaveMessage">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
              <button type="button" class="btn btn-secondary" id="btnCancelMessage">‚ùå –û—Ç–º–µ–Ω–∞</button>
              <button type="button" class="btn btn-danger" id="btnDeleteMessage">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div id="scheduleTab" class="tab-content">
      <div class="timeline-header">
        <h3>üìÖ –ó–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏</h3>
        <button id="btnClearSchedule" class="btn btn-warning">üßπ –û—á–∏—Å—Ç–∏—Ç—å –≥—Ä–∞—Ñ–∏–∫</button>
      </div>
      <div id="scheduleList" class="schedule-timeline">
        <div class="empty-state">
          <div class="icon">üìÖ</div>
          <p>–ù–µ—Ç –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –ø—É–±–ª–∏–∫–∞—Ü–∏–π</p>
        </div>
      </div>
    </div>

    <div id="newStoryTab" class="tab-content">
      <div class="character-form">
        <h3>‚ûï –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é –∏—Å—Ç–æ—Ä–∏—é</h3>
        <div class="form-group">
          <label>–ù–∞–∑–≤–∞–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–∏</label>
          <input type="text" id="newStoryTitle" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–∏" required>
        </div>
        <div class="form-group">
          <label>–û–ø–∏—Å–∞–Ω–∏–µ</label>
          <textarea id="newStoryDescription" rows="4" placeholder="–ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ —Å—é–∂–µ—Ç–∞..."></textarea>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label>–ö–∞—Ç–µ–≥–æ—Ä–∏—è</label>
            <select id="newStoryCategory">
              <option value="fantasy">üßô –§—ç–Ω—Ç–µ–∑–∏</option>
              <option value="sci-fi">üöÄ –ù–∞—É—á–Ω–∞—è —Ñ–∞–Ω—Ç–∞—Å—Ç–∏–∫–∞</option>
              <option value="horror">üëª –•–æ—Ä—Ä–æ—Ä</option>
              <option value="adventure">üó∫Ô∏è –ü—Ä–∏–∫–ª—é—á–µ–Ω–∏—è</option>
              <option value="mystery">üïµÔ∏è –ú–∏—Å—Ç–∏–∫–∞</option>
              <option value="chat">üí¨ –ß–∞—Ç-–∏—Å—Ç–æ—Ä–∏–∏</option>
            </select>
          </div>
          <div class="form-group">
            <label>–≠–ø–∏–∑–æ–¥</label>
            <input type="number" id="newStoryEpisode" min="1" value="1">
          </div>
        </div>
        <div class="checkbox-group">
          <input type="checkbox" id="newStoryIsPublic">
          <label for="newStoryIsPublic">–°–¥–µ–ª–∞—Ç—å –ø—É–±–ª–∏—á–Ω–æ–π —Å—Ä–∞–∑—É</label>
        </div>
        <div class="form-actions">
          <button type="button" class="btn btn-success" id="btnCreateStory">üöÄ –°–æ–∑–¥–∞—Ç—å –∏—Å—Ç–æ—Ä–∏—é</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    class AdminPanel {
      constructor() {
        this.stories = [];
        this.currentStory = null;
        this.characters = [];
        this.messages = [];
        this.currentEditingMessage = null;
        this.currentEditingCharacter = null;
        this.draggedMessage = null;
        
        this.adminPassword = "1111";
        this.currentFilter = 'all';
        
        this.init();
      }

      async init() {
        this.setupEventListeners();
        this.showLoginScreen();
        this.initDragAndDrop();
      }

      showLoginScreen() {
        document.getElementById('loginScreen').style.display = 'flex';
        document.getElementById('adminInterface').style.display = 'none';
      }

      showAdminInterface() {
        document.getElementById('loginScreen').style.display = 'none';
        document.getElementById('adminInterface').style.display = 'block';
        this.loadData();
      }

      setupEventListeners() {
        // –õ–æ–≥–∏–Ω
        document.getElementById('loginForm').addEventListener('submit', (e) => {
          e.preventDefault();
          this.handleLogin();
        });

        // –ù–∞–≤–∏–≥–∞—Ü–∏—è
        document.getElementById('btnBackToSite').addEventListener('click', () => {
          window.open('index.html', '_self');
        });

        document.getElementById('btnLogout').addEventListener('click', () => {
          this.showLoginScreen();
        });

        document.getElementById('btnRefresh').addEventListener('click', () => {
          this.loadData();
        });

        // –¢–∞–±—ã
        document.querySelectorAll('.tab').forEach(tab => {
          tab.addEventListener('click', (e) => {
            this.switchTab(e.target.dataset.tab);
          });
        });

        // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏—è–º–∏
        document.getElementById('btnCreateStory').addEventListener('click', () => {
          this.createNewStory();
        });
        // –ë—ã—Å—Ç—Ä–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–∏
        document.getElementById('btnQuickCreate')?.addEventListener('click', () => {
          this.quickCreateStory();
        });

        // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞–º–∏
        document.getElementById('btnAddCharacter').addEventListener('click', () => {
          this.showCharacterForm();
        });

        document.getElementById('btnSaveCharacter').addEventListener('click', () => {
          this.saveCharacter();
        });

        document.getElementById('btnCancelCharacter').addEventListener('click', () => {
          this.hideCharacterForm();
        });

        document.getElementById('btnDeleteCharacter').addEventListener('click', () => {
          this.deleteCharacter();
        });

        // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏
        document.getElementById('btnAddMessage').addEventListener('click', () => {
          this.showMessageForm();
        });

        document.getElementById('btnSaveMessage').addEventListener('click', () => {
          this.saveMessage();
        });

        document.getElementById('btnCancelMessage').addEventListener('click', () => {
          this.hideMessageForm();
        });

        document.getElementById('btnDeleteMessage').addEventListener('click', () => {
          this.deleteMessage();
        });

        // –ì—Ä–∞—Ñ–∏–∫ –ø—É–±–ª–∏–∫–∞—Ü–∏–π
        document.getElementById('btnClearSchedule').addEventListener('click', () => {
          this.clearSchedule();
        });
     
         // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –≤—ã–±–æ—Ä–∞ —Ü–≤–µ—Ç–∞
         document.addEventListener('click', (e) => {
         if (e.target.classList.contains('color-option')) {
         const color = e.target.dataset.color;
         this.selectColor(color);
  }
}); 
      }

      handleLogin() {
        const password = document.getElementById('adminPassword').value;
        if (password === this.adminPassword) {
          this.showAdminInterface();
        } else {
          alert('‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å');
        }
      }

      switchTab(tabName) {
        // –°–∫—Ä—ã—Ç—å –≤—Å–µ —Ç–∞–±—ã
        document.querySelectorAll('.tab-content').forEach(tab => {
          tab.classList.remove('active');
        });
        document.querySelectorAll('.tab').forEach(tab => {
          tab.classList.remove('active');
        });

        // –ü–æ–∫–∞–∑–∞—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–π —Ç–∞–±
        document.getElementById(tabName + 'Tab').classList.add('active');
        document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');

        if (tabName === 'schedule') {
          this.renderSchedule();
        }
      }

      async loadData() {
        try {
          console.log('üîÑ –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –∞–¥–º–∏–Ω–∫–∏...');
          const storiesSnapshot = await db.collection('stories').orderBy('createdAt', 'desc').get();
          this.stories = storiesSnapshot.docs.map(doc => ({
            id: doc.id,
            ...doc.data()
          }));
          
          console.log('‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–æ –∏—Å—Ç–æ—Ä–∏–π:', this.stories.length);
          this.renderStories();
          
        } catch (error) {
          console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏:', error);
          alert('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö');
        }
      }

      renderStories() {
        const container = document.getElementById('storiesList');
        if (!container) return;

        if (this.stories.length === 0) {
          container.innerHTML = `
            <div class="empty-state">
              <div class="icon">üìù</div>
              <h3>–ò—Å—Ç–æ—Ä–∏–π –ø–æ–∫–∞ –Ω–µ—Ç</h3>
              <p>–°–æ–∑–¥–∞–π—Ç–µ –ø–µ—Ä–≤—É—é –∏—Å—Ç–æ—Ä–∏—é —á–µ—Ä–µ–∑ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä</p>
            </div>
          `;
          return;
        }

        container.innerHTML = this.stories.map(story => {
          const isScheduled = story.publishDate && new Date(story.publishDate) > new Date() && !story.published;
          const isSoon = !story.published && !story.publishDate;
          const isPublished = story.published === true;
          const isHidden = story.isPublic === false;

          return `
            <div class="story-card ${isScheduled ? 'scheduled' : ''} ${isSoon ? 'soon' : ''}">
              <div class="story-header">
                <h3 class="story-title">${story.title || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è'}</h3>
                <div class="story-meta">
                  <span class="badge category">${this.getCategoryName(story.category, story.customCategory)}</span>
                  ${story.episode ? `<span class="badge episode">–≠–ø–∏–∑–æ–¥ ${story.episode}</span>` : ''}
                  <span class="badge status-${this.getStatusType(story)}">${this.getStatusText(story)}</span>
                  ${isHidden ? `<span class="badge status-hidden">üëª –°–∫—Ä—ã—Ç–æ</span>` : ''}
                </div>
              </div>
              <p class="story-desc">${story.description || '–û–ø–∏—Å–∞–Ω–∏–µ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç'}</p>
              ${story.publishDate ? `
                <div class="story-date">
                  üóìÔ∏è ${this.getStoryDate(story.publishDate).toLocaleString()}
                </div>
              ` : ''}
              <div class="story-actions">
                <button class="btn btn-secondary btn-small" onclick="adminPanel.editStory('${story.id}')">‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
                <button class="btn btn-danger btn-small" onclick="adminPanel.deleteStoryPrompt('${story.id}')">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å</button>
                ${!story.published && !story.publishDate ? 
                  `<button class="btn btn-small" onclick="adminPanel.publishNow('${story.id}')">üöÄ –û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å</button>` : ''}
                ${story.publishDate && new Date(story.publishDate) > new Date() ? 
                  `<button class="btn btn-warning btn-small" onclick="adminPanel.publishNow('${story.id}')">üöÄ –û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å —Å–µ–π—á–∞—Å</button>` : ''}
                ${isHidden ? 
                  `<button class="btn btn-success btn-small" onclick="adminPanel.toggleVisibility('${story.id}', true)">üëÅÔ∏è –ü–æ–∫–∞–∑–∞—Ç—å</button>` :
                  `<button class="btn btn-secondary btn-small" onclick="adminPanel.toggleVisibility('${story.id}', false)">üëª –°–∫—Ä—ã—Ç—å</button>`
                }
                <button class="btn btn-info btn-small" onclick="adminPanel.safeOpenConstructor('${story.id}')">üõ†Ô∏è –ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä</button>
              </div>
            </div>
          `;
        }).join('');
      }

      getCategoryName(category, customCategory) {
        const categories = {
          'fantasy': 'üßô –§—ç–Ω—Ç–µ–∑–∏',
          'sci-fi': 'üöÄ –ù–∞—É—á–Ω–∞—è —Ñ–∞–Ω—Ç–∞—Å—Ç–∏–∫–∞', 
          'horror': 'üëª –•–æ—Ä—Ä–æ—Ä',
          'adventure': 'üó∫Ô∏è –ü—Ä–∏–∫–ª—é—á–µ–Ω–∏—è',
          'mystery': 'üïµÔ∏è –ú–∏—Å—Ç–∏–∫–∞',
          'chat': 'üí¨ –ß–∞—Ç-–∏—Å—Ç–æ—Ä–∏–∏'
        };
        return customCategory || categories[category] || category;
      }

      getStatusType(story) {
        if (story.published) return 'published';
        if (story.publishDate && new Date(story.publishDate) > new Date()) return 'scheduled';
        return 'soon';
      }

      getStatusText(story) {
        if (story.published) return '‚úÖ –û–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–æ';
        if (story.publishDate && new Date(story.publishDate) > new Date()) {
          const date = this.getStoryDate(story.publishDate);
          return `‚è∞ ${date.toLocaleDateString()}`;
        }
        return 'üïê –°–∫–æ—Ä–æ';
      }

      getStoryDate(date) {
        return date?.toDate ? date.toDate() : new Date(date);
      }

      // –£–ü–†–ê–í–õ–ï–ù–ò–ï –ò–°–¢–û–†–ò–Ø–ú–ò
      async createNewStory() {
        const title = document.getElementById('newStoryTitle').value;
        const description = document.getElementById('newStoryDescription').value;
        const category = document.getElementById('newStoryCategory').value;
        const episode = parseInt(document.getElementById('newStoryEpisode').value);
        const isPublic = document.getElementById('newStoryIsPublic').checked;

        if (!title.trim()) {
          alert('‚ùå –í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–∏');
          return;
        }

        try {
          const storyData = {
            title: title.trim(),
            description: description.trim(),
            category: category,
            episode: episode,
            isPublic: isPublic,
            published: isPublic,
            createdAt: new Date(),
            updatedAt: new Date()
          };

          const docRef = await db.collection('stories').add(storyData);
          console.log('‚úÖ –ò—Å—Ç–æ—Ä–∏—è —Å–æ–∑–¥–∞–Ω–∞:', docRef.id);
          
          // –û—á–∏—â–∞–µ–º —Ñ–æ—Ä–º—É
          document.getElementById('newStoryTitle').value = '';
          document.getElementById('newStoryDescription').value = '';
          document.getElementById('newStoryEpisode').value = '1';
          document.getElementById('newStoryIsPublic').checked = false;
          
          // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ
          await this.loadData();
          
          // –ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä—É –Ω–æ–≤–æ–π –∏—Å—Ç–æ—Ä–∏–∏
          this.openConstructor(docRef.id);
          
          alert('‚úÖ –ò—Å—Ç–æ—Ä–∏—è —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω–∞!');
          
        } catch (error) {
          console.error('‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∏—Å—Ç–æ—Ä–∏–∏:', error);
          alert('‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∏—Å—Ç–æ—Ä–∏–∏');
        }
      }

      async quickCreateStory() {
        if (!confirm('–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é –∏—Å—Ç–æ—Ä–∏—é —Å –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–º–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏?')) return;

        try {
          const now = new Date();
          const storyData = {
            title: '–ù–æ–≤–∞—è –∏—Å—Ç–æ—Ä–∏—è (–±—ã—Å—Ç—Ä–æ)',
            description: '',
            category: 'chat',
            episode: 1,
            isPublic: false,
            published: false,
            createdAt: now,
            updatedAt: now
          };

          const docRef = await db.collection('stories').add(storyData);
          console.log('‚úÖ –ë—ã—Å—Ç—Ä–∞—è –∏—Å—Ç–æ—Ä–∏—è —Å–æ–∑–¥–∞–Ω–∞:', docRef.id);

          // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏–º —Å–ø–∏—Å–æ–∫ –∏ –æ—Ç–∫—Ä–æ–µ–º –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä
          await this.loadData();
          this.openConstructor(docRef.id);
          alert('‚úÖ –ë—ã—Å—Ç—Ä–∞—è –∏—Å—Ç–æ—Ä–∏—è —Å–æ–∑–¥–∞–Ω–∞ –∏ –æ—Ç–∫—Ä—ã—Ç–∞ –≤ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä–µ');

        } catch (error) {
          console.error('‚ùå –û—à–∏–±–∫–∞ –±—ã—Å—Ç—Ä–æ–π –ø—É–±–ª–∏–∫–∞—Ü–∏–∏:', error);
          alert('‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∏—Å—Ç–æ—Ä–∏–∏');
        }
      }

      editStory(storyId) {
        const story = this.stories.find(s => s.id === storyId);
        if (story) {
          // –ü–µ—Ä–µ—Ö–æ–¥–∏–º –≤ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
          this.openConstructor(storyId);
        }
      }

      deleteStoryPrompt(storyId) {
        const story = this.stories.find(s => s.id === storyId);
        if (!story) return;

        if (confirm(`–£–¥–∞–ª–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é "${story.title}"? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.`)) {
          this.deleteStory(storyId);
        }
      }

      async deleteStory(storyId) {
        try {
          await db.collection('stories').doc(storyId).delete();
          await this.loadData();
          alert('üóëÔ∏è –ò—Å—Ç–æ—Ä–∏—è —É–¥–∞–ª–µ–Ω–∞');
        } catch (error) {
          console.error('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è:', error);
          alert('‚ùå –û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –∏—Å—Ç–æ—Ä–∏–∏');
        }
      }

      async publishNow(storyId) {
        try {
          await db.collection('stories').doc(storyId).update({
            published: true,
            publishDate: null,
            updatedAt: new Date()
          });
          await this.loadData();
          alert('‚úÖ –ò—Å—Ç–æ—Ä–∏—è –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–∞!');
        } catch (error) {
          alert('‚ùå –û—à–∏–±–∫–∞ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏');
        }
      }

      async toggleVisibility(storyId, isPublic) {
        try {
          await db.collection('stories').doc(storyId).update({
            isPublic: isPublic,
            updatedAt: new Date()
          });
          await this.loadData();
          alert(`‚úÖ –ò—Å—Ç–æ—Ä–∏—è ${isPublic ? '–æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–∞' : '—Å–∫—Ä—ã—Ç–∞'}!`);
        } catch (error) {
          alert('‚ùå –û—à–∏–±–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤–∏–¥–∏–º–æ—Å—Ç–∏');
        }
      }

      // –ö–û–ù–°–¢–†–£–ö–¢–û–† –ò–°–¢–û–†–ò–ô
      openConstructor(storyId) {
        this.currentStory = this.stories.find(s => s.id === storyId);
        if (this.currentStory) {
          this.switchTab('constructor');
          this.loadConstructorData(storyId);
        }
      }

     // –î–æ–±–∞–≤–ª—è–µ–º –º–µ—Ç–æ–¥ –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ –ø–µ—Ä–µ—Ö–æ–¥–∞ –≤ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä
       safeOpenConstructor(storyId) {
        if (!storyId) {
         alert('‚ùå ID –∏—Å—Ç–æ—Ä–∏–∏ –Ω–µ —É–∫–∞–∑–∞–Ω');
         return;
           }
         this.openConstructor(storyId);
         }
      
      async loadConstructorData(storyId) {
        if (!storyId) return;

        try {
          console.log('üîÑ –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä–∞...');

          // –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π
          const charactersSnapshot = await db.collection('story_characters')
            .where('storyId', '==', storyId)
            .get();
          this.characters = charactersSnapshot.docs.map(doc => ({
            id: doc.id,
            ...doc.data()
          }));

          // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è
          const messagesSnapshot = await db.collection('chat_messages')
            .where('storyId', '==', storyId)
            .orderBy('order')
            .get();
          this.messages = messagesSnapshot.docs.map(doc => ({
            id: doc.id,
            ...doc.data()
          }));

          console.log('‚úÖ –ü–µ—Ä—Å–æ–Ω–∞–∂–µ–π:', this.characters.length);
          console.log('‚úÖ –°–æ–æ–±—â–µ–Ω–∏–π:', this.messages.length);

          this.renderCharacters();
          this.renderMessages();
          this.updatePreview();

        } catch (error) {
          console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä–∞:', error);
          alert('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä–∞');
        }
      }

      renderCharacters() {
        const container = document.getElementById('characterList');
        const select = document.getElementById('messageCharacter');
        
        if (!container) return;

        container.innerHTML = '';
        if (select) select.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞</option>';

        this.characters.forEach(character => {
          // –°–ø–∏—Å–æ–∫ –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π
          if (container) {
            const characterElement = document.createElement('div');
            characterElement.className = 'character-item';
            characterElement.innerHTML = `
              <div class="character-header">
                <div class="character-avatar" style="background: ${character.color || '#6366f1'}">
                  ${character.name.charAt(0).toUpperCase()}
                </div>
                <div>
                  <div class="character-name">${character.name}</div>
                  <div class="character-role">${character.bio || '–ü–µ—Ä—Å–æ–Ω–∞–∂'}</div>
                </div>
              </div>
            `;
            characterElement.addEventListener('click', () => {
              this.editCharacter(character.id);
            });
            container.appendChild(characterElement);
          }

          // –û–ø—Ü–∏–∏ –¥–ª—è –≤—ã–±–æ—Ä–∞ –≤ —Ñ–æ—Ä–º–µ —Å–æ–æ–±—â–µ–Ω–∏—è
          if (select) {
            const option = document.createElement('option');
            option.value = character.id;
            option.textContent = character.name;
            select.appendChild(option);
          }
        });

        // –ï—Å–ª–∏ –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π –Ω–µ—Ç, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
        if (this.characters.length === 0 && container) {
          container.innerHTML = `
            <div class="empty-state">
              <div class="icon">üë•</div>
              <p>–ù–µ—Ç –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π</p>
              <p>–î–æ–±–∞–≤—å—Ç–µ –ø–µ—Ä–≤–æ–≥–æ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞</p>
            </div>
          `;
        }
      }

      renderMessages() {
        const container = document.getElementById('messageList');
        if (!container) return;

        container.innerHTML = '';

        this.messages.forEach(message => {
          const messageElement = document.createElement('div');
          messageElement.className = 'message-editor-item';
          messageElement.draggable = true;
          messageElement.dataset.messageId = message.id;

          const character = this.characters.find(c => c.id === message.characterId);
          const characterName = character ? character.name : '–°–∏—Å—Ç–µ–º–∞';

          messageElement.innerHTML = `
            <div class="message-header">
              <span class="message-type-badge badge-${message.type || 'text'}">
                ${this.getMessageTypeIcon(message.type)} ${this.getMessageTypeText(message.type)}
              </span>
              <div class="message-actions">
                <button class="btn btn-small btn-secondary" onclick="adminPanel.editMessage('${message.id}')">‚úèÔ∏è</button>
                <button class="btn btn-small btn-danger" onclick="adminPanel.deleteMessagePrompt('${message.id}')">üóëÔ∏è</button>
              </div>
            </div>
            <div class="message-content-preview">
              ${characterName}: ${message.content || ''}
            </div>
            <div class="message-meta">
              <span>–ü–æ—Ä—è–¥–æ–∫: ${message.order || 1}</span>
              <span>–ó–∞–¥–µ—Ä–∂–∫–∞: ${message.delay || 2000}–º—Å</span>
            </div>
          `;

          // Drag & Drop —Å–æ–±—ã—Ç–∏—è
          messageElement.addEventListener('dragstart', (e) => {
            this.draggedMessage = message;
            e.target.classList.add('dragging');
          });

          messageElement.addEventListener('dragend', (e) => {
            e.target.classList.remove('dragging');
          });

          container.appendChild(messageElement);
        });

        // –ï—Å–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–π –Ω–µ—Ç, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
        if (this.messages.length === 0) {
          container.innerHTML = `
            <div class="empty-state">
              <div class="icon">üí≠</div>
              <p>–ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π</p>
              <p>–î–æ–±–∞–≤—å—Ç–µ –ø–µ—Ä–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ</p>
            </div>
          `;
        }
      }

      getMessageTypeIcon(type) {
        const icons = {
          'text': 'üí¨',
          'thought': 'ü§î', 
          'system': '‚öôÔ∏è'
        };
        return icons[type] || 'üí¨';
      }

      getMessageTypeText(type) {
        const texts = {
          'text': '–¢–µ–∫—Å—Ç',
          'thought': '–ú—ã—Å–ª—å',
          'system': '–°–∏—Å—Ç–µ–º–Ω–æ–µ'
        };
        return texts[type] || '–¢–µ–∫—Å—Ç';
      }

      updatePreview() {
        const container = document.getElementById('previewMessages');
        if (!container) return;

        container.innerHTML = '';

        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–µ—Ä–≤—ã–µ 5 —Å–æ–æ–±—â–µ–Ω–∏–π –¥–ª—è –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞
        const previewMessages = this.messages.slice(0, 5);
        
        if (previewMessages.length === 0) {
          container.innerHTML = `
            <div class="message-preview system">
              <div class="message-bubble-preview">–î–æ–±–∞–≤—å—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞</div>
            </div>
          `;
          return;
        }

        previewMessages.forEach(message => {
          const messageElement = document.createElement('div');
          let messageClass = 'message-preview other';
          let bubbleClass = 'message-bubble-preview';

          if (message.type === 'system') {
            messageClass = 'message-preview system';
          } else if (message.type === 'thought') {
            messageClass = 'message-preview thought';
          }

          const character = this.characters.find(c => c.id === message.characterId);
          const characterName = character ? character.name : '–°–∏—Å—Ç–µ–º–∞';

          messageElement.className = messageClass;
          messageElement.innerHTML = `
            <div class="${bubbleClass}">
              ${message.content || '–ü—É—Å—Ç–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ'}
            </div>
          `;

          container.appendChild(messageElement);
        });
      }

      // –£–ü–†–ê–í–õ–ï–ù–ò–ï –ü–ï–†–°–û–ù–ê–ñ–ê–ú–ò
        showCharacterForm(characterId = null) {
  this.currentEditingCharacter = characterId;
  const form = document.getElementById('characterForm');
  form.style.display = 'block';

  if (characterId) {
    const character = this.characters.find(c => c.id === characterId);
    if (character) {
      document.getElementById('characterName').value = character.name;
      document.getElementById('characterBio').value = character.bio || '';
      this.selectColor(character.color || '#6366f1');
    }
  } else {
    document.getElementById('characterName').value = '';
    document.getElementById('characterBio').value = '';
    this.selectColor('#6366f1');
  }
}
 
      hideCharacterForm() {
        document.getElementById('characterForm').style.display = 'none';
        this.currentEditingCharacter = null;
      }

       selectColor(color) {
  // –£–±–∏—Ä–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ —Å–æ –≤—Å–µ—Ö —Ü–≤–µ—Ç–æ–≤
  document.querySelectorAll('.color-option').forEach(option => {
    option.classList.remove('selected');
  });
  
  // –í—ã–¥–µ–ª—è–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–π —Ü–≤–µ—Ç
  const selectedOption = document.querySelector(`.color-option[data-color="${color}"]`);
  if (selectedOption) {
    selectedOption.classList.add('selected');
  }
  
  // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ –≤ —Å–∫—Ä—ã—Ç–æ–µ –ø–æ–ª–µ
  document.getElementById('characterColor').value = color;
}
      
      async saveCharacter() {
  const name = document.getElementById('characterName').value;
  const bio = document.getElementById('characterBio').value;
  const color = document.getElementById('characterColor').value;

  if (!name.trim()) {
    alert('‚ùå –í–≤–µ–¥–∏—Ç–µ –∏–º—è –ø–µ—Ä—Å–æ–Ω–∞–∂–∞');
    return;
  }

  // –ï–°–õ–ò –ò–°–¢–û–†–ò–ò –ï–©–Å –ù–ï–¢ - –°–û–ó–î–ê–Å–ú –ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–ò
  if (!this.currentStory) {
    const createStory = confirm('–°–Ω–∞—á–∞–ª–∞ –Ω—É–∂–Ω–æ —Å–æ–∑–¥–∞—Ç—å –∏—Å—Ç–æ—Ä–∏—é. –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é –∏—Å—Ç–æ—Ä–∏—é –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏?');
    if (!createStory) return;
    
    await this.quickCreateStory();
    // –ï—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –∏—Å—Ç–æ—Ä–∏—é, –≤—ã—Ö–æ–¥–∏–º
    if (!this.currentStory) return;
  }

  try {
    const characterData = {
      name: name.trim(),
      bio: bio.trim(),
      color: color,
      storyId: this.currentStory.id,
      createdAt: new Date(),
      updatedAt: new Date()
    };

    if (this.currentEditingCharacter) {
      // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞
      await db.collection('story_characters').doc(this.currentEditingCharacter).update(characterData);
      console.log('‚úÖ –ü–µ—Ä—Å–æ–Ω–∞–∂ –æ–±–Ω–æ–≤–ª–µ–Ω:', this.currentEditingCharacter);
    } else {
      // –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞
      const docRef = await db.collection('story_characters').add(characterData);
      console.log('‚úÖ –ü–µ—Ä—Å–æ–Ω–∞–∂ —Å–æ–∑–¥–∞–Ω:', docRef.id);
    }

    await this.loadConstructorData(this.currentStory.id);
    this.hideCharacterForm();
    alert('‚úÖ –ü–µ—Ä—Å–æ–Ω–∞–∂ —Å–æ—Ö—Ä–∞–Ω–µ–Ω!');

  } catch (error) {
    console.error('‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø–µ—Ä—Å–æ–Ω–∞–∂–∞:', error);
    alert('‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø–µ—Ä—Å–æ–Ω–∞–∂–∞');
  }
      }

      editCharacter(characterId) {
        this.showCharacterForm(characterId);
      }

      async deleteCharacter() {
        if (!this.currentEditingCharacter) return;

        if (!confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ–≥–æ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞? –í—Å–µ —Å–≤—è–∑–∞–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –±—É–¥—É—Ç –ø–æ—Ç–µ—Ä—è–Ω—ã.')) {
          return;
        }

        try {
          await db.collection('story_characters').doc(this.currentEditingCharacter).delete();
          await this.loadConstructorData(this.currentStory.id);
          this.hideCharacterForm();
          alert('‚úÖ –ü–µ—Ä—Å–æ–Ω–∞–∂ —É–¥–∞–ª–µ–Ω');
        } catch (error) {
          console.error('‚ùå –û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –ø–µ—Ä—Å–æ–Ω–∞–∂–∞:', error);
          alert('‚ùå –û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –ø–µ—Ä—Å–æ–Ω–∞–∂–∞');
        }
      }

      // –£–ü–†–ê–í–õ–ï–ù–ò–ï –°–û–û–ë–©–ï–ù–ò–Ø–ú–ò
      showMessageForm(messageId = null) {
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∏—Å—Ç–æ—Ä–∏—è –≤—ã–±—Ä–∞–Ω–∞
          if (!this.currentStory) {
          alert('‚ùå –°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –∏—Å—Ç–æ—Ä–∏—é –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è');
          return;
             }

          this.currentEditingMessage = messageId;
          const form = document.getElementById('messageForm');
          form.style.display = 'block';
          // ... –æ—Å—Ç–∞–ª—å–Ω–æ–π –∫–æ–¥ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π

        if (messageId) {
          const message = this.messages.find(m => m.id === messageId);
          if (message) {
            document.getElementById('messageType').value = message.type || 'text';
            document.getElementById('messageCharacter').value = message.characterId || '';
            document.getElementById('messageContent').value = message.content || '';
            document.getElementById('messageDelay').value = message.delay || 2000;
            document.getElementById('messageOrder').value = message.order || 1;
          }
        } else {
          document.getElementById('messageType').value = 'text';
          document.getElementById('messageCharacter').value = '';
          document.getElementById('messageContent').value = '';
          document.getElementById('messageDelay').value = 2000;
          document.getElementById('messageOrder').value = this.messages.length + 1;
        }
      }

      hideMessageForm() {
        document.getElementById('messageForm').style.display = 'none';
        this.currentEditingMessage = null;
      }

      async saveMessage() {
  const type = document.getElementById('messageType').value;
  const characterId = document.getElementById('messageCharacter').value;
  const content = document.getElementById('messageContent').value;
  const delay = parseInt(document.getElementById('messageDelay').value);
  const order = parseInt(document.getElementById('messageOrder').value);

  if (!content.trim()) {
    alert('‚ùå –í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è');
    return;
  }

  // –ï–°–õ–ò –ò–°–¢–û–†–ò–ò –ï–©–Å –ù–ï–¢ - –°–û–ó–î–ê–Å–ú –ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–ò
  if (!this.currentStory) {
    const createStory = confirm('–°–Ω–∞—á–∞–ª–∞ –Ω—É–∂–Ω–æ —Å–æ–∑–¥–∞—Ç—å –∏—Å—Ç–æ—Ä–∏—é. –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é –∏—Å—Ç–æ—Ä–∏—é –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏?');
    if (!createStory) return;
    
    await this.quickCreateStory();
    if (!this.currentStory) return;
  }

  try {
    const messageData = {
      type: type,
      characterId: characterId || null,
      content: content.trim(),
      delay: delay,
      order: order,
      storyId: this.currentStory.id,
      createdAt: new Date(),
      updatedAt: new Date()
    };

    if (this.currentEditingMessage) {
      // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
      await db.collection('chat_messages').doc(this.currentEditingMessage).update(messageData);
      console.log('‚úÖ –°–æ–æ–±—â–µ–Ω–∏–µ –æ–±–Ω–æ–≤–ª–µ–Ω–æ:', this.currentEditingMessage);
    } else {
      // –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
      const docRef = await db.collection('chat_messages').add(messageData);
      console.log('‚úÖ –°–æ–æ–±—â–µ–Ω–∏–µ —Å–æ–∑–¥–∞–Ω–æ:', docRef.id);
    }

    await this.loadConstructorData(this.currentStory.id);
    this.hideMessageForm();
    alert('‚úÖ –°–æ–æ–±—â–µ–Ω–∏–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ!');

  } catch (error) {
    console.error('‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏—è:', error);
    alert('‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏—è');
  }
      }

      editMessage(messageId) {
        this.showMessageForm(messageId);
      }

      deleteMessagePrompt(messageId) {
        if (confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ?')) {
          this.deleteMessage(messageId);
        }
      }

      async deleteMessage(messageId) {
        try {
          await db.collection('chat_messages').doc(messageId).delete();
          await this.loadConstructorData(this.currentStory.id);
          alert('‚úÖ –°–æ–æ–±—â–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–æ');
        } catch (error) {
          console.error('‚ùå –û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏—è:', error);
          alert('‚ùå –û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏—è');
        }
      }

      // DRAG & DROP
      initDragAndDrop() {
        const messageList = document.getElementById('messageList');
        if (!messageList) return;

        messageList.addEventListener('dragover', (e) => {
          e.preventDefault();
          const afterElement = this.getDragAfterElement(messageList, e.clientY);
          const draggable = document.querySelector('.dragging');
          if (draggable && afterElement) {
            messageList.insertBefore(draggable, afterElement);
          }
        });

        messageList.addEventListener('drop', async (e) => {
          e.preventDefault();
          if (this.draggedMessage) {
            // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ—Ä—è–¥–æ–∫ –≤—Å–µ—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
            const messageElements = messageList.querySelectorAll('.message-editor-item');
            for (let i = 0; i < messageElements.length; i++) {
              const messageId = messageElements[i].dataset.messageId;
              await db.collection('chat_messages').doc(messageId).update({
                order: i + 1,
                updatedAt: new Date()
              });
            }
            
            await this.loadConstructorData(this.currentStory.id);
            this.draggedMessage = null;
          }
        });
      }

      getDragAfterElement(container, y) {
        const draggableElements = [...container.querySelectorAll('.message-editor-item:not(.dragging)')];

        return draggableElements.reduce((closest, child) => {
          const box = child.getBoundingClientRect();
          const offset = y - box.top - box.height / 2;
          if (offset < 0 && offset > closest.offset) {
            return { offset: offset, element: child };
          } else {
            return closest;
          }
        }, { offset: Number.NEGATIVE_INFINITY }).element;
      }

      // –ì–†–ê–§–ò–ö –ü–£–ë–õ–ò–ö–ê–¶–ò–ô
      async renderSchedule() {
        const container = document.getElementById('scheduleList');
        if (!container) return;

        const scheduledStories = this.stories.filter(story => 
          story.publishDate && new Date(story.publishDate) > new Date()
        );

        if (scheduledStories.length === 0) {
          container.innerHTML = `
            <div class="empty-state">
              <div class="icon">üìÖ</div>
              <p>–ù–µ—Ç –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –ø—É–±–ª–∏–∫–∞—Ü–∏–π</p>
            </div>
          `;
          return;
        }

        container.innerHTML = scheduledStories.map(story => {
          const publishDate = this.getStoryDate(story.publishDate);
          const timeUntil = this.getTimeUntil(publishDate);

          return `
            <div class="timeline-item">
              <div class="timeline-info">
                <h4>${story.title}</h4>
                <p>${story.description || '–ë–µ–∑ –æ–ø–∏—Å–∞–Ω–∏—è'}</p>
              </div>
              <div class="timeline-date">
                <div class="publish-date">${publishDate.toLocaleString()}</div>
                <div class="publish-status">${timeUntil}</div>
              </div>
            </div>
          `;
        }).join('');
      }

      getTimeUntil(date) {
        const now = new Date();
        const diff = date.getTime() - now.getTime();
        const days = Math.floor(diff / (1000 * 60 * 60 * 24));
        const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));

        if (days > 0) {
          return `–ß–µ—Ä–µ–∑ ${days} –¥–Ω–µ–π ${hours} —á–∞—Å–æ–≤`;
        } else if (hours > 0) {
          return `–ß–µ—Ä–µ–∑ ${hours} —á–∞—Å–æ–≤`;
        } else {
          return '–°–∫–æ—Ä–æ';
        }
      }

      async clearSchedule() {
        if (!confirm('–û—á–∏—Å—Ç–∏—Ç—å –≤–µ—Å—å –≥—Ä–∞—Ñ–∏–∫ –ø—É–±–ª–∏–∫–∞—Ü–∏–π? –í—Å–µ –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∏—Å—Ç–æ—Ä–∏–∏ –±—É–¥—É—Ç —Å–Ω—è—Ç—ã —Å –ø—É–±–ª–∏–∫–∞—Ü–∏–∏.')) {
          return;
        }

        try {
          const batch = db.batch();
          const scheduledStories = this.stories.filter(story => 
            story.publishDate && new Date(story.publishDate) > new Date()
          );

          scheduledStories.forEach(story => {
            const storyRef = db.collection('stories').doc(story.id);
            batch.update(storyRef, {
              publishDate: null,
              published: false,
              updatedAt: new Date()
            });
          });

          await batch.commit();
          await this.loadData();
          this.renderSchedule();
          alert('‚úÖ –ì—Ä–∞—Ñ–∏–∫ –ø—É–±–ª–∏–∫–∞—Ü–∏–π –æ—á–∏—â–µ–Ω');
        } catch (error) {
          console.error('‚ùå –û—à–∏–±–∫–∞ –æ—á–∏—Å—Ç–∫–∏ –≥—Ä–∞—Ñ–∏–∫–∞:', error);
          alert('‚ùå –û—à–∏–±–∫–∞ –æ—á–∏—Å—Ç–∫–∏ –≥—Ä–∞—Ñ–∏–∫–∞ –ø—É–±–ª–∏–∫–∞—Ü–∏–π');
        }
      }
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏
    document.addEventListener('DOMContentLoaded', () => {
      window.adminPanel = new AdminPanel();
    });
  </script>
</body>
</html>
