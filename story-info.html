<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Информация об истории — CRAWL.STORIES</title>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-firestore-compat.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyANC4K0-xI-9SvrpoiOp4v-N2XLvCQCALg",
      authDomain: "crawl-stories.firebaseapp.com",
      projectId: "crawl-stories",
      storageBucket: "crawl-stories.firebasestorage.app",
      messagingSenderId: "886479757650",
      appId: "1:886479757650:web:194ad1dd2d02c959bdda8b",
      measurementId: "G-SGC2HF0455"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
  </script>

  <style>
    :root {
      --bg-primary: #020205;
      --bg-secondary: #0b0b0f;
      --text-primary: #ffffff;
      --text-secondary: #a7a7a7;
      --accent: #ffdd3c;
      --card: #111118;
    }

    * { box-sizing: border-box; }

    body {
      background: var(--bg-primary);
      color: var(--text-primary);
      margin: 0;
      font-family: "Inter", sans-serif;
    }

    header {
      height: 60px;
      background: rgba(0,0,0,0.7);
      backdrop-filter: blur(10px);
      display: flex;
      align-items: center;
      padding: 0 15px;
      border-bottom: 1px solid rgba(255,255,255,0.1);
      position: sticky;
      top: 0;
      z-index: 99;
    }

    .back-btn {
      font-size: 26px;
      cursor: pointer;
      margin-right: 15px;
    }

    .logo-text {
      font-size: 20px;
      font-weight: 800;
      color: var(--accent);
    }

    .container {
      max-width: 900px;
      margin: auto;
      padding: 20px;
    }

    .story-top {
      display: flex;
      gap: 20px;
      flex-wrap: wrap;
      align-items: flex-start;
    }

    .cover {
      width: 260px;
      border-radius: 16px;
      box-shadow: 0 8px 25px rgba(0,0,0,0.6);
    }

    .info {
      flex: 1;
      min-width: 250px;
    }

    .title {
      font-size: 32px;
      font-weight: 900;
      margin-bottom: 10px;
      color: var(--accent);
    }

    .status {
      margin: 10px 0 20px;
      padding: 10px 14px;
      background: var(--card);
      border-radius: 10px;
      font-size: 16px;
      color: var(--accent);
      font-weight: 600;
      border: 1px solid rgba(255,255,255,0.1);
    }

    .desc {
      margin: 25px 0;
      line-height: 1.7;
      color: var(--text-secondary);
      font-size: 16px;
    }

    h2.block-title {
      font-size: 22px;
      margin: 35px 0 15px;
      color: var(--accent);
    }

    /* Персонажи */
    .characters {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      gap: 15px;
    }

    .char-card {
      background: var(--card);
      padding: 12px;
      border-radius: 12px;
      text-align: center;
      border: 1px solid rgba(255,255,255,0.1);
    }

    .char-img {
      width: 100%;
      border-radius: 10px;
      margin-bottom: 8px;
    }

    .char-name {
      font-weight: 700;
    }

    .char-role {
      font-size: 13px;
      color: var(--text-secondary);
    }

    /* Эпизоды */
    .episodes-list {
      display: grid;
      gap: 14px;
    }

    .episode {
      background: var(--card);
      padding: 15px;
      border-radius: 12px;
      cursor: pointer;
      border: 1px solid rgba(255,255,255,0.08);
      position: relative;
      transition: 0.2s;
    }

    .episode:hover {
      background: #14141e;
      transform: translateX(4px);
    }

    .episode-title {
      font-size: 17px;
      font-weight: 600;
      margin-bottom: 4px;
    }

    .episode-date {
      font-size: 13px;
      color: var(--text-secondary);
    }

    .new-badge {
      position: absolute;
      top: 10px;
      right: 10px;
      background: #ff3c3c;
      padding: 3px 8px;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 700;
    }

    /* Мобильная адаптация */
    @media (max-width: 600px) {
      .story-top { flex-direction: column; }
      .cover { width: 100%; }
      .title { font-size: 26px; }
      .status { font-size: 14px; }
    }
  </style>
</head>

<body>

<header>
  <div class="back-btn" onclick="history.back()">←</div>
  <div class="logo-text">CRAWL.STORIES</div>
</header>

<div id="content" class="container">
  <div style="text-align:center;padding:100px 0;color:#777;">Загрузка...</div>
</div>

<script>
class StoryInfo {
  constructor() {
    const params = new URLSearchParams(location.search);
    this.storyId = params.get("id");
    if (!this.storyId) return this.error("История не найдена");
    this.load();
  }

  async load() {
    try {
      const doc = await db.collection("stories").doc(this.storyId).get();
      if (!doc.exists) return this.error("История не найдена");

      const story = doc.data();

      const epsSnap = await db.collection("episodes")
        .where("storyId", "==", this.storyId)
        .orderBy("episodeNumber")
        .get();

      const episodes = epsSnap.docs.map(d => ({ id: d.id, ...d.data() }));

      document.getElementById("content").innerHTML = this.render(story, episodes);
    } catch (e) {
      console.error(e);
      this.error("Ошибка загрузки");
    }
  }

  formatDate(ts) {
    if (!ts) return "";
    const d = ts.toDate();
    return d.toLocaleDateString("ru-RU", {
      day: "2-digit",
      month: "short",
      year: "numeric"
    });
  }

  getStatus(story, episodes) {
    const ann = story.announcementDate ? this.formatDate(story.announcementDate) : null;

    if (episodes.length === 0) {
      return ann ? `Анонс на ${ann}` : "Анонс";
    }

    const first = this.formatDate(episodes[0].publishDate);
    const last = this.formatDate(episodes[episodes.length - 1].publishDate);

    if (story.status === "finished") {
      return `Закончен с ${first} по ${last}`;
    }

    return `Выходит с ${first} по —`;
  }

  renderCharacters(chars = []) {
    if (!chars.length) return `<div style="color:#777;">Нет персонажей</div>`;

    return chars.map(c => `
      <div class="char-card">
        <img src="${c.avatar}" class="char-img" onerror="this.src='assets/images/default-avatar.png'">
        <div class="char-name">${c.name}</div>
        <div class="char-role">${c.role}</div>
      </div>
    `).join("");
  }

  renderEpisodes(episodes) {
    if (!episodes.length) return `<div style="color:#777;">Эпизодов пока нет</div>`;

    const lastId = episodes[episodes.length - 1].id;

    return episodes.map(ep => `
      <div class="episode" onclick="location.href='reader.html?episode=${ep.id}&story=${this.storyId}'">
        ${ep.id === lastId ? `<div class="new-badge">Новый</div>` : ""}
        <div class="episode-title">Эпизод ${ep.episodeNumber}: ${ep.title}</div>
        <div class="episode-date">${this.formatDate(ep.publishDate)}</div>
      </div>
    `).join("");
  }

  render(story, episodes) {
    const chars = story.characters || [];

    return `
      <div class="story-top">
        <img class="cover" src="${story.cover}" onerror="this.src='assets/images/default-cover.jpg'">

        <div class="info">
          <div class="title">${story.title}</div>

          <div class="status">${this.getStatus(story, episodes)}</div>

          <p class="desc">${story.description || "Описание отсутствует"}</p>
        </div>
      </div>

      <h2 class="block-title">Персонажи</h2>
      <div class="characters">${this.renderCharacters(chars)}</div>

      <h2 class="block-title">Эпизоды</h2>
      <div class="episodes-list">${this.renderEpisodes(episodes)}</div>
    `;
  }

  error(msg) {
    document.getElementById("content").innerHTML =
      `<div style="text-align:center;padding:100px;color:#f55;">${msg}</div>`;
  }
}

new StoryInfo();
</script>

</body>
</html>
