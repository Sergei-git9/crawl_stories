<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∏—Å—Ç–æ—Ä–∏–∏ ‚Äî CRAWL.STORIES</title>
  
  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-firestore-compat.js"></script>
  
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyANC4K0-xI-9SvrpoiOp4v-N2XLvCQCALg",
      authDomain: "crawl-stories.firebaseapp.com",
      projectId: "crawl-stories",
      storageBucket: "crawl-stories.firebasestorage.app",
      messagingSenderId: "886479757650",
      appId: "1:886479757650:web:194ad1dd2d02c959bdda8b",
      measurementId: "G-SGC2HF0455"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
  </script>

  <style>
    :root {
      --bg-primary: #020205;
      --bg-secondary: #0b0b0f;
      --text-primary: #ffffff;
      --text-secondary: #9aa0a6;
      --accent-primary: #FFE81F;
      --border-light: rgba(255,255,255,0.1);
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { background: var(--bg-primary); color: var(--text-primary); font-family: "Courier New", monospace; min-height: 100vh; }
    
    /* –®–ê–ü–ö–ê */
    header {
      height: 70px; background: rgba(2,2,5,0.95); backdrop-filter: blur(10px);
      border-bottom: 1px solid var(--border-light); position: sticky; top: 0; z-index: 100;
      display: flex; align-items: center; justify-content: space-between; padding: 0 20px;
    }
    .logo { display: flex; align-items: center; gap: 12px; cursor: pointer; }
    .logo-box { width: 48px; height: 48px; background: #1a1a1a; border: 2px solid #333; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-weight: 900; font-size: 22px; }
    .logo-text { font-size: 24px; font-weight: 900; color: var(--accent-primary); }
    .back-btn { font-size: 28px; cursor: pointer; color: #fff; }

    /* –ö–û–ù–¢–ï–ù–¢ */
    .container { max-width: 900px; margin: 0 auto; padding: 20px; }
    .cover { width: 100%; max-width: 600px; border-radius: 16px; margin: 30px auto; display: block; box-shadow: 0 10px 40px rgba(0,0,0,0.8); }
    .title { font-size: 36px; color: var(--accent-primary); text-align: center; margin: 20px 0; font-weight: 900; }
    .desc { font-size: 17px; line-height: 1.7; color: #ccc; text-align: center; margin: 30px 0; max-width: 800px; margin-left: auto; margin-right: auto; }
    .meta { display: flex; justify-content: center; gap: 30px; flex-wrap: wrap; margin: 30px 0; }
    .stat { text-align: center; }
    .stat-label { font-size: 13px; color: var(--text-secondary); }
    .stat-value { font-size: 20px; font-weight: bold; color: var(--accent-primary); }
    .read-btn { display: block; width: 340px; margin: 40px auto; padding: 18px; background: var(--accent-primary); color: #000; text-align: center; font-weight: bold; border-radius: 16px; font-size: 22px; text-decoration: none; transition: 0.3s; }
    .read-btn:hover { background: #fff; transform: scale(1.05); }

    .episodes-section h2 { color: var(--accent-primary); text-align: center; margin: 50px 0 20px; font-size: 28px; }
    .episodes-list { display: grid; gap: 12px; }
    .episode-item { background: var(--bg-secondary); padding: 18px; border-radius: 12px; cursor: pointer; transition: 0.2s; }
    .episode-item:hover { background: #111; transform: translateX(8px); }
    .episode-number { font-weight: bold; font-size: 16px; }
    .episode-title { margin: 6px 0; font-size: 18px; }
    .episode-date { font-size: 13px; color: var(--text-secondary); }
  </style>
</head>
<body>

  <!-- –®–ê–ü–ö–ê -->
  <header>
    <div class="back-btn" onclick="history.back()">‚Üê</div>
    <div class="logo" onclick="location.href='index.html'">
      <div class="logo-box">C</div>
      <div class="logo-text">CRAWL.STORIES</div>
    </div>
    <div></div>
  </header>

  <div class="container" id="content">
    <div style="text-align:center;padding:100px;color:#999">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
  </div>

  <script>
    class StoryInfo {
      constructor() {
        this.urlParams = new URLSearchParams(location.search);
        this.storyId = this.urlParams.get('id');
        if (!this.storyId) {
          this.showError("–ò—Å—Ç–æ—Ä–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞");
          return;
        }
        this.loadStory();
      }

      async loadStory() {
        try {
          const storyDoc = await db.collection("stories").doc(this.storyId).get();
          if (!storyDoc.exists) throw new Error("–ò—Å—Ç–æ—Ä–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞");
          const story = storyDoc.data();

          const episodesSnap = await db.collection("episodes")
            .where("storyId", "==", this.storyId)
            .orderBy("episodeNumber")
            .get();
          const episodes = episodesSnap.docs.map(doc => ({id: doc.id, ...doc.data()}));

          document.getElementById('content').innerHTML = this.render(story, episodes);
        } catch (err) {
          console.error(err);
          this.showError("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏");
        }
      }

      render(story, episodes) {
        const statusText = story.status === "announced" ? "–ù–æ–≤–∏–Ω–∫–∞" :
                          story.status === "finished" ? "–ó–∞–∫–æ–Ω—á–µ–Ω–∞" : "–í –ø—Ä–æ—Ü–µ—Å—Å–µ";

        return `
          <img src="${story.cover || 'https://via.placeholder.com/600x800/111/333?text=CRAWL'}" class="cover" alt="${story.title}">
          <h1 class="title">${story.title || "–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è"}</h1>
          <p class="desc">${story.description || "–û–ø–∏—Å–∞–Ω–∏–µ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç"}</p>

          <div class="meta">
            <div class="stat">
              <div class="stat-label">–°–¢–ê–¢–£–°</div>
              <div class="stat-value">${statusText}</div>
            </div>
            <div class="stat">
              <div class="stat-label">–≠–ü–ò–ó–û–î–û–í</div>
              <div class="stat-value">${episodes.length}/${story.plannedEpisodes || '?'}</div>
            </div>
          </div>

          ${episodes.length > 0 ? `
            <a href="reader.html?episode=${episodes[0].id}&story=${this.storyId}" class="read-btn">–ù–∞—á–∞—Ç—å —á–∏—Ç–∞—Ç—å ‚Üí</a>
          ` : ''}

          <div class="episodes-section">
            <h2>–≠–ø–∏–∑–æ–¥—ã</h2>
            <div class="episodes-list">
              ${episodes.map(ep => `
                <div class="episode-item" onclick="location.href='reader.html?episode=${ep.id}&story=${this.storyId}'">
                  <div class="episode-number">–≠–ø–∏–∑–æ–¥ ${ep.episodeNumber || '‚Äî'}</div>
                  <div class="episode-title">${ep.title || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è'}</div>
                  ${ep.publishDate ? `<div class="episode-date">üìÖ ${new Date(ep.publishDate.toDate ? ep.publishDate.toDate() : ep.publishDate).toLocaleDateString('ru-RU')}</div>` : ''}
                </div>
              `).join('')}
            </div>
          </div>
        `;
      }

      showError(message) {
        document.getElementById('content').innerHTML = `<h1 style="text-align:center;color:#e91e63;padding:100px">${message}</h1>`;
      }
    }

    document.addEventListener('DOMContentLoaded', () => {
      new StoryInfo();
    });
  </script>

  <script src="themes-system.js"></script>
</body>
</html>
